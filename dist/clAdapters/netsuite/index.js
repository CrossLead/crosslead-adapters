'use strict';

var _Promise = require('babel-runtime/core-js/promise')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _util = require('util');

var _util2 = _interopRequireDefault(_util);

var _baseAdapter = require('../base/Adapter');

var _baseAdapter2 = _interopRequireDefault(_baseAdapter);

var _fields = require('../fields');

var _fields2 = _interopRequireDefault(_fields);

var _netsuiteJs = require('netsuite-js');

var _netsuiteJs2 = _interopRequireDefault(_netsuiteJs);

var implementedFields = {};
implementedFields[_fields2['default'].Types.USER] = {
  'department#internalId': true,
  'supervisor#internalId': true
};
implementedFields[_fields2['default'].Types.EXT_ENTITY] = {
  'customer#balance': true,
  'customer#overdueBalance': true,
  'customer#daysOverdue': true
};

/**
 * NetSuiteAdapter
 *
 * `credentials` format:
 * ```
 * {
 *   email: 'test@test.com',
 *   password: 'password',
 *   account: 123456,
 *   role: 3
 * }
 * ```
 * @class
 * @return {NetSuiteAdapter}
 */
var NetSuiteAdapter = module.exports = function NetSuiteAdapter() {
  _baseAdapter2['default'].call(this);

  /**
   * @override
   */
  Object.defineProperty(this, 'extEntityKey', {
    get: function get() {
      return this.credentials.account;
    }
  });

  // SearchId cache, one per field
  this._searchIds = {};

  // Cache results by field type -> limit (pagesize) -> skip, e.g.:
  // this._cachedDataByFieldType[Fields.Types.USER][10][3]
  // represents all user records for search page size 10 starting at index 3.
  // EXT_ENTITY fields are have an additional layer for entityType, e.g.:
  // this._cachedDataByFieldType[Fields.Types.EXT_ENTITY]['customer'][10][3]
  this._cachedDataByFieldType = {};
};

_util2['default'].inherits(NetSuiteAdapter, _baseAdapter2['default']);

/**
 * @override
 */
NetSuiteAdapter.prototype.init = function () {
  var _this = this;
  this._config = new _netsuiteJs2['default'].Configuration(this.credentials);
  this._service = new _netsuiteJs2['default'].Service(this._config);
  return this._service.init().then(function () /*client*/{
    var msg = 'Successfully initialized NetSuiteAdapter for email: %s, account: %s, role: %d';
    console.log(msg, _this.credentials.email, _this.credentials.account, _this.credentials.role);
    return _this;
  });
};

/**
 * @override
 */
NetSuiteAdapter.prototype.reset = function () {
  this._searchIds = {};
  this._cachedDataByFieldType = {};
  delete this._config;
  delete this._service;
};

NetSuiteAdapter.prototype._setCacheValue = function (field, limit, skip, data) {
  var fieldCache = this._cachedDataByFieldType[field.type] = this._cachedDataByFieldType[field.type] || {};

  if (field.type === _fields2['default'].Types.EXT_ENTITY) {
    fieldCache = this._cachedDataByFieldType[field.type][field.entityType] = this._cachedDataByFieldType[field.type][field.entityType] || {};
  }

  fieldCache[limit] = fieldCache[limit] || {};
  fieldCache[limit][skip] = _lodash2['default'].cloneDeep(data);
};

NetSuiteAdapter.prototype._getCacheValue = function (field, limit, skip) {
  var fieldCache = this._cachedDataByFieldType[field.type];
  if (!fieldCache) {
    return undefined;
  }

  if (field.type === _fields2['default'].Types.EXT_ENTITY) {
    fieldCache = fieldCache[field.entityType];
  }
  return fieldCache && fieldCache[limit] && fieldCache[limit][skip];
};

/**
 * @override
 */
NetSuiteAdapter.prototype.getFieldData = function (field, query) {
  console.log(field);
  var _this = this;
  return new _Promise(function (resolve, reject) {
    query = query || {};

    var preferences = new _netsuiteJs2['default'].Search.SearchPreferences();
    preferences.pageSize = query.limit || 10;
    _this._service.setSearchPreferences(preferences);

    if (!implementedFields[field.type] || !implementedFields[field.type][field.extId]) {
      return reject(new Error('Unknown field or retrieval NYI by NetSuiteAdapter:', field));
    }

    // Cache hit?
    var cached = _this._getCacheValue(field, preferences.pageSize, query.skip);
    if (cached) {
      return resolve(cached);
    }

    var pageIndex, search;
    if (field.type === _fields2['default'].Types.USER) {
      if (query.skip) {
        if (!_this._searchIds[field.extId]) {
          throw new Error('NetSuite paged searches must start with an initial search to generate a search session');
        }
        // Round down then add 1 since netsuite page indices are one-based
        pageIndex = Math.floor(query.skip / preferences.pageSize) + 1;
        console.log('searchMoreWithId with pageIndex "%d"', pageIndex);
        return _this._service.searchMoreWithId(_this._searchIds[field.extId], pageIndex).then(function (result) {
          var data = {
            count: result.searchResult.totalRecords,
            results: result.searchResult.recordList.record
          };
          _this._setCacheValue(field, preferences.pageSize, query.skip, data);
          return resolve(data);
        });
      } else {
        // No criteria right now
        search = new _netsuiteJs2['default'].Search.EmployeeSearchBasic();
        return _this._service.search(search).then(function (result) {
          if (result.searchResult.totalPages > 1) {
            _this._searchIds[field.extId] = result.searchResult.searchId;
          }

          var data = {
            count: result.searchResult.totalRecords,
            results: result.searchResult.recordList.record
          };
          _this._setCacheValue(field, preferences.pageSize, query.skip, data);
          return resolve(data);
        });
      }
    } else if (field.type === _fields2['default'].Types.EXT_ENTITY) {
      if (field.entityType === 'customer') {
        if (query.skip) {
          if (!_this._searchIds[field.extId]) {
            throw new Error('NetSuite paged searches must start with an initial search to generate a search session');
          }
          // Round down then add 1 since netsuite page indices are one-based
          pageIndex = Math.floor(query.skip / preferences.pageSize) + 1;
          console.log('searchMoreWithId with pageIndex "%d"', pageIndex);
          return _this._service.searchMoreWithId(_this._searchIds[field.extId], pageIndex).then(function (result) {
            var data = {
              count: result.searchResult.totalRecords,
              results: result.searchResult.searchRowList.searchRow
            };
            _this._setCacheValue(field, preferences.pageSize, query.skip, data);
            return resolve(data);
          });
        } else {
          // No criteria right now
          search = new _netsuiteJs2['default'].Search.CustomerSearchAdvanced();
          search.columns = new _netsuiteJs2['default'].Search.CustomerSearchRow();
          search.columns.basic = new _netsuiteJs2['default'].Search.CustomerSearchRowBasic();

          // For now, always include all SearchColumn fields since storing an extra field
          // is far less costly than having to do another roundtrip to retrieve another field
          var entityIdField = new _netsuiteJs2['default'].Search.Fields.SearchColumnStringField();
          entityIdField.field = 'entityId';
          search.columns.basic.searchColumnFields.push(entityIdField);

          var internalIdField = new _netsuiteJs2['default'].Search.Fields.SearchColumnSelectField();
          internalIdField.field = 'internalId';
          search.columns.basic.searchColumnFields.push(internalIdField);

          var balanceField = new _netsuiteJs2['default'].Search.Fields.SearchColumnDoubleField();
          balanceField.field = 'balance';
          search.columns.basic.searchColumnFields.push(balanceField);

          var overdueBalanceField = new _netsuiteJs2['default'].Search.Fields.SearchColumnDoubleField();
          overdueBalanceField.field = 'overdueBalance';
          search.columns.basic.searchColumnFields.push(overdueBalanceField);

          var daysOverdueField = new _netsuiteJs2['default'].Search.Fields.SearchColumnLongField();
          daysOverdueField.field = 'daysOverdue';
          search.columns.basic.searchColumnFields.push(daysOverdueField);

          return _this._service.search(search).then(function (result) {
            if (result.searchResult.totalPages > 1) {
              _this._searchIds[field.extId] = result.searchResult.searchId;
            }

            var data = {
              count: result.searchResult.totalRecords,
              results: result.searchResult.searchRowList.searchRow
            };
            _this._setCacheValue(field, preferences.pageSize, query.skip, data);
            return resolve(data);
          });
        }
      } else {
        return reject(new Error('Unknown EXT_ENTITY entityType:', field.entityType));
      }
    }
  });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsQWRhcHRlcnMvbmV0c3VpdGUvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7Ozs7c0JBRUMsUUFBUTs7OztvQkFDTCxNQUFNOzs7OzJCQUNDLGlCQUFpQjs7OztzQkFDdEIsV0FBVzs7OzswQkFDVCxhQUFhOzs7O0FBRWxDLElBQUksaUJBQWlCLEdBQUcsRUFBRSxDQUFDO0FBQzNCLGlCQUFpQixDQUFDLG9CQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRztBQUNyQyx5QkFBdUIsRUFBRSxJQUFJO0FBQzdCLHlCQUF1QixFQUFFLElBQUk7Q0FDOUIsQ0FBQztBQUNGLGlCQUFpQixDQUFDLG9CQUFPLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRztBQUMzQyxvQkFBa0IsRUFBRSxJQUFJO0FBQ3hCLDJCQUF5QixFQUFFLElBQUk7QUFDL0Isd0JBQXNCLEVBQUUsSUFBSTtDQUM3QixDQUFDOzs7Ozs7Ozs7Ozs7Ozs7OztBQWlCRixJQUFJLGVBQWUsR0FBRyxNQUFNLENBQUMsT0FBTyxHQUFHLFNBQVMsZUFBZSxHQUFHO0FBQ2hFLDJCQUFZLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs7Ozs7QUFLdkIsUUFBTSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFO0FBQzFDLE9BQUcsRUFBRSxlQUFXO0FBQ2QsYUFBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztLQUNqQztHQUNGLENBQUMsQ0FBQzs7O0FBR0gsTUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7Ozs7Ozs7QUFPckIsTUFBSSxDQUFDLHNCQUFzQixHQUFHLEVBQUUsQ0FBQztDQUNsQyxDQUFDOztBQUVGLGtCQUFLLFFBQVEsQ0FBQyxlQUFlLDJCQUFjLENBQUM7Ozs7O0FBSzVDLGVBQWUsQ0FBQyxTQUFTLENBQUMsSUFBSSxHQUFHLFlBQVc7QUFDMUMsTUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLE1BQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSx3QkFBUyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQzVELE1BQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSx3QkFBUyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ25ELFNBQU8sSUFBSSxDQUFDLFFBQVEsQ0FDakIsSUFBSSxFQUFFLENBQ04sSUFBSSxDQUFDLHNCQUF1QjtBQUMzQixRQUFJLEdBQUcsR0FBRywrRUFBK0UsQ0FBQztBQUMxRixXQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzdGLFdBQU8sS0FBSyxDQUFDO0dBQ2QsQ0FBQyxDQUFDO0NBQ04sQ0FBQzs7Ozs7QUFLRixlQUFlLENBQUMsU0FBUyxDQUFDLEtBQUssR0FBRyxZQUFXO0FBQzNDLE1BQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO0FBQ3JCLE1BQUksQ0FBQyxzQkFBc0IsR0FBRyxFQUFFLENBQUM7QUFDakMsU0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0FBQ3BCLFNBQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztDQUN0QixDQUFDOztBQUVGLGVBQWUsQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLFVBQVMsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO0FBQzVFLE1BQUksVUFBVSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7O0FBRXpHLE1BQUksS0FBSyxDQUFDLElBQUksS0FBSyxvQkFBTyxLQUFLLENBQUMsVUFBVSxFQUFFO0FBQzFDLGNBQVUsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7R0FDMUk7O0FBRUQsWUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDNUMsWUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLG9CQUFFLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztDQUM3QyxDQUFDOztBQUVGLGVBQWUsQ0FBQyxTQUFTLENBQUMsY0FBYyxHQUFHLFVBQVMsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUU7QUFDdEUsTUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN6RCxNQUFJLENBQUMsVUFBVSxFQUFFO0FBQ2YsV0FBTyxTQUFTLENBQUM7R0FDbEI7O0FBRUQsTUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLG9CQUFPLEtBQUssQ0FBQyxVQUFVLEVBQUU7QUFDMUMsY0FBVSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7R0FDM0M7QUFDRCxTQUFPLFVBQVUsSUFDZixVQUFVLENBQUMsS0FBSyxDQUFDLElBQ2pCLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztDQUMzQixDQUFDOzs7OztBQUtGLGVBQWUsQ0FBQyxTQUFTLENBQUMsWUFBWSxHQUFHLFVBQVMsS0FBSyxFQUFFLEtBQUssRUFBRTtBQUM5RCxTQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ25CLE1BQUksS0FBSyxHQUFHLElBQUksQ0FBQztBQUNqQixTQUFPLGFBQVksVUFBUyxPQUFPLEVBQUUsTUFBTSxFQUFFO0FBQzNDLFNBQUssR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDOztBQUVwQixRQUFJLFdBQVcsR0FBRyxJQUFJLHdCQUFTLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0FBQzFELGVBQVcsQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUM7QUFDekMsU0FBSyxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQyxXQUFXLENBQUMsQ0FBQzs7QUFFakQsUUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7QUFDakYsYUFBTyxNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsb0RBQW9ELEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztLQUN2Rjs7O0FBR0QsUUFBSSxNQUFNLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDM0UsUUFBSSxNQUFNLEVBQUU7QUFDVixhQUFPLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztLQUN4Qjs7QUFFRCxRQUFJLFNBQVMsRUFBRSxNQUFNLENBQUM7QUFDdEIsUUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLG9CQUFPLEtBQUssQ0FBQyxJQUFJLEVBQUU7QUFDcEMsVUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFO0FBQ2QsWUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFO0FBQ2xDLGdCQUFNLElBQUksS0FBSyxDQUFDLHdGQUF3RixDQUFDLENBQUM7U0FDM0c7O0FBRUQsaUJBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUM5RCxlQUFPLENBQUMsR0FBRyxDQUFDLHNDQUFzQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQy9ELGVBQU8sS0FBSyxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FDN0UsSUFBSSxDQUFDLFVBQVMsTUFBTSxFQUFFO0FBQ3JCLGNBQUksSUFBSSxHQUFHO0FBQ1QsaUJBQUssRUFBRSxNQUFNLENBQUMsWUFBWSxDQUFDLFlBQVk7QUFDdkMsbUJBQU8sRUFBRSxNQUFNLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxNQUFNO1dBQy9DLENBQUM7QUFDRixlQUFLLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDcEUsaUJBQU8sT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3RCLENBQUMsQ0FBQztPQUNOLE1BQU07O0FBRUwsY0FBTSxHQUFHLElBQUksd0JBQVMsTUFBTSxDQUFDLG1CQUFtQixFQUFFLENBQUM7QUFDbkQsZUFBTyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FDakMsSUFBSSxDQUFDLFVBQVMsTUFBTSxFQUFFO0FBQ3JCLGNBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxFQUFFO0FBQ3RDLGlCQUFLLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQztXQUM5RDs7QUFFRCxjQUFJLElBQUksR0FBRztBQUNULGlCQUFLLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxZQUFZO0FBQ3ZDLG1CQUFPLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsTUFBTTtXQUMvQyxDQUFDO0FBQ0YsZUFBSyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ3BFLGlCQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN0QixDQUFDLENBQUM7T0FDTjtLQUNGLE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLG9CQUFPLEtBQUssQ0FBQyxVQUFVLEVBQUU7QUFDakQsVUFBSSxLQUFLLENBQUMsVUFBVSxLQUFLLFVBQVUsRUFBRTtBQUNuQyxZQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUU7QUFDZCxjQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7QUFDbEMsa0JBQU0sSUFBSSxLQUFLLENBQUMsd0ZBQXdGLENBQUMsQ0FBQztXQUMzRzs7QUFFRCxtQkFBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzlELGlCQUFPLENBQUMsR0FBRyxDQUFDLHNDQUFzQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQy9ELGlCQUFPLEtBQUssQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQzdFLElBQUksQ0FBQyxVQUFTLE1BQU0sRUFBRTtBQUNyQixnQkFBSSxJQUFJLEdBQUc7QUFDVCxtQkFBSyxFQUFFLE1BQU0sQ0FBQyxZQUFZLENBQUMsWUFBWTtBQUN2QyxxQkFBTyxFQUFFLE1BQU0sQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFNBQVM7YUFDckQsQ0FBQztBQUNGLGlCQUFLLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDcEUsbUJBQU8sT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1dBQ3RCLENBQUMsQ0FBQztTQUNOLE1BQU07O0FBRUwsZ0JBQU0sR0FBRyxJQUFJLHdCQUFTLE1BQU0sQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO0FBQ3RELGdCQUFNLENBQUMsT0FBTyxHQUFHLElBQUksd0JBQVMsTUFBTSxDQUFDLGlCQUFpQixFQUFFLENBQUM7QUFDekQsZ0JBQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxHQUFHLElBQUksd0JBQVMsTUFBTSxDQUFDLHNCQUFzQixFQUFFLENBQUM7Ozs7QUFJcEUsY0FBSSxhQUFhLEdBQUcsSUFBSSx3QkFBUyxNQUFNLENBQUMsTUFBTSxDQUFDLHVCQUF1QixFQUFFLENBQUM7QUFDekUsdUJBQWEsQ0FBQyxLQUFLLEdBQUcsVUFBVSxDQUFDO0FBQ2pDLGdCQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7O0FBRTVELGNBQUksZUFBZSxHQUFHLElBQUksd0JBQVMsTUFBTSxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO0FBQzNFLHlCQUFlLENBQUMsS0FBSyxHQUFHLFlBQVksQ0FBQztBQUNyQyxnQkFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDOztBQUU5RCxjQUFJLFlBQVksR0FBRyxJQUFJLHdCQUFTLE1BQU0sQ0FBQyxNQUFNLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztBQUN4RSxzQkFBWSxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUM7QUFDL0IsZ0JBQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQzs7QUFFM0QsY0FBSSxtQkFBbUIsR0FBRyxJQUFJLHdCQUFTLE1BQU0sQ0FBQyxNQUFNLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztBQUMvRSw2QkFBbUIsQ0FBQyxLQUFLLEdBQUcsZ0JBQWdCLENBQUM7QUFDN0MsZ0JBQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDOztBQUVsRSxjQUFJLGdCQUFnQixHQUFHLElBQUksd0JBQVMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO0FBQzFFLDBCQUFnQixDQUFDLEtBQUssR0FBRyxhQUFhLENBQUM7QUFDdkMsZ0JBQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDOztBQUUvRCxpQkFBTyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FDakMsSUFBSSxDQUFDLFVBQVMsTUFBTSxFQUFFO0FBQ3JCLGdCQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsVUFBVSxHQUFHLENBQUMsRUFBRTtBQUN0QyxtQkFBSyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUM7YUFDOUQ7O0FBRUQsZ0JBQUksSUFBSSxHQUFHO0FBQ1QsbUJBQUssRUFBRSxNQUFNLENBQUMsWUFBWSxDQUFDLFlBQVk7QUFDdkMscUJBQU8sRUFBRSxNQUFNLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxTQUFTO2FBQ3JELENBQUM7QUFDRixpQkFBSyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ3BFLG1CQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztXQUN0QixDQUFDLENBQUM7U0FDTjtPQUNGLE1BQU07QUFDTCxlQUFPLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztPQUM5RTtLQUNGO0dBQ0YsQ0FBQyxDQUFDO0NBQ0osQ0FBQyIsImZpbGUiOiJjbEFkYXB0ZXJzL25ldHN1aXRlL2luZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHV0aWwgZnJvbSAndXRpbCc7XG5pbXBvcnQgQmFzZUFkYXB0ZXIgZnJvbSAnLi4vYmFzZS9BZGFwdGVyJztcbmltcG9ydCBGaWVsZHMgZnJvbSAnLi4vZmllbGRzJztcbmltcG9ydCBOZXRTdWl0ZSBmcm9tICduZXRzdWl0ZS1qcyc7XG5cbnZhciBpbXBsZW1lbnRlZEZpZWxkcyA9IHt9O1xuaW1wbGVtZW50ZWRGaWVsZHNbRmllbGRzLlR5cGVzLlVTRVJdID0ge1xuICAnZGVwYXJ0bWVudCNpbnRlcm5hbElkJzogdHJ1ZSxcbiAgJ3N1cGVydmlzb3IjaW50ZXJuYWxJZCc6IHRydWVcbn07XG5pbXBsZW1lbnRlZEZpZWxkc1tGaWVsZHMuVHlwZXMuRVhUX0VOVElUWV0gPSB7XG4gICdjdXN0b21lciNiYWxhbmNlJzogdHJ1ZSxcbiAgJ2N1c3RvbWVyI292ZXJkdWVCYWxhbmNlJzogdHJ1ZSxcbiAgJ2N1c3RvbWVyI2RheXNPdmVyZHVlJzogdHJ1ZVxufTtcblxuLyoqXG4gKiBOZXRTdWl0ZUFkYXB0ZXJcbiAqXG4gKiBgY3JlZGVudGlhbHNgIGZvcm1hdDpcbiAqIGBgYFxuICoge1xuICogICBlbWFpbDogJ3Rlc3RAdGVzdC5jb20nLFxuICogICBwYXNzd29yZDogJ3Bhc3N3b3JkJyxcbiAqICAgYWNjb3VudDogMTIzNDU2LFxuICogICByb2xlOiAzXG4gKiB9XG4gKiBgYGBcbiAqIEBjbGFzc1xuICogQHJldHVybiB7TmV0U3VpdGVBZGFwdGVyfVxuICovXG52YXIgTmV0U3VpdGVBZGFwdGVyID0gbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBOZXRTdWl0ZUFkYXB0ZXIoKSB7XG4gIEJhc2VBZGFwdGVyLmNhbGwodGhpcyk7XG5cbiAgLyoqXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdleHRFbnRpdHlLZXknLCB7XG4gICAgZ2V0OiBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiB0aGlzLmNyZWRlbnRpYWxzLmFjY291bnQ7XG4gICAgfVxuICB9KTtcblxuICAvLyBTZWFyY2hJZCBjYWNoZSwgb25lIHBlciBmaWVsZFxuICB0aGlzLl9zZWFyY2hJZHMgPSB7fTtcblxuICAvLyBDYWNoZSByZXN1bHRzIGJ5IGZpZWxkIHR5cGUgLT4gbGltaXQgKHBhZ2VzaXplKSAtPiBza2lwLCBlLmcuOlxuICAvLyB0aGlzLl9jYWNoZWREYXRhQnlGaWVsZFR5cGVbRmllbGRzLlR5cGVzLlVTRVJdWzEwXVszXVxuICAvLyByZXByZXNlbnRzIGFsbCB1c2VyIHJlY29yZHMgZm9yIHNlYXJjaCBwYWdlIHNpemUgMTAgc3RhcnRpbmcgYXQgaW5kZXggMy5cbiAgLy8gRVhUX0VOVElUWSBmaWVsZHMgYXJlIGhhdmUgYW4gYWRkaXRpb25hbCBsYXllciBmb3IgZW50aXR5VHlwZSwgZS5nLjpcbiAgLy8gdGhpcy5fY2FjaGVkRGF0YUJ5RmllbGRUeXBlW0ZpZWxkcy5UeXBlcy5FWFRfRU5USVRZXVsnY3VzdG9tZXInXVsxMF1bM11cbiAgdGhpcy5fY2FjaGVkRGF0YUJ5RmllbGRUeXBlID0ge307XG59O1xuXG51dGlsLmluaGVyaXRzKE5ldFN1aXRlQWRhcHRlciwgQmFzZUFkYXB0ZXIpO1xuXG4vKipcbiAqIEBvdmVycmlkZVxuICovXG5OZXRTdWl0ZUFkYXB0ZXIucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbigpIHtcbiAgdmFyIF90aGlzID0gdGhpcztcbiAgdGhpcy5fY29uZmlnID0gbmV3IE5ldFN1aXRlLkNvbmZpZ3VyYXRpb24odGhpcy5jcmVkZW50aWFscyk7XG4gIHRoaXMuX3NlcnZpY2UgPSBuZXcgTmV0U3VpdGUuU2VydmljZSh0aGlzLl9jb25maWcpO1xuICByZXR1cm4gdGhpcy5fc2VydmljZVxuICAgIC5pbml0KClcbiAgICAudGhlbihmdW5jdGlvbiggLypjbGllbnQqLyApIHtcbiAgICAgIHZhciBtc2cgPSAnU3VjY2Vzc2Z1bGx5IGluaXRpYWxpemVkIE5ldFN1aXRlQWRhcHRlciBmb3IgZW1haWw6ICVzLCBhY2NvdW50OiAlcywgcm9sZTogJWQnO1xuICAgICAgY29uc29sZS5sb2cobXNnLCBfdGhpcy5jcmVkZW50aWFscy5lbWFpbCwgX3RoaXMuY3JlZGVudGlhbHMuYWNjb3VudCwgX3RoaXMuY3JlZGVudGlhbHMucm9sZSk7XG4gICAgICByZXR1cm4gX3RoaXM7XG4gICAgfSk7XG59O1xuXG4vKipcbiAqIEBvdmVycmlkZVxuICovXG5OZXRTdWl0ZUFkYXB0ZXIucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24oKSB7XG4gIHRoaXMuX3NlYXJjaElkcyA9IHt9O1xuICB0aGlzLl9jYWNoZWREYXRhQnlGaWVsZFR5cGUgPSB7fTtcbiAgZGVsZXRlIHRoaXMuX2NvbmZpZztcbiAgZGVsZXRlIHRoaXMuX3NlcnZpY2U7XG59O1xuXG5OZXRTdWl0ZUFkYXB0ZXIucHJvdG90eXBlLl9zZXRDYWNoZVZhbHVlID0gZnVuY3Rpb24oZmllbGQsIGxpbWl0LCBza2lwLCBkYXRhKSB7XG4gIHZhciBmaWVsZENhY2hlID0gdGhpcy5fY2FjaGVkRGF0YUJ5RmllbGRUeXBlW2ZpZWxkLnR5cGVdID0gdGhpcy5fY2FjaGVkRGF0YUJ5RmllbGRUeXBlW2ZpZWxkLnR5cGVdIHx8IHt9O1xuXG4gIGlmIChmaWVsZC50eXBlID09PSBGaWVsZHMuVHlwZXMuRVhUX0VOVElUWSkge1xuICAgIGZpZWxkQ2FjaGUgPSB0aGlzLl9jYWNoZWREYXRhQnlGaWVsZFR5cGVbZmllbGQudHlwZV1bZmllbGQuZW50aXR5VHlwZV0gPSB0aGlzLl9jYWNoZWREYXRhQnlGaWVsZFR5cGVbZmllbGQudHlwZV1bZmllbGQuZW50aXR5VHlwZV0gfHwge307XG4gIH1cblxuICBmaWVsZENhY2hlW2xpbWl0XSA9IGZpZWxkQ2FjaGVbbGltaXRdIHx8IHt9O1xuICBmaWVsZENhY2hlW2xpbWl0XVtza2lwXSA9IF8uY2xvbmVEZWVwKGRhdGEpO1xufTtcblxuTmV0U3VpdGVBZGFwdGVyLnByb3RvdHlwZS5fZ2V0Q2FjaGVWYWx1ZSA9IGZ1bmN0aW9uKGZpZWxkLCBsaW1pdCwgc2tpcCkge1xuICB2YXIgZmllbGRDYWNoZSA9IHRoaXMuX2NhY2hlZERhdGFCeUZpZWxkVHlwZVtmaWVsZC50eXBlXTtcbiAgaWYgKCFmaWVsZENhY2hlKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGlmIChmaWVsZC50eXBlID09PSBGaWVsZHMuVHlwZXMuRVhUX0VOVElUWSkge1xuICAgIGZpZWxkQ2FjaGUgPSBmaWVsZENhY2hlW2ZpZWxkLmVudGl0eVR5cGVdO1xuICB9XG4gIHJldHVybiBmaWVsZENhY2hlICYmXG4gICAgZmllbGRDYWNoZVtsaW1pdF0gJiZcbiAgICBmaWVsZENhY2hlW2xpbWl0XVtza2lwXTtcbn07XG5cbi8qKlxuICogQG92ZXJyaWRlXG4gKi9cbk5ldFN1aXRlQWRhcHRlci5wcm90b3R5cGUuZ2V0RmllbGREYXRhID0gZnVuY3Rpb24oZmllbGQsIHF1ZXJ5KSB7XG4gIGNvbnNvbGUubG9nKGZpZWxkKTtcbiAgdmFyIF90aGlzID0gdGhpcztcbiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgIHF1ZXJ5ID0gcXVlcnkgfHwge307XG5cbiAgICB2YXIgcHJlZmVyZW5jZXMgPSBuZXcgTmV0U3VpdGUuU2VhcmNoLlNlYXJjaFByZWZlcmVuY2VzKCk7XG4gICAgcHJlZmVyZW5jZXMucGFnZVNpemUgPSBxdWVyeS5saW1pdCB8fCAxMDtcbiAgICBfdGhpcy5fc2VydmljZS5zZXRTZWFyY2hQcmVmZXJlbmNlcyhwcmVmZXJlbmNlcyk7XG5cbiAgICBpZiAoIWltcGxlbWVudGVkRmllbGRzW2ZpZWxkLnR5cGVdIHx8ICFpbXBsZW1lbnRlZEZpZWxkc1tmaWVsZC50eXBlXVtmaWVsZC5leHRJZF0pIHtcbiAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKCdVbmtub3duIGZpZWxkIG9yIHJldHJpZXZhbCBOWUkgYnkgTmV0U3VpdGVBZGFwdGVyOicsIGZpZWxkKSk7XG4gICAgfVxuXG4gICAgLy8gQ2FjaGUgaGl0P1xuICAgIHZhciBjYWNoZWQgPSBfdGhpcy5fZ2V0Q2FjaGVWYWx1ZShmaWVsZCwgcHJlZmVyZW5jZXMucGFnZVNpemUsIHF1ZXJ5LnNraXApO1xuICAgIGlmIChjYWNoZWQpIHtcbiAgICAgIHJldHVybiByZXNvbHZlKGNhY2hlZCk7XG4gICAgfVxuXG4gICAgdmFyIHBhZ2VJbmRleCwgc2VhcmNoO1xuICAgIGlmIChmaWVsZC50eXBlID09PSBGaWVsZHMuVHlwZXMuVVNFUikge1xuICAgICAgaWYgKHF1ZXJ5LnNraXApIHtcbiAgICAgICAgaWYgKCFfdGhpcy5fc2VhcmNoSWRzW2ZpZWxkLmV4dElkXSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTmV0U3VpdGUgcGFnZWQgc2VhcmNoZXMgbXVzdCBzdGFydCB3aXRoIGFuIGluaXRpYWwgc2VhcmNoIHRvIGdlbmVyYXRlIGEgc2VhcmNoIHNlc3Npb24nKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBSb3VuZCBkb3duIHRoZW4gYWRkIDEgc2luY2UgbmV0c3VpdGUgcGFnZSBpbmRpY2VzIGFyZSBvbmUtYmFzZWRcbiAgICAgICAgcGFnZUluZGV4ID0gTWF0aC5mbG9vcihxdWVyeS5za2lwIC8gcHJlZmVyZW5jZXMucGFnZVNpemUpICsgMTtcbiAgICAgICAgY29uc29sZS5sb2coJ3NlYXJjaE1vcmVXaXRoSWQgd2l0aCBwYWdlSW5kZXggXCIlZFwiJywgcGFnZUluZGV4KTtcbiAgICAgICAgcmV0dXJuIF90aGlzLl9zZXJ2aWNlLnNlYXJjaE1vcmVXaXRoSWQoX3RoaXMuX3NlYXJjaElkc1tmaWVsZC5leHRJZF0sIHBhZ2VJbmRleClcbiAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICAgIHZhciBkYXRhID0ge1xuICAgICAgICAgICAgICBjb3VudDogcmVzdWx0LnNlYXJjaFJlc3VsdC50b3RhbFJlY29yZHMsXG4gICAgICAgICAgICAgIHJlc3VsdHM6IHJlc3VsdC5zZWFyY2hSZXN1bHQucmVjb3JkTGlzdC5yZWNvcmRcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBfdGhpcy5fc2V0Q2FjaGVWYWx1ZShmaWVsZCwgcHJlZmVyZW5jZXMucGFnZVNpemUsIHF1ZXJ5LnNraXAsIGRhdGEpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoZGF0YSk7XG4gICAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBObyBjcml0ZXJpYSByaWdodCBub3dcbiAgICAgICAgc2VhcmNoID0gbmV3IE5ldFN1aXRlLlNlYXJjaC5FbXBsb3llZVNlYXJjaEJhc2ljKCk7XG4gICAgICAgIHJldHVybiBfdGhpcy5fc2VydmljZS5zZWFyY2goc2VhcmNoKVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgaWYgKHJlc3VsdC5zZWFyY2hSZXN1bHQudG90YWxQYWdlcyA+IDEpIHtcbiAgICAgICAgICAgICAgX3RoaXMuX3NlYXJjaElkc1tmaWVsZC5leHRJZF0gPSByZXN1bHQuc2VhcmNoUmVzdWx0LnNlYXJjaElkO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgZGF0YSA9IHtcbiAgICAgICAgICAgICAgY291bnQ6IHJlc3VsdC5zZWFyY2hSZXN1bHQudG90YWxSZWNvcmRzLFxuICAgICAgICAgICAgICByZXN1bHRzOiByZXN1bHQuc2VhcmNoUmVzdWx0LnJlY29yZExpc3QucmVjb3JkXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgX3RoaXMuX3NldENhY2hlVmFsdWUoZmllbGQsIHByZWZlcmVuY2VzLnBhZ2VTaXplLCBxdWVyeS5za2lwLCBkYXRhKTtcbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlKGRhdGEpO1xuICAgICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZmllbGQudHlwZSA9PT0gRmllbGRzLlR5cGVzLkVYVF9FTlRJVFkpIHtcbiAgICAgIGlmIChmaWVsZC5lbnRpdHlUeXBlID09PSAnY3VzdG9tZXInKSB7XG4gICAgICAgIGlmIChxdWVyeS5za2lwKSB7XG4gICAgICAgICAgaWYgKCFfdGhpcy5fc2VhcmNoSWRzW2ZpZWxkLmV4dElkXSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOZXRTdWl0ZSBwYWdlZCBzZWFyY2hlcyBtdXN0IHN0YXJ0IHdpdGggYW4gaW5pdGlhbCBzZWFyY2ggdG8gZ2VuZXJhdGUgYSBzZWFyY2ggc2Vzc2lvbicpO1xuICAgICAgICAgIH1cbiAgICAgICAgICAvLyBSb3VuZCBkb3duIHRoZW4gYWRkIDEgc2luY2UgbmV0c3VpdGUgcGFnZSBpbmRpY2VzIGFyZSBvbmUtYmFzZWRcbiAgICAgICAgICBwYWdlSW5kZXggPSBNYXRoLmZsb29yKHF1ZXJ5LnNraXAgLyBwcmVmZXJlbmNlcy5wYWdlU2l6ZSkgKyAxO1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdzZWFyY2hNb3JlV2l0aElkIHdpdGggcGFnZUluZGV4IFwiJWRcIicsIHBhZ2VJbmRleCk7XG4gICAgICAgICAgcmV0dXJuIF90aGlzLl9zZXJ2aWNlLnNlYXJjaE1vcmVXaXRoSWQoX3RoaXMuX3NlYXJjaElkc1tmaWVsZC5leHRJZF0sIHBhZ2VJbmRleClcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgICB2YXIgZGF0YSA9IHtcbiAgICAgICAgICAgICAgICBjb3VudDogcmVzdWx0LnNlYXJjaFJlc3VsdC50b3RhbFJlY29yZHMsXG4gICAgICAgICAgICAgICAgcmVzdWx0czogcmVzdWx0LnNlYXJjaFJlc3VsdC5zZWFyY2hSb3dMaXN0LnNlYXJjaFJvd1xuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICBfdGhpcy5fc2V0Q2FjaGVWYWx1ZShmaWVsZCwgcHJlZmVyZW5jZXMucGFnZVNpemUsIHF1ZXJ5LnNraXAsIGRhdGEpO1xuICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vIE5vIGNyaXRlcmlhIHJpZ2h0IG5vd1xuICAgICAgICAgIHNlYXJjaCA9IG5ldyBOZXRTdWl0ZS5TZWFyY2guQ3VzdG9tZXJTZWFyY2hBZHZhbmNlZCgpO1xuICAgICAgICAgIHNlYXJjaC5jb2x1bW5zID0gbmV3IE5ldFN1aXRlLlNlYXJjaC5DdXN0b21lclNlYXJjaFJvdygpO1xuICAgICAgICAgIHNlYXJjaC5jb2x1bW5zLmJhc2ljID0gbmV3IE5ldFN1aXRlLlNlYXJjaC5DdXN0b21lclNlYXJjaFJvd0Jhc2ljKCk7XG5cbiAgICAgICAgICAvLyBGb3Igbm93LCBhbHdheXMgaW5jbHVkZSBhbGwgU2VhcmNoQ29sdW1uIGZpZWxkcyBzaW5jZSBzdG9yaW5nIGFuIGV4dHJhIGZpZWxkXG4gICAgICAgICAgLy8gaXMgZmFyIGxlc3MgY29zdGx5IHRoYW4gaGF2aW5nIHRvIGRvIGFub3RoZXIgcm91bmR0cmlwIHRvIHJldHJpZXZlIGFub3RoZXIgZmllbGRcbiAgICAgICAgICB2YXIgZW50aXR5SWRGaWVsZCA9IG5ldyBOZXRTdWl0ZS5TZWFyY2guRmllbGRzLlNlYXJjaENvbHVtblN0cmluZ0ZpZWxkKCk7XG4gICAgICAgICAgZW50aXR5SWRGaWVsZC5maWVsZCA9ICdlbnRpdHlJZCc7XG4gICAgICAgICAgc2VhcmNoLmNvbHVtbnMuYmFzaWMuc2VhcmNoQ29sdW1uRmllbGRzLnB1c2goZW50aXR5SWRGaWVsZCk7XG5cbiAgICAgICAgICB2YXIgaW50ZXJuYWxJZEZpZWxkID0gbmV3IE5ldFN1aXRlLlNlYXJjaC5GaWVsZHMuU2VhcmNoQ29sdW1uU2VsZWN0RmllbGQoKTtcbiAgICAgICAgICBpbnRlcm5hbElkRmllbGQuZmllbGQgPSAnaW50ZXJuYWxJZCc7XG4gICAgICAgICAgc2VhcmNoLmNvbHVtbnMuYmFzaWMuc2VhcmNoQ29sdW1uRmllbGRzLnB1c2goaW50ZXJuYWxJZEZpZWxkKTtcblxuICAgICAgICAgIHZhciBiYWxhbmNlRmllbGQgPSBuZXcgTmV0U3VpdGUuU2VhcmNoLkZpZWxkcy5TZWFyY2hDb2x1bW5Eb3VibGVGaWVsZCgpO1xuICAgICAgICAgIGJhbGFuY2VGaWVsZC5maWVsZCA9ICdiYWxhbmNlJztcbiAgICAgICAgICBzZWFyY2guY29sdW1ucy5iYXNpYy5zZWFyY2hDb2x1bW5GaWVsZHMucHVzaChiYWxhbmNlRmllbGQpO1xuXG4gICAgICAgICAgdmFyIG92ZXJkdWVCYWxhbmNlRmllbGQgPSBuZXcgTmV0U3VpdGUuU2VhcmNoLkZpZWxkcy5TZWFyY2hDb2x1bW5Eb3VibGVGaWVsZCgpO1xuICAgICAgICAgIG92ZXJkdWVCYWxhbmNlRmllbGQuZmllbGQgPSAnb3ZlcmR1ZUJhbGFuY2UnO1xuICAgICAgICAgIHNlYXJjaC5jb2x1bW5zLmJhc2ljLnNlYXJjaENvbHVtbkZpZWxkcy5wdXNoKG92ZXJkdWVCYWxhbmNlRmllbGQpO1xuXG4gICAgICAgICAgdmFyIGRheXNPdmVyZHVlRmllbGQgPSBuZXcgTmV0U3VpdGUuU2VhcmNoLkZpZWxkcy5TZWFyY2hDb2x1bW5Mb25nRmllbGQoKTtcbiAgICAgICAgICBkYXlzT3ZlcmR1ZUZpZWxkLmZpZWxkID0gJ2RheXNPdmVyZHVlJztcbiAgICAgICAgICBzZWFyY2guY29sdW1ucy5iYXNpYy5zZWFyY2hDb2x1bW5GaWVsZHMucHVzaChkYXlzT3ZlcmR1ZUZpZWxkKTtcblxuICAgICAgICAgIHJldHVybiBfdGhpcy5fc2VydmljZS5zZWFyY2goc2VhcmNoKVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICAgIGlmIChyZXN1bHQuc2VhcmNoUmVzdWx0LnRvdGFsUGFnZXMgPiAxKSB7XG4gICAgICAgICAgICAgICAgX3RoaXMuX3NlYXJjaElkc1tmaWVsZC5leHRJZF0gPSByZXN1bHQuc2VhcmNoUmVzdWx0LnNlYXJjaElkO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgdmFyIGRhdGEgPSB7XG4gICAgICAgICAgICAgICAgY291bnQ6IHJlc3VsdC5zZWFyY2hSZXN1bHQudG90YWxSZWNvcmRzLFxuICAgICAgICAgICAgICAgIHJlc3VsdHM6IHJlc3VsdC5zZWFyY2hSZXN1bHQuc2VhcmNoUm93TGlzdC5zZWFyY2hSb3dcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgX3RoaXMuX3NldENhY2hlVmFsdWUoZmllbGQsIHByZWZlcmVuY2VzLnBhZ2VTaXplLCBxdWVyeS5za2lwLCBkYXRhKTtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoZGF0YSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlamVjdChuZXcgRXJyb3IoJ1Vua25vd24gRVhUX0VOVElUWSBlbnRpdHlUeXBlOicsIGZpZWxkLmVudGl0eVR5cGUpKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xufTtcbiJdfQ==
//# sourceMappingURL=index.js.map
