'use strict';

var _Promise = require('babel-runtime/core-js/promise')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _util = require('util');

var _util2 = _interopRequireDefault(_util);

var _baseAdapter = require('../base/Adapter');

var _baseAdapter2 = _interopRequireDefault(_baseAdapter);

var _fields = require('../fields');

var _fields2 = _interopRequireDefault(_fields);

var _netsuiteJs = require('netsuite-js');

var _netsuiteJs2 = _interopRequireDefault(_netsuiteJs);

var implementedFields = {};
implementedFields[_fields2['default'].Types.USER] = {
  'department#internalId': true,
  'supervisor#internalId': true
};
implementedFields[_fields2['default'].Types.EXT_ENTITY] = {
  'customer#balance': true,
  'customer#overdueBalance': true,
  'customer#daysOverdue': true
};

/**
 * NetSuiteAdapter
 *
 * `credentials` format:
 * ```
 * {
 *   email: 'test@test.com',
 *   password: 'password',
 *   account: 123456,
 *   role: 3
 * }
 * ```
 * @class
 * @return {NetSuiteAdapter}
 */
var NetSuiteAdapter = module.exports = function NetSuiteAdapter() {
  _baseAdapter2['default'].call(this);

  /**
   * @override
   */
  Object.defineProperty(this, 'extEntityKey', {
    get: function get() {
      return this.credentials.account;
    }
  });

  // SearchId cache, one per field
  this._searchIds = {};

  // Cache results by field type -> limit (pagesize) -> skip, e.g.:
  // this._cachedDataByFieldType[Fields.Types.USER][10][3]
  // represents all user records for search page size 10 starting at index 3.
  // EXT_ENTITY fields are have an additional layer for entityType, e.g.:
  // this._cachedDataByFieldType[Fields.Types.EXT_ENTITY]['customer'][10][3]
  this._cachedDataByFieldType = {};
};

_util2['default'].inherits(NetSuiteAdapter, _baseAdapter2['default']);

/**
 * @override
 */
NetSuiteAdapter.prototype.init = function () {
  var _this = this;
  this._config = new _netsuiteJs2['default'].Configuration(this.credentials);
  this._service = new _netsuiteJs2['default'].Service(this._config);
  return this._service.init().then(function () /*client*/{
    var msg = 'Successfully initialized NetSuiteAdapter for email: %s, account: %s, role: %d';
    console.log(msg, _this.credentials.email, _this.credentials.account, _this.credentials.role);
    return _this;
  });
};

/**
 * @override
 */
NetSuiteAdapter.prototype.reset = function () {
  this._searchIds = {};
  this._cachedDataByFieldType = {};
  delete this._config;
  delete this._service;
};

NetSuiteAdapter.prototype._setCacheValue = function (field, limit, skip, data) {
  var fieldCache = this._cachedDataByFieldType[field.type] = this._cachedDataByFieldType[field.type] || {};

  if (field.type === _fields2['default'].Types.EXT_ENTITY) {
    fieldCache = this._cachedDataByFieldType[field.type][field.entityType] = this._cachedDataByFieldType[field.type][field.entityType] || {};
  }

  fieldCache[limit] = fieldCache[limit] || {};
  fieldCache[limit][skip] = _lodash2['default'].cloneDeep(data);
};

NetSuiteAdapter.prototype._getCacheValue = function (field, limit, skip) {
  var fieldCache = this._cachedDataByFieldType[field.type];
  if (!fieldCache) {
    return undefined;
  }

  if (field.type === _fields2['default'].Types.EXT_ENTITY) {
    fieldCache = fieldCache[field.entityType];
  }
  return fieldCache && fieldCache[limit] && fieldCache[limit][skip];
};

/**
 * @override
 */
NetSuiteAdapter.prototype.getFieldData = function (field, query) {
  console.log(field);
  var _this = this;
  return new _Promise(function (resolve, reject) {
    query = query || {};

    var preferences = new _netsuiteJs2['default'].Search.SearchPreferences();
    preferences.pageSize = query.limit || 10;
    _this._service.setSearchPreferences(preferences);

    if (!implementedFields[field.type] || !implementedFields[field.type][field.extId]) {
      return reject(new Error('Unknown field or retrieval NYI by NetSuiteAdapter:', field));
    }

    // Cache hit?
    var cached = _this._getCacheValue(field, preferences.pageSize, query.skip);
    if (cached) {
      return resolve(cached);
    }

    var pageIndex, search;
    if (field.type === _fields2['default'].Types.USER) {
      if (query.skip) {
        if (!_this._searchIds[field.extId]) {
          throw new Error('NetSuite paged searches must start with an initial search to generate a search session');
        }
        // Round down then add 1 since netsuite page indices are one-based
        pageIndex = Math.floor(query.skip / preferences.pageSize) + 1;
        console.log('searchMoreWithId with pageIndex "%d"', pageIndex);
        return _this._service.searchMoreWithId(_this._searchIds[field.extId], pageIndex).then(function (result) {
          var data = {
            count: result.searchResult.totalRecords,
            results: result.searchResult.recordList.record
          };
          _this._setCacheValue(field, preferences.pageSize, query.skip, data);
          return resolve(data);
        });
      } else {
        // No criteria right now
        search = new _netsuiteJs2['default'].Search.EmployeeSearchBasic();
        return _this._service.search(search).then(function (result) {
          if (result.searchResult.totalPages > 1) {
            _this._searchIds[field.extId] = result.searchResult.searchId;
          }

          var data = {
            count: result.searchResult.totalRecords,
            results: result.searchResult.recordList.record
          };
          _this._setCacheValue(field, preferences.pageSize, query.skip, data);
          return resolve(data);
        });
      }
    } else if (field.type === _fields2['default'].Types.EXT_ENTITY) {
      if (field.entityType === 'customer') {
        if (query.skip) {
          if (!_this._searchIds[field.extId]) {
            throw new Error('NetSuite paged searches must start with an initial search to generate a search session');
          }
          // Round down then add 1 since netsuite page indices are one-based
          pageIndex = Math.floor(query.skip / preferences.pageSize) + 1;
          console.log('searchMoreWithId with pageIndex "%d"', pageIndex);
          return _this._service.searchMoreWithId(_this._searchIds[field.extId], pageIndex).then(function (result) {
            var data = {
              count: result.searchResult.totalRecords,
              results: result.searchResult.searchRowList.searchRow
            };
            _this._setCacheValue(field, preferences.pageSize, query.skip, data);
            return resolve(data);
          });
        } else {
          // No criteria right now
          search = new _netsuiteJs2['default'].Search.CustomerSearchAdvanced();
          search.columns = new _netsuiteJs2['default'].Search.CustomerSearchRow();
          search.columns.basic = new _netsuiteJs2['default'].Search.CustomerSearchRowBasic();

          // For now, always include all SearchColumn fields since storing an extra field
          // is far less costly than having to do another roundtrip to retrieve another field
          var entityIdField = new _netsuiteJs2['default'].Search.Fields.SearchColumnStringField();
          entityIdField.field = 'entityId';
          search.columns.basic.searchColumnFields.push(entityIdField);

          var internalIdField = new _netsuiteJs2['default'].Search.Fields.SearchColumnSelectField();
          internalIdField.field = 'internalId';
          search.columns.basic.searchColumnFields.push(internalIdField);

          var balanceField = new _netsuiteJs2['default'].Search.Fields.SearchColumnDoubleField();
          balanceField.field = 'balance';
          search.columns.basic.searchColumnFields.push(balanceField);

          var overdueBalanceField = new _netsuiteJs2['default'].Search.Fields.SearchColumnDoubleField();
          overdueBalanceField.field = 'overdueBalance';
          search.columns.basic.searchColumnFields.push(overdueBalanceField);

          var daysOverdueField = new _netsuiteJs2['default'].Search.Fields.SearchColumnLongField();
          daysOverdueField.field = 'daysOverdue';
          search.columns.basic.searchColumnFields.push(daysOverdueField);

          return _this._service.search(search).then(function (result) {
            if (result.searchResult.totalPages > 1) {
              _this._searchIds[field.extId] = result.searchResult.searchId;
            }

            var data = {
              count: result.searchResult.totalRecords,
              results: result.searchResult.searchRowList.searchRow
            };
            _this._setCacheValue(field, preferences.pageSize, query.skip, data);
            return resolve(data);
          });
        }
      } else {
        return reject(new Error('Unknown EXT_ENTITY entityType:', field.entityType));
      }
    }
  });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsQWRhcHRlcnNcXG5ldHN1aXRlXFxpbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7Ozs7OztzQkFFQyxRQUFROzs7O29CQUNMLE1BQU07Ozs7MkJBQ0MsaUJBQWlCOzs7O3NCQUN0QixXQUFXOzs7OzBCQUNULGFBQWE7Ozs7QUFFbEMsSUFBSSxpQkFBaUIsR0FBRyxFQUFFLENBQUM7QUFDM0IsaUJBQWlCLENBQUMsb0JBQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHO0FBQ3JDLHlCQUF1QixFQUFFLElBQUk7QUFDN0IseUJBQXVCLEVBQUUsSUFBSTtDQUM5QixDQUFDO0FBQ0YsaUJBQWlCLENBQUMsb0JBQU8sS0FBSyxDQUFDLFVBQVUsQ0FBQyxHQUFHO0FBQzNDLG9CQUFrQixFQUFFLElBQUk7QUFDeEIsMkJBQXlCLEVBQUUsSUFBSTtBQUMvQix3QkFBc0IsRUFBRSxJQUFJO0NBQzdCLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBaUJGLElBQUksZUFBZSxHQUFHLE1BQU0sQ0FBQyxPQUFPLEdBQUcsU0FBUyxlQUFlLEdBQUc7QUFDaEUsMkJBQVksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDOzs7OztBQUt2QixRQUFNLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7QUFDMUMsT0FBRyxFQUFFLGVBQVc7QUFDZCxhQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDO0tBQ2pDO0dBQ0YsQ0FBQyxDQUFDOzs7QUFHSCxNQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQzs7Ozs7OztBQU9yQixNQUFJLENBQUMsc0JBQXNCLEdBQUcsRUFBRSxDQUFDO0NBQ2xDLENBQUM7O0FBRUYsa0JBQUssUUFBUSxDQUFDLGVBQWUsMkJBQWMsQ0FBQzs7Ozs7QUFLNUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsWUFBVztBQUMxQyxNQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7QUFDakIsTUFBSSxD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QWdCLEdBQUcsSUFBSSx3QkFBUyxNQUFNLENBQUMsTUFBTSxDQUFDLHFCQUFxQixFQUFFLENBQUM7QUFDMUUsMEJBQWdCLENBQUMsS0FBSyxHQUFHLGFBQWEsQ0FBQztBQUN2QyxnQkFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7O0FBRS9ELGlCQUFPLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUNqQyxJQUFJLENBQUMsVUFBUyxNQUFNLEVBQUU7QUFDckIsZ0JBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxVQUFVLEdBQUcsQ0FBQyxFQUFFO0FBQ3RDLG1CQUFLLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQzthQUM5RDs7QUFFRCxnQkFBSSxJQUFJLEdBQUc7QUFDVCxtQkFBSyxFQUFFLE1BQU0sQ0FBQyxZQUFZLENBQUMsWUFBWTtBQUN2QyxxQkFBTyxFQUFFLE1BQU0sQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFNBQVM7YUFDckQsQ0FBQztBQUNGLGlCQUFLLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDcEUsbUJBQU8sT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1dBQ3RCLENBQUMsQ0FBQztTQUNOO09BQ0YsTUFBTTtBQUNMLGVBQU8sTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLGdDQUFnQyxFQUFFLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO09BQzlFO0tBQ0Y7R0FDRixDQUFDLENBQUM7Q0FDSixDQUFDIiwiZmlsZSI6ImNsQWRhcHRlcnNcXG5ldHN1aXRlXFxpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuXHJcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XHJcbmltcG9ydCB1dGlsIGZyb20gJ3V0aWwnO1xyXG5pbXBvcnQgQmFzZUFkYXB0ZXIgZnJvbSAnLi4vYmFzZS9BZGFwdGVyJztcclxuaW1wb3J0IEZpZWxkcyBmcm9tICcuLi9maWVsZHMnO1xyXG5pbXBvcnQgTmV0U3VpdGUgZnJvbSAnbmV0c3VpdGUtanMnO1xyXG5cclxudmFyIGltcGxlbWVudGVkRmllbGRzID0ge307XHJcbmltcGxlbWVudGVkRmllbGRzW0ZpZWxkcy5UeXBlcy5VU0VSXSA9IHtcclxuICAnZGVwYXJ0bWVudCNpbnRlcm5hbElkJzogdHJ1ZSxcclxuICAnc3VwZXJ2aXNvciNpbnRlcm5hbElkJzogdHJ1ZVxyXG59O1xyXG5pbXBsZW1lbnRlZEZpZWxkc1tGaWVsZHMuVHlwZXMuRVhUX0VOVElUWV0gPSB7XHJcbiAgJ2N1c3RvbWVyI2JhbGFuY2UnOiB0cnVlLFxyXG4gICdjdXN0b21lciNvdmVyZHVlQmFsYW5jZSc6IHRydWUsXHJcbiAgJ2N1c3RvbWVyI2RheXNPdmVyZHVlJzogdHJ1ZVxyXG59O1xyXG5cclxuLyoqXHJcbiAqIE5ldFN1aXRlQWRhcHRlclxyXG4gKlxyXG4gKiBgY3JlZGVudGlhbHNgIGZvcm1hdDpcclxuICogYGBgXHJcbiAqIHtcclxuICogICBlbWFpbDogJ3Rlc3RAdGVzdC5jb20nLFxyXG4gKiAgIHBhc3N3b3JkOiAncGFzc3dvcmQnLFxyXG4gKiAgIGFjY291bnQ6IDEyMzQ1NixcclxuICogICByb2xlOiAzXHJcbiAqIH1cclxuICogYGBgXHJcbiAqIEBjbGFzc1xyXG4gKiBAcmV0dXJuIHtOZXRTdWl0ZUFkYXB0ZXJ9XHJcbiAqL1xyXG52YXIgTmV0U3VpdGVBZGFwdGVyID0gbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBOZXRTdWl0ZUFkYXB0ZXIoKSB7XHJcbiAgQmFzZUFkYXB0ZXIuY2FsbCh0aGlzKTtcclxuXHJcbiAgLyoqXHJcbiAgICogQG92ZXJyaWRlXHJcbiAgICovXHJcbiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsICdleHRFbnRpdHlLZXknLCB7XHJcbiAgICBnZXQ6IGZ1bmN0aW9uKCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5jcmVkZW50aWFscy5hY2NvdW50O1xyXG4gICAgfVxyXG4gIH0pO1xyXG5cclxuICAvLyBTZWFyY2hJZCBjYWNoZSwgb25lIHBlciBmaWVsZFxyXG4gIHRoaXMuX3NlYXJjaElkcyA9IHt9O1xyXG5cclxuICAvLyBDYWNoZSByZXN1bHRzIGJ5IGZpZWxkIHR5cGUgLT4gbGltaXQgKHBhZ2VzaXplKSAtPiBza2lwLCBlLmcuOlxyXG4gIC8vIHRoaXMuX2NhY2hlZERhdGFCeUZpZWxkVHlwZVtGaWVsZHMuVHlwZXMuVVNFUl1bMTBdWzNdXHJcbiAgLy8gcmVwcmVzZW50cyBhbGwgdXNlciByZWNvcmRzIGZvciBzZWFyY2ggcGFnZSBzaXplIDEwIHN0YXJ0aW5nIGF0IGluZGV4IDMuXHJcbiAgLy8gRVhUX0VOVElUWSBmaWVsZHMgYXJlIGhhdmUgYW4gYWRkaXRpb25hbCBsYXllciBmb3IgZW50aXR5VHlwZSwgZS5nLjpcclxuICAvLyB0aGlzLl9jYWNoZWREYXRhQnlGaWVsZFR5cGVbRmllbGRzLlR5cGVzLkVYVF9FTlRJVFldWydjdXN0b21lciddWzEwXVszXVxyXG4gIHRoaXMuX2NhY2hlZERhdGFCeUZpZWxkVHlwZSA9IHt9O1xyXG59O1xyXG5cclxudXRpbC5pbmhlcml0cyhOZXRTdWl0ZUFkYXB0ZXIsIEJhc2VBZGFwdGVyKTtcclxuXHJcbi8qKlxyXG4gKiBAb3ZlcnJpZGVcclxuICovXHJcbk5ldFN1aXRlQWRhcHRlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKCkge1xyXG4gIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgdGhpcy5fY29uZmlnID0gbmV3IE5ldFN1aXRlLkNvbmZpZ3VyYXRpb24odGhpcy5jcmVkZW50aWFscyk7XHJcbiAgdGhpcy5fc2VydmljZSA9IG5ldyBOZXRTdWl0ZS5TZXJ2aWNlKHRoaXMuX2NvbmZpZyk7XHJcbiAgcmV0dXJuIHRoaXMuX3NlcnZpY2VcclxuICAgIC5pbml0KClcclxuICAgIC50aGVuKGZ1bmN0aW9uKCAvKmNsaWVudCovICkge1xyXG4gICAgICB2YXIgbXNnID0gJ1N1Y2Nlc3NmdWxseSBpbml0aWFsaXplZCBOZXRTdWl0ZUFkYXB0ZXIgZm9yIGVtYWlsOiAlcywgYWNjb3VudDogJXMsIHJvbGU6ICVkJztcclxuICAgICAgY29uc29sZS5sb2cobXNnLCBfdGhpcy5jcmVkZW50aWFscy5lbWFpbCwgX3RoaXMuY3JlZGVudGlhbHMuYWNjb3VudCwgX3RoaXMuY3JlZGVudGlhbHMucm9sZSk7XHJcbiAgICAgIHJldHVybiBfdGhpcztcclxuICAgIH0pO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIEBvdmVycmlkZVxyXG4gKi9cclxuTmV0U3VpdGVBZGFwdGVyLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uKCkge1xyXG4gIHRoaXMuX3NlYXJjaElkcyA9IHt9O1xyXG4gIHRoaXMuX2NhY2hlZERhdGFCeUZpZWxkVHlwZSA9IHt9O1xyXG4gIGRlbGV0ZSB0aGlzLl9jb25maWc7XHJcbiAgZGVsZXRlIHRoaXMuX3NlcnZpY2U7XHJcbn07XHJcblxyXG5OZXRTdWl0ZUFkYXB0ZXIucHJvdG90eXBlLl9zZXRDYWNoZVZhbHVlID0gZnVuY3Rpb24oZmllbGQsIGxpbWl0LCBza2lwLCBkYXRhKSB7XHJcbiAgdmFyIGZpZWxkQ2FjaGUgPSB0aGlzLl9jYWNoZWREYXRhQnlGaWVsZFR5cGVbZmllbGQudHlwZV0gPSB0aGlzLl9jYWNoZWREYXRhQnlGaWVsZFR5cGVbZmllbGQudHlwZV0gfHwge307XHJcblxyXG4gIGlmIChmaWVsZC50eXBlID09PSBGaWVsZHMuVHlwZXMuRVhUX0VOVElUWSkge1xyXG4gICAgZmllbGRDYWNoZSA9IHRoaXMuX2NhY2hlZERhdGFCeUZpZWxkVHlwZVtmaWVsZC50eXBlXVtmaWVsZC5lbnRpdHlUeXBlXSA9IHRoaXMuX2NhY2hlZERhdGFCeUZpZWxkVHlwZVtmaWVsZC50eXBlXVtmaWVsZC5lbnRpdHlUeXBlXSB8fCB7fTtcclxuICB9XHJcblxyXG4gIGZpZWxkQ2FjaGVbbGltaXRdID0gZmllbGRDYWNoZVtsaW1pdF0gfHwge307XHJcbiAgZmllbGRDYWNoZVtsaW1pdF1bc2tpcF0gPSBfLmNsb25lRGVlcChkYXRhKTtcclxufTtcclxuXHJcbk5ldFN1aXRlQWRhcHRlci5wcm90b3R5cGUuX2dldENhY2hlVmFsdWUgPSBmdW5jdGlvbihmaWVsZCwgbGltaXQsIHNraXApIHtcclxuICB2YXIgZmllbGRDYWNoZSA9IHRoaXMuX2NhY2hlZERhdGFCeUZpZWxkVHlwZVtmaWVsZC50eXBlXTtcclxuICBpZiAoIWZpZWxkQ2FjaGUpIHtcclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICBpZiAoZmllbGQudHlwZSA9PT0gRmllbGRzLlR5cGVzLkVYVF9FTlRJVFkpIHtcclxuICAgIGZpZWxkQ2FjaGUgPSBmaWVsZENhY2hlW2ZpZWxkLmVudGl0eVR5cGVdO1xyXG4gIH1cclxuICByZXR1cm4gZmllbGRDYWNoZSAmJlxyXG4gICAgZmllbGRDYWNoZVtsaW1pdF0gJiZcclxuICAgIGZpZWxkQ2FjaGVbbGltaXRdW3NraXBdO1xyXG59O1xyXG5cclxuLyoqXHJcbiAqIEBvdmVycmlkZVxyXG4gKi9cclxuTmV0U3VpdGVBZGFwdGVyLnByb3RvdHlwZS5nZXRGaWVsZERhdGEgPSBmdW5jdGlvbihmaWVsZCwgcXVlcnkpIHtcclxuICBjb25zb2xlLmxvZyhmaWVsZCk7XHJcbiAgdmFyIF90aGlzID0gdGhpcztcclxuICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICBxdWVyeSA9IHF1ZXJ5IHx8IHt9O1xyXG5cclxuICAgIHZhciBwcmVmZXJlbmNlcyA9IG5ldyBOZXRTdWl0ZS5TZWFyY2guU2VhcmNoUHJlZmVyZW5jZXMoKTtcclxuICAgIHByZWZlcmVuY2VzLnBhZ2VTaXplID0gcXVlcnkubGltaXQgfHwgMTA7XHJcbiAgICBfdGhpcy5fc2VydmljZS5zZXRTZWFyY2hQcmVmZXJlbmNlcyhwcmVmZXJlbmNlcyk7XHJcblxyXG4gICAgaWYgKCFpbXBsZW1lbnRlZEZpZWxkc1tmaWVsZC50eXBlXSB8fCAhaW1wbGVtZW50ZWRGaWVsZHNbZmllbGQudHlwZV1bZmllbGQuZXh0SWRdKSB7XHJcbiAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKCdVbmtub3duIGZpZWxkIG9yIHJldHJpZXZhbCBOWUkgYnkgTmV0U3VpdGVBZGFwdGVyOicsIGZpZWxkKSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQ2FjaGUgaGl0P1xyXG4gICAgdmFyIGNhY2hlZCA9IF90aGlzLl9nZXRDYWNoZVZhbHVlKGZpZWxkLCBwcmVmZXJlbmNlcy5wYWdlU2l6ZSwgcXVlcnkuc2tpcCk7XHJcbiAgICBpZiAoY2FjaGVkKSB7XHJcbiAgICAgIHJldHVybiByZXNvbHZlKGNhY2hlZCk7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIHBhZ2VJbmRleCwgc2VhcmNoO1xyXG4gICAgaWYgKGZpZWxkLnR5cGUgPT09IEZpZWxkcy5UeXBlcy5VU0VSKSB7XHJcbiAgICAgIGlmIChxdWVyeS5za2lwKSB7XHJcbiAgICAgICAgaWYgKCFfdGhpcy5fc2VhcmNoSWRzW2ZpZWxkLmV4dElkXSkge1xyXG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOZXRTdWl0ZSBwYWdlZCBzZWFyY2hlcyBtdXN0IHN0YXJ0IHdpdGggYW4gaW5pdGlhbCBzZWFyY2ggdG8gZ2VuZXJhdGUgYSBzZWFyY2ggc2Vzc2lvbicpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBSb3VuZCBkb3duIHRoZW4gYWRkIDEgc2luY2UgbmV0c3VpdGUgcGFnZSBpbmRpY2VzIGFyZSBvbmUtYmFzZWRcclxuICAgICAgICBwYWdlSW5kZXggPSBNYXRoLmZsb29yKHF1ZXJ5LnNraXAgLyBwcmVmZXJlbmNlcy5wYWdlU2l6ZSkgKyAxO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdzZWFyY2hNb3JlV2l0aElkIHdpdGggcGFnZUluZGV4IFwiJWRcIicsIHBhZ2VJbmRleCk7XHJcbiAgICAgICAgcmV0dXJuIF90aGlzLl9zZXJ2aWNlLnNlYXJjaE1vcmVXaXRoSWQoX3RoaXMuX3NlYXJjaElkc1tmaWVsZC5leHRJZF0sIHBhZ2VJbmRleClcclxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdCkge1xyXG4gICAgICAgICAgICB2YXIgZGF0YSA9IHtcclxuICAgICAgICAgICAgICBjb3VudDogcmVzdWx0LnNlYXJjaFJlc3VsdC50b3RhbFJlY29yZHMsXHJcbiAgICAgICAgICAgICAgcmVzdWx0czogcmVzdWx0LnNlYXJjaFJlc3VsdC5yZWNvcmRMaXN0LnJlY29yZFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBfdGhpcy5fc2V0Q2FjaGVWYWx1ZShmaWVsZCwgcHJlZmVyZW5jZXMucGFnZVNpemUsIHF1ZXJ5LnNraXAsIGRhdGEpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIE5vIGNyaXRlcmlhIHJpZ2h0IG5vd1xyXG4gICAgICAgIHNlYXJjaCA9IG5ldyBOZXRTdWl0ZS5TZWFyY2guRW1wbG95ZWVTZWFyY2hCYXNpYygpO1xyXG4gICAgICAgIHJldHVybiBfdGhpcy5fc2VydmljZS5zZWFyY2goc2VhcmNoKVxyXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQuc2VhcmNoUmVzdWx0LnRvdGFsUGFnZXMgPiAxKSB7XHJcbiAgICAgICAgICAgICAgX3RoaXMuX3NlYXJjaElkc1tmaWVsZC5leHRJZF0gPSByZXN1bHQuc2VhcmNoUmVzdWx0LnNlYXJjaElkO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB2YXIgZGF0YSA9IHtcclxuICAgICAgICAgICAgICBjb3VudDogcmVzdWx0LnNlYXJjaFJlc3VsdC50b3RhbFJlY29yZHMsXHJcbiAgICAgICAgICAgICAgcmVzdWx0czogcmVzdWx0LnNlYXJjaFJlc3VsdC5yZWNvcmRMaXN0LnJlY29yZFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBfdGhpcy5fc2V0Q2FjaGVWYWx1ZShmaWVsZCwgcHJlZmVyZW5jZXMucGFnZVNpemUsIHF1ZXJ5LnNraXAsIGRhdGEpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKGZpZWxkLnR5cGUgPT09IEZpZWxkcy5UeXBlcy5FWFRfRU5USVRZKSB7XHJcbiAgICAgIGlmIChmaWVsZC5lbnRpdHlUeXBlID09PSAnY3VzdG9tZXInKSB7XHJcbiAgICAgICAgaWYgKHF1ZXJ5LnNraXApIHtcclxuICAgICAgICAgIGlmICghX3RoaXMuX3NlYXJjaElkc1tmaWVsZC5leHRJZF0pIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOZXRTdWl0ZSBwYWdlZCBzZWFyY2hlcyBtdXN0IHN0YXJ0IHdpdGggYW4gaW5pdGlhbCBzZWFyY2ggdG8gZ2VuZXJhdGUgYSBzZWFyY2ggc2Vzc2lvbicpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8gUm91bmQgZG93biB0aGVuIGFkZCAxIHNpbmNlIG5ldHN1aXRlIHBhZ2UgaW5kaWNlcyBhcmUgb25lLWJhc2VkXHJcbiAgICAgICAgICBwYWdlSW5kZXggPSBNYXRoLmZsb29yKHF1ZXJ5LnNraXAgLyBwcmVmZXJlbmNlcy5wYWdlU2l6ZSkgKyAxO1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ3NlYXJjaE1vcmVXaXRoSWQgd2l0aCBwYWdlSW5kZXggXCIlZFwiJywgcGFnZUluZGV4KTtcclxuICAgICAgICAgIHJldHVybiBfdGhpcy5fc2VydmljZS5zZWFyY2hNb3JlV2l0aElkKF90aGlzLl9zZWFyY2hJZHNbZmllbGQuZXh0SWRdLCBwYWdlSW5kZXgpXHJcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgIHZhciBkYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgY291bnQ6IHJlc3VsdC5zZWFyY2hSZXN1bHQudG90YWxSZWNvcmRzLFxyXG4gICAgICAgICAgICAgICAgcmVzdWx0czogcmVzdWx0LnNlYXJjaFJlc3VsdC5zZWFyY2hSb3dMaXN0LnNlYXJjaFJvd1xyXG4gICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgX3RoaXMuX3NldENhY2hlVmFsdWUoZmllbGQsIHByZWZlcmVuY2VzLnBhZ2VTaXplLCBxdWVyeS5za2lwLCBkYXRhKTtcclxuICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vIE5vIGNyaXRlcmlhIHJpZ2h0IG5vd1xyXG4gICAgICAgICAgc2VhcmNoID0gbmV3IE5ldFN1aXRlLlNlYXJjaC5DdXN0b21lclNlYXJjaEFkdmFuY2VkKCk7XHJcbiAgICAgICAgICBzZWFyY2guY29sdW1ucyA9IG5ldyBOZXRTdWl0ZS5TZWFyY2guQ3VzdG9tZXJTZWFyY2hSb3coKTtcclxuICAgICAgICAgIHNlYXJjaC5jb2x1bW5zLmJhc2ljID0gbmV3IE5ldFN1aXRlLlNlYXJjaC5DdXN0b21lclNlYXJjaFJvd0Jhc2ljKCk7XHJcblxyXG4gICAgICAgICAgLy8gRm9yIG5vdywgYWx3YXlzIGluY2x1ZGUgYWxsIFNlYXJjaENvbHVtbiBmaWVsZHMgc2luY2Ugc3RvcmluZyBhbiBleHRyYSBmaWVsZFxyXG4gICAgICAgICAgLy8gaXMgZmFyIGxlc3MgY29zdGx5IHRoYW4gaGF2aW5nIHRvIGRvIGFub3RoZXIgcm91bmR0cmlwIHRvIHJldHJpZXZlIGFub3RoZXIgZmllbGRcclxuICAgICAgICAgIHZhciBlbnRpdHlJZEZpZWxkID0gbmV3IE5ldFN1aXRlLlNlYXJjaC5GaWVsZHMuU2VhcmNoQ29sdW1uU3RyaW5nRmllbGQoKTtcclxuICAgICAgICAgIGVudGl0eUlkRmllbGQuZmllbGQgPSAnZW50aXR5SWQnO1xyXG4gICAgICAgICAgc2VhcmNoLmNvbHVtbnMuYmFzaWMuc2VhcmNoQ29sdW1uRmllbGRzLnB1c2goZW50aXR5SWRGaWVsZCk7XHJcblxyXG4gICAgICAgICAgdmFyIGludGVybmFsSWRGaWVsZCA9IG5ldyBOZXRTdWl0ZS5TZWFyY2guRmllbGRzLlNlYXJjaENvbHVtblNlbGVjdEZpZWxkKCk7XHJcbiAgICAgICAgICBpbnRlcm5hbElkRmllbGQuZmllbGQgPSAnaW50ZXJuYWxJZCc7XHJcbiAgICAgICAgICBzZWFyY2guY29sdW1ucy5iYXNpYy5zZWFyY2hDb2x1bW5GaWVsZHMucHVzaChpbnRlcm5hbElkRmllbGQpO1xyXG5cclxuICAgICAgICAgIHZhciBiYWxhbmNlRmllbGQgPSBuZXcgTmV0U3VpdGUuU2VhcmNoLkZpZWxkcy5TZWFyY2hDb2x1bW5Eb3VibGVGaWVsZCgpO1xyXG4gICAgICAgICAgYmFsYW5jZUZpZWxkLmZpZWxkID0gJ2JhbGFuY2UnO1xyXG4gICAgICAgICAgc2VhcmNoLmNvbHVtbnMuYmFzaWMuc2VhcmNoQ29sdW1uRmllbGRzLnB1c2goYmFsYW5jZUZpZWxkKTtcclxuXHJcbiAgICAgICAgICB2YXIgb3ZlcmR1ZUJhbGFuY2VGaWVsZCA9IG5ldyBOZXRTdWl0ZS5TZWFyY2guRmllbGRzLlNlYXJjaENvbHVtbkRvdWJsZUZpZWxkKCk7XHJcbiAgICAgICAgICBvdmVyZHVlQmFsYW5jZUZpZWxkLmZpZWxkID0gJ292ZXJkdWVCYWxhbmNlJztcclxuICAgICAgICAgIHNlYXJjaC5jb2x1bW5zLmJhc2ljLnNlYXJjaENvbHVtbkZpZWxkcy5wdXNoKG92ZXJkdWVCYWxhbmNlRmllbGQpO1xyXG5cclxuICAgICAgICAgIHZhciBkYXlzT3ZlcmR1ZUZpZWxkID0gbmV3IE5ldFN1aXRlLlNlYXJjaC5GaWVsZHMuU2VhcmNoQ29sdW1uTG9uZ0ZpZWxkKCk7XHJcbiAgICAgICAgICBkYXlzT3ZlcmR1ZUZpZWxkLmZpZWxkID0gJ2RheXNPdmVyZHVlJztcclxuICAgICAgICAgIHNlYXJjaC5jb2x1bW5zLmJhc2ljLnNlYXJjaENvbHVtbkZpZWxkcy5wdXNoKGRheXNPdmVyZHVlRmllbGQpO1xyXG5cclxuICAgICAgICAgIHJldHVybiBfdGhpcy5fc2VydmljZS5zZWFyY2goc2VhcmNoKVxyXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcclxuICAgICAgICAgICAgICBpZiAocmVzdWx0LnNlYXJjaFJlc3VsdC50b3RhbFBhZ2VzID4gMSkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuX3NlYXJjaElkc1tmaWVsZC5leHRJZF0gPSByZXN1bHQuc2VhcmNoUmVzdWx0LnNlYXJjaElkO1xyXG4gICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgdmFyIGRhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBjb3VudDogcmVzdWx0LnNlYXJjaFJlc3VsdC50b3RhbFJlY29yZHMsXHJcbiAgICAgICAgICAgICAgICByZXN1bHRzOiByZXN1bHQuc2VhcmNoUmVzdWx0LnNlYXJjaFJvd0xpc3Quc2VhcmNoUm93XHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICBfdGhpcy5fc2V0Q2FjaGVWYWx1ZShmaWVsZCwgcHJlZmVyZW5jZXMucGFnZVNpemUsIHF1ZXJ5LnNraXAsIGRhdGEpO1xyXG4gICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKGRhdGEpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHJlamVjdChuZXcgRXJyb3IoJ1Vua25vd24gRVhUX0VOVElUWSBlbnRpdHlUeXBlOicsIGZpZWxkLmVudGl0eVR5cGUpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH0pO1xyXG59O1xyXG4iXX0=
//# sourceMappingURL=index.js.map
