'use strict';

var _Promise = require('babel-runtime/core-js/promise')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _util = require('util');

var _util2 = _interopRequireDefault(_util);

var _baseAdapter = require('../base/Adapter');

var _baseAdapter2 = _interopRequireDefault(_baseAdapter);

var _fields = require('../fields');

var _fields2 = _interopRequireDefault(_fields);

var _netsuiteJs = require('netsuite-js');

var _netsuiteJs2 = _interopRequireDefault(_netsuiteJs);

var implementedFields = {};
implementedFields[_fields2['default'].Types.USER] = {
  'department#internalId': true,
  'supervisor#internalId': true
};
implementedFields[_fields2['default'].Types.EXT_ENTITY] = {
  'customer#balance': true,
  'customer#overdueBalance': true,
  'customer#daysOverdue': true
};

/**
 * NetSuiteAdapter
 *
 * `credentials` format:
 * ```
 * {
 *   email: 'test@test.com',
 *   password: 'password',
 *   account: 123456,
 *   role: 3
 * }
 * ```
 * @class
 * @return {NetSuiteAdapter}
 */
var NetSuiteAdapter = module.exports = function NetSuiteAdapter() {
  _baseAdapter2['default'].call(this);

  /**
   * @override
   */
  Object.defineProperty(this, 'extEntityKey', {
    get: function get() {
      return this.credentials.account;
    }
  });

  // SearchId cache, one per field
  this._searchIds = {};

  // Cache results by field type -> limit (pagesize) -> skip, e.g.:
  // this._cachedDataByFieldType[Fields.Types.USER][10][3]
  // represents all user records for search page size 10 starting at index 3.
  // EXT_ENTITY fields are have an additional layer for entityType, e.g.:
  // this._cachedDataByFieldType[Fields.Types.EXT_ENTITY]['customer'][10][3]
  this._cachedDataByFieldType = {};
};

_util2['default'].inherits(NetSuiteAdapter, _baseAdapter2['default']);

/**
 * @override
 */
NetSuiteAdapter.prototype.init = function () {
  var _this = this;
  this._config = new _netsuiteJs2['default'].Configuration(this.credentials);
  this._service = new _netsuiteJs2['default'].Service(this._config);
  return this._service.init().then(function () /*client*/{
    var msg = 'Successfully initialized NetSuiteAdapter for email: %s, account: %s, role: %d';
    console.log(msg, _this.credentials.email, _this.credentials.account, _this.credentials.role);
    return _this;
  });
};

/**
 * @override
 */
NetSuiteAdapter.prototype.reset = function () {
  this._searchIds = {};
  this._cachedDataByFieldType = {};
  delete this._config;
  delete this._service;
};

NetSuiteAdapter.prototype._setCacheValue = function (field, limit, skip, data) {
  var fieldCache = this._cachedDataByFieldType[field.type] = this._cachedDataByFieldType[field.type] || {};

  if (field.type === _fields2['default'].Types.EXT_ENTITY) {
    fieldCache = this._cachedDataByFieldType[field.type][field.entityType] = this._cachedDataByFieldType[field.type][field.entityType] || {};
  }

  fieldCache[limit] = fieldCache[limit] || {};
  fieldCache[limit][skip] = _lodash2['default'].cloneDeep(data);
};

NetSuiteAdapter.prototype._getCacheValue = function (field, limit, skip) {
  var fieldCache = this._cachedDataByFieldType[field.type];
  if (!fieldCache) {
    return undefined;
  }

  if (field.type === _fields2['default'].Types.EXT_ENTITY) {
    fieldCache = fieldCache[field.entityType];
  }
  return fieldCache && fieldCache[limit] && fieldCache[limit][skip];
};

/**
 * @override
 */
NetSuiteAdapter.prototype.getFieldData = function (field, query) {
  console.log(field);
  var _this = this;
  return new _Promise(function (resolve, reject) {
    query = query || {};

    var preferences = new _netsuiteJs2['default'].Search.SearchPreferences();
    preferences.pageSize = query.limit || 10;
    _this._service.setSearchPreferences(preferences);

    if (!implementedFields[field.type] || !implementedFields[field.type][field.extId]) {
      return reject(new Error('Unknown field or retrieval NYI by NetSuiteAdapter:', field));
    }

    // Cache hit?
    var cached = _this._getCacheValue(field, preferences.pageSize, query.skip);
    if (cached) {
      return resolve(cached);
    }

    var pageIndex, search;
    if (field.type === _fields2['default'].Types.USER) {
      if (query.skip) {
        if (!_this._searchIds[field.extId]) {
          throw new Error('NetSuite paged searches must start with an initial search to generate a search session');
        }
        // Round down then add 1 since netsuite page indices are one-based
        pageIndex = Math.floor(query.skip / preferences.pageSize) + 1;
        console.log('searchMoreWithId with pageIndex "%d"', pageIndex);
        return _this._service.searchMoreWithId(_this._searchIds[field.extId], pageIndex).then(function (result) {
          var data = {
            count: result.searchResult.totalRecords,
            results: result.searchResult.recordList.record
          };
          _this._setCacheValue(field, preferences.pageSize, query.skip, data);
          return resolve(data);
        });
      } else {
        // No criteria right now
        search = new _netsuiteJs2['default'].Search.EmployeeSearchBasic();
        return _this._service.search(search).then(function (result) {
          if (result.searchResult.totalPages > 1) {
            _this._searchIds[field.extId] = result.searchResult.searchId;
          }

          var data = {
            count: result.searchResult.totalRecords,
            results: result.searchResult.recordList.record
          };
          _this._setCacheValue(field, preferences.pageSize, query.skip, data);
          return resolve(data);
        });
      }
    } else if (field.type === _fields2['default'].Types.EXT_ENTITY) {
      if (field.entityType === 'customer') {
        if (query.skip) {
          if (!_this._searchIds[field.extId]) {
            throw new Error('NetSuite paged searches must start with an initial search to generate a search session');
          }
          // Round down then add 1 since netsuite page indices are one-based
          pageIndex = Math.floor(query.skip / preferences.pageSize) + 1;
          console.log('searchMoreWithId with pageIndex "%d"', pageIndex);
          return _this._service.searchMoreWithId(_this._searchIds[field.extId], pageIndex).then(function (result) {
            var data = {
              count: result.searchResult.totalRecords,
              results: result.searchResult.searchRowList.searchRow
            };
            _this._setCacheValue(field, preferences.pageSize, query.skip, data);
            return resolve(data);
          });
        } else {
          // No criteria right now
          search = new _netsuiteJs2['default'].Search.CustomerSearchAdvanced();
          search.columns = new _netsuiteJs2['default'].Search.CustomerSearchRow();
          search.columns.basic = new _netsuiteJs2['default'].Search.CustomerSearchRowBasic();

          // For now, always include all SearchColumn fields since storing an extra field
          // is far less costly than having to do another roundtrip to retrieve another field
          var entityIdField = new _netsuiteJs2['default'].Search.Fields.SearchColumnStringField();
          entityIdField.field = 'entityId';
          search.columns.basic.searchColumnFields.push(entityIdField);

          var internalIdField = new _netsuiteJs2['default'].Search.Fields.SearchColumnSelectField();
          internalIdField.field = 'internalId';
          search.columns.basic.searchColumnFields.push(internalIdField);

          var balanceField = new _netsuiteJs2['default'].Search.Fields.SearchColumnDoubleField();
          balanceField.field = 'balance';
          search.columns.basic.searchColumnFields.push(balanceField);

          var overdueBalanceField = new _netsuiteJs2['default'].Search.Fields.SearchColumnDoubleField();
          overdueBalanceField.field = 'overdueBalance';
          search.columns.basic.searchColumnFields.push(overdueBalanceField);

          var daysOverdueField = new _netsuiteJs2['default'].Search.Fields.SearchColumnLongField();
          daysOverdueField.field = 'daysOverdue';
          search.columns.basic.searchColumnFields.push(daysOverdueField);

          return _this._service.search(search).then(function (result) {
            if (result.searchResult.totalPages > 1) {
              _this._searchIds[field.extId] = result.searchResult.searchId;
            }

            var data = {
              count: result.searchResult.totalRecords,
              results: result.searchResult.searchRowList.searchRow
            };
            _this._setCacheValue(field, preferences.pageSize, query.skip, data);
            return resolve(data);
          });
        }
      } else {
        return reject(new Error('Unknown EXT_ENTITY entityType:', field.entityType));
      }
    }
  });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsQWRhcHRlcnMvbmV0c3VpdGUvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O3NCQUFjLFFBQVE7Ozs7b0JBQ0wsTUFBTTs7OzsyQkFDQyxpQkFBaUI7Ozs7c0JBQ3RCLFdBQVc7Ozs7MEJBQ1QsYUFBYTs7OztBQUVsQyxJQUFJLGlCQUFpQixHQUFHLEVBQUUsQ0FBQztBQUMzQixpQkFBaUIsQ0FBQyxvQkFBTyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUc7QUFDckMseUJBQXVCLEVBQUUsSUFBSTtBQUM3Qix5QkFBdUIsRUFBRSxJQUFJO0NBQzlCLENBQUM7QUFDRixpQkFBaUIsQ0FBQyxvQkFBTyxLQUFLLENBQUMsVUFBVSxDQUFDLEdBQUc7QUFDM0Msb0JBQWtCLEVBQUUsSUFBSTtBQUN4QiwyQkFBeUIsRUFBRSxJQUFJO0FBQy9CLHdCQUFzQixFQUFFLElBQUk7Q0FDN0IsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQkYsSUFBSSxlQUFlLEdBQUcsTUFBTSxDQUFDLE9BQU8sR0FBRyxTQUFTLGVBQWUsR0FBRztBQUNoRSwyQkFBWSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Ozs7O0FBS3ZCLFFBQU0sQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRTtBQUMxQyxPQUFHLEVBQUUsZUFBVztBQUNkLGFBQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUM7S0FDakM7R0FDRixDQUFDLENBQUM7OztBQUdILE1BQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDOzs7Ozs7O0FBT3JCLE1BQUksQ0FBQyxzQkFBc0IsR0FBRyxFQUFFLENBQUM7Q0FDbEMsQ0FBQzs7QUFFRixrQkFBSyxRQUFRLENBQUMsZUFBZSwyQkFBYyxDQUFDOzs7OztBQUs1QyxlQUFlLENBQUMsU0FBUyxDQUFDLElBQUksR0FBRyxZQUFXO0FBQzFDLE1BQUksS0FBSyxHQUFHLElBQUksQ0FBQztBQUNqQixNQUFJLENBQUMsT0FBTyxHQUFHLElB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QUFTLE1BQU0sQ0FBQyxNQUFNLENBQUMscUJBQXFCLEVBQUUsQ0FBQztBQUMxRSwwQkFBZ0IsQ0FBQyxLQUFLLEdBQUcsYUFBYSxDQUFDO0FBQ3ZDLGdCQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQzs7QUFFL0QsaUJBQU8sS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQ2pDLElBQUksQ0FBQyxVQUFTLE1BQU0sRUFBRTtBQUNyQixnQkFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLFVBQVUsR0FBRyxDQUFDLEVBQUU7QUFDdEMsbUJBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDO2FBQzlEOztBQUVELGdCQUFJLElBQUksR0FBRztBQUNULG1CQUFLLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxZQUFZO0FBQ3ZDLHFCQUFPLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsU0FBUzthQUNyRCxDQUFDO0FBQ0YsaUJBQUssQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztBQUNwRSxtQkFBTyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7V0FDdEIsQ0FBQyxDQUFDO1NBQ047T0FDRixNQUFNO0FBQ0wsZUFBTyxNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsZ0NBQWdDLEVBQUUsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7T0FDOUU7S0FDRjtHQUNGLENBQUMsQ0FBQztDQUNKLENBQUMiLCJmaWxlIjoiY2xBZGFwdGVycy9uZXRzdWl0ZS9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgdXRpbCBmcm9tICd1dGlsJztcbmltcG9ydCBCYXNlQWRhcHRlciBmcm9tICcuLi9iYXNlL0FkYXB0ZXInO1xuaW1wb3J0IEZpZWxkcyBmcm9tICcuLi9maWVsZHMnO1xuaW1wb3J0IE5ldFN1aXRlIGZyb20gJ25ldHN1aXRlLWpzJztcblxudmFyIGltcGxlbWVudGVkRmllbGRzID0ge307XG5pbXBsZW1lbnRlZEZpZWxkc1tGaWVsZHMuVHlwZXMuVVNFUl0gPSB7XG4gICdkZXBhcnRtZW50I2ludGVybmFsSWQnOiB0cnVlLFxuICAnc3VwZXJ2aXNvciNpbnRlcm5hbElkJzogdHJ1ZVxufTtcbmltcGxlbWVudGVkRmllbGRzW0ZpZWxkcy5UeXBlcy5FWFRfRU5USVRZXSA9IHtcbiAgJ2N1c3RvbWVyI2JhbGFuY2UnOiB0cnVlLFxuICAnY3VzdG9tZXIjb3ZlcmR1ZUJhbGFuY2UnOiB0cnVlLFxuICAnY3VzdG9tZXIjZGF5c092ZXJkdWUnOiB0cnVlXG59O1xuXG4vKipcbiAqIE5ldFN1aXRlQWRhcHRlclxuICpcbiAqIGBjcmVkZW50aWFsc2AgZm9ybWF0OlxuICogYGBgXG4gKiB7XG4gKiAgIGVtYWlsOiAndGVzdEB0ZXN0LmNvbScsXG4gKiAgIHBhc3N3b3JkOiAncGFzc3dvcmQnLFxuICogICBhY2NvdW50OiAxMjM0NTYsXG4gKiAgIHJvbGU6IDNcbiAqIH1cbiAqIGBgYFxuICogQGNsYXNzXG4gKiBAcmV0dXJuIHtOZXRTdWl0ZUFkYXB0ZXJ9XG4gKi9cbnZhciBOZXRTdWl0ZUFkYXB0ZXIgPSBtb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uIE5ldFN1aXRlQWRhcHRlcigpIHtcbiAgQmFzZUFkYXB0ZXIuY2FsbCh0aGlzKTtcblxuICAvKipcbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgJ2V4dEVudGl0eUtleScsIHtcbiAgICBnZXQ6IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIHRoaXMuY3JlZGVudGlhbHMuYWNjb3VudDtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIFNlYXJjaElkIGNhY2hlLCBvbmUgcGVyIGZpZWxkXG4gIHRoaXMuX3NlYXJjaElkcyA9IHt9O1xuXG4gIC8vIENhY2hlIHJlc3VsdHMgYnkgZmllbGQgdHlwZSAtPiBsaW1pdCAocGFnZXNpemUpIC0+IHNraXAsIGUuZy46XG4gIC8vIHRoaXMuX2NhY2hlZERhdGFCeUZpZWxkVHlwZVtGaWVsZHMuVHlwZXMuVVNFUl1bMTBdWzNdXG4gIC8vIHJlcHJlc2VudHMgYWxsIHVzZXIgcmVjb3JkcyBmb3Igc2VhcmNoIHBhZ2Ugc2l6ZSAxMCBzdGFydGluZyBhdCBpbmRleCAzLlxuICAvLyBFWFRfRU5USVRZIGZpZWxkcyBhcmUgaGF2ZSBhbiBhZGRpdGlvbmFsIGxheWVyIGZvciBlbnRpdHlUeXBlLCBlLmcuOlxuICAvLyB0aGlzLl9jYWNoZWREYXRhQnlGaWVsZFR5cGVbRmllbGRzLlR5cGVzLkVYVF9FTlRJVFldWydjdXN0b21lciddWzEwXVszXVxuICB0aGlzLl9jYWNoZWREYXRhQnlGaWVsZFR5cGUgPSB7fTtcbn07XG5cbnV0aWwuaW5oZXJpdHMoTmV0U3VpdGVBZGFwdGVyLCBCYXNlQWRhcHRlcik7XG5cbi8qKlxuICogQG92ZXJyaWRlXG4gKi9cbk5ldFN1aXRlQWRhcHRlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKCkge1xuICB2YXIgX3RoaXMgPSB0aGlzO1xuICB0aGlzLl9jb25maWcgPSBuZXcgTmV0U3VpdGUuQ29uZmlndXJhdGlvbih0aGlzLmNyZWRlbnRpYWxzKTtcbiAgdGhpcy5fc2VydmljZSA9IG5ldyBOZXRTdWl0ZS5TZXJ2aWNlKHRoaXMuX2NvbmZpZyk7XG4gIHJldHVybiB0aGlzLl9zZXJ2aWNlXG4gICAgLmluaXQoKVxuICAgIC50aGVuKGZ1bmN0aW9uKCAvKmNsaWVudCovICkge1xuICAgICAgdmFyIG1zZyA9ICdTdWNjZXNzZnVsbHkgaW5pdGlhbGl6ZWQgTmV0U3VpdGVBZGFwdGVyIGZvciBlbWFpbDogJXMsIGFjY291bnQ6ICVzLCByb2xlOiAlZCc7XG4gICAgICBjb25zb2xlLmxvZyhtc2csIF90aGlzLmNyZWRlbnRpYWxzLmVtYWlsLCBfdGhpcy5jcmVkZW50aWFscy5hY2NvdW50LCBfdGhpcy5jcmVkZW50aWFscy5yb2xlKTtcbiAgICAgIHJldHVybiBfdGhpcztcbiAgICB9KTtcbn07XG5cbi8qKlxuICogQG92ZXJyaWRlXG4gKi9cbk5ldFN1aXRlQWRhcHRlci5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbigpIHtcbiAgdGhpcy5fc2VhcmNoSWRzID0ge307XG4gIHRoaXMuX2NhY2hlZERhdGFCeUZpZWxkVHlwZSA9IHt9O1xuICBkZWxldGUgdGhpcy5fY29uZmlnO1xuICBkZWxldGUgdGhpcy5fc2VydmljZTtcbn07XG5cbk5ldFN1aXRlQWRhcHRlci5wcm90b3R5cGUuX3NldENhY2hlVmFsdWUgPSBmdW5jdGlvbihmaWVsZCwgbGltaXQsIHNraXAsIGRhdGEpIHtcbiAgdmFyIGZpZWxkQ2FjaGUgPSB0aGlzLl9jYWNoZWREYXRhQnlGaWVsZFR5cGVbZmllbGQudHlwZV0gPSB0aGlzLl9jYWNoZWREYXRhQnlGaWVsZFR5cGVbZmllbGQudHlwZV0gfHwge307XG5cbiAgaWYgKGZpZWxkLnR5cGUgPT09IEZpZWxkcy5UeXBlcy5FWFRfRU5USVRZKSB7XG4gICAgZmllbGRDYWNoZSA9IHRoaXMuX2NhY2hlZERhdGFCeUZpZWxkVHlwZVtmaWVsZC50eXBlXVtmaWVsZC5lbnRpdHlUeXBlXSA9IHRoaXMuX2NhY2hlZERhdGFCeUZpZWxkVHlwZVtmaWVsZC50eXBlXVtmaWVsZC5lbnRpdHlUeXBlXSB8fCB7fTtcbiAgfVxuXG4gIGZpZWxkQ2FjaGVbbGltaXRdID0gZmllbGRDYWNoZVtsaW1pdF0gfHwge307XG4gIGZpZWxkQ2FjaGVbbGltaXRdW3NraXBdID0gXy5jbG9uZURlZXAoZGF0YSk7XG59O1xuXG5OZXRTdWl0ZUFkYXB0ZXIucHJvdG90eXBlLl9nZXRDYWNoZVZhbHVlID0gZnVuY3Rpb24oZmllbGQsIGxpbWl0LCBza2lwKSB7XG4gIHZhciBmaWVsZENhY2hlID0gdGhpcy5fY2FjaGVkRGF0YUJ5RmllbGRUeXBlW2ZpZWxkLnR5cGVdO1xuICBpZiAoIWZpZWxkQ2FjaGUpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgaWYgKGZpZWxkLnR5cGUgPT09IEZpZWxkcy5UeXBlcy5FWFRfRU5USVRZKSB7XG4gICAgZmllbGRDYWNoZSA9IGZpZWxkQ2FjaGVbZmllbGQuZW50aXR5VHlwZV07XG4gIH1cbiAgcmV0dXJuIGZpZWxkQ2FjaGUgJiZcbiAgICBmaWVsZENhY2hlW2xpbWl0XSAmJlxuICAgIGZpZWxkQ2FjaGVbbGltaXRdW3NraXBdO1xufTtcblxuLyoqXG4gKiBAb3ZlcnJpZGVcbiAqL1xuTmV0U3VpdGVBZGFwdGVyLnByb3RvdHlwZS5nZXRGaWVsZERhdGEgPSBmdW5jdGlvbihmaWVsZCwgcXVlcnkpIHtcbiAgY29uc29sZS5sb2coZmllbGQpO1xuICB2YXIgX3RoaXMgPSB0aGlzO1xuICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgcXVlcnkgPSBxdWVyeSB8fCB7fTtcblxuICAgIHZhciBwcmVmZXJlbmNlcyA9IG5ldyBOZXRTdWl0ZS5TZWFyY2guU2VhcmNoUHJlZmVyZW5jZXMoKTtcbiAgICBwcmVmZXJlbmNlcy5wYWdlU2l6ZSA9IHF1ZXJ5LmxpbWl0IHx8IDEwO1xuICAgIF90aGlzLl9zZXJ2aWNlLnNldFNlYXJjaFByZWZlcmVuY2VzKHByZWZlcmVuY2VzKTtcblxuICAgIGlmICghaW1wbGVtZW50ZWRGaWVsZHNbZmllbGQudHlwZV0gfHwgIWltcGxlbWVudGVkRmllbGRzW2ZpZWxkLnR5cGVdW2ZpZWxkLmV4dElkXSkge1xuICAgICAgcmV0dXJuIHJlamVjdChuZXcgRXJyb3IoJ1Vua25vd24gZmllbGQgb3IgcmV0cmlldmFsIE5ZSSBieSBOZXRTdWl0ZUFkYXB0ZXI6JywgZmllbGQpKTtcbiAgICB9XG5cbiAgICAvLyBDYWNoZSBoaXQ/XG4gICAgdmFyIGNhY2hlZCA9IF90aGlzLl9nZXRDYWNoZVZhbHVlKGZpZWxkLCBwcmVmZXJlbmNlcy5wYWdlU2l6ZSwgcXVlcnkuc2tpcCk7XG4gICAgaWYgKGNhY2hlZCkge1xuICAgICAgcmV0dXJuIHJlc29sdmUoY2FjaGVkKTtcbiAgICB9XG5cbiAgICB2YXIgcGFnZUluZGV4LCBzZWFyY2g7XG4gICAgaWYgKGZpZWxkLnR5cGUgPT09IEZpZWxkcy5UeXBlcy5VU0VSKSB7XG4gICAgICBpZiAocXVlcnkuc2tpcCkge1xuICAgICAgICBpZiAoIV90aGlzLl9zZWFyY2hJZHNbZmllbGQuZXh0SWRdKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdOZXRTdWl0ZSBwYWdlZCBzZWFyY2hlcyBtdXN0IHN0YXJ0IHdpdGggYW4gaW5pdGlhbCBzZWFyY2ggdG8gZ2VuZXJhdGUgYSBzZWFyY2ggc2Vzc2lvbicpO1xuICAgICAgICB9XG4gICAgICAgIC8vIFJvdW5kIGRvd24gdGhlbiBhZGQgMSBzaW5jZSBuZXRzdWl0ZSBwYWdlIGluZGljZXMgYXJlIG9uZS1iYXNlZFxuICAgICAgICBwYWdlSW5kZXggPSBNYXRoLmZsb29yKHF1ZXJ5LnNraXAgLyBwcmVmZXJlbmNlcy5wYWdlU2l6ZSkgKyAxO1xuICAgICAgICBjb25zb2xlLmxvZygnc2VhcmNoTW9yZVdpdGhJZCB3aXRoIHBhZ2VJbmRleCBcIiVkXCInLCBwYWdlSW5kZXgpO1xuICAgICAgICByZXR1cm4gX3RoaXMuX3NlcnZpY2Uuc2VhcmNoTW9yZVdpdGhJZChfdGhpcy5fc2VhcmNoSWRzW2ZpZWxkLmV4dElkXSwgcGFnZUluZGV4KVxuICAgICAgICAgIC50aGVuKGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgdmFyIGRhdGEgPSB7XG4gICAgICAgICAgICAgIGNvdW50OiByZXN1bHQuc2VhcmNoUmVzdWx0LnRvdGFsUmVjb3JkcyxcbiAgICAgICAgICAgICAgcmVzdWx0czogcmVzdWx0LnNlYXJjaFJlc3VsdC5yZWNvcmRMaXN0LnJlY29yZFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIF90aGlzLl9zZXRDYWNoZVZhbHVlKGZpZWxkLCBwcmVmZXJlbmNlcy5wYWdlU2l6ZSwgcXVlcnkuc2tpcCwgZGF0YSk7XG4gICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhKTtcbiAgICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIE5vIGNyaXRlcmlhIHJpZ2h0IG5vd1xuICAgICAgICBzZWFyY2ggPSBuZXcgTmV0U3VpdGUuU2VhcmNoLkVtcGxveWVlU2VhcmNoQmFzaWMoKTtcbiAgICAgICAgcmV0dXJuIF90aGlzLl9zZXJ2aWNlLnNlYXJjaChzZWFyY2gpXG4gICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICBpZiAocmVzdWx0LnNlYXJjaFJlc3VsdC50b3RhbFBhZ2VzID4gMSkge1xuICAgICAgICAgICAgICBfdGhpcy5fc2VhcmNoSWRzW2ZpZWxkLmV4dElkXSA9IHJlc3VsdC5zZWFyY2hSZXN1bHQuc2VhcmNoSWQ7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciBkYXRhID0ge1xuICAgICAgICAgICAgICBjb3VudDogcmVzdWx0LnNlYXJjaFJlc3VsdC50b3RhbFJlY29yZHMsXG4gICAgICAgICAgICAgIHJlc3VsdHM6IHJlc3VsdC5zZWFyY2hSZXN1bHQucmVjb3JkTGlzdC5yZWNvcmRcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBfdGhpcy5fc2V0Q2FjaGVWYWx1ZShmaWVsZCwgcHJlZmVyZW5jZXMucGFnZVNpemUsIHF1ZXJ5LnNraXAsIGRhdGEpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUoZGF0YSk7XG4gICAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChmaWVsZC50eXBlID09PSBGaWVsZHMuVHlwZXMuRVhUX0VOVElUWSkge1xuICAgICAgaWYgKGZpZWxkLmVudGl0eVR5cGUgPT09ICdjdXN0b21lcicpIHtcbiAgICAgICAgaWYgKHF1ZXJ5LnNraXApIHtcbiAgICAgICAgICBpZiAoIV90aGlzLl9zZWFyY2hJZHNbZmllbGQuZXh0SWRdKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05ldFN1aXRlIHBhZ2VkIHNlYXJjaGVzIG11c3Qgc3RhcnQgd2l0aCBhbiBpbml0aWFsIHNlYXJjaCB0byBnZW5lcmF0ZSBhIHNlYXJjaCBzZXNzaW9uJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIFJvdW5kIGRvd24gdGhlbiBhZGQgMSBzaW5jZSBuZXRzdWl0ZSBwYWdlIGluZGljZXMgYXJlIG9uZS1iYXNlZFxuICAgICAgICAgIHBhZ2VJbmRleCA9IE1hdGguZmxvb3IocXVlcnkuc2tpcCAvIHByZWZlcmVuY2VzLnBhZ2VTaXplKSArIDE7XG4gICAgICAgICAgY29uc29sZS5sb2coJ3NlYXJjaE1vcmVXaXRoSWQgd2l0aCBwYWdlSW5kZXggXCIlZFwiJywgcGFnZUluZGV4KTtcbiAgICAgICAgICByZXR1cm4gX3RoaXMuX3NlcnZpY2Uuc2VhcmNoTW9yZVdpdGhJZChfdGhpcy5fc2VhcmNoSWRzW2ZpZWxkLmV4dElkXSwgcGFnZUluZGV4KVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICAgIHZhciBkYXRhID0ge1xuICAgICAgICAgICAgICAgIGNvdW50OiByZXN1bHQuc2VhcmNoUmVzdWx0LnRvdGFsUmVjb3JkcyxcbiAgICAgICAgICAgICAgICByZXN1bHRzOiByZXN1bHQuc2VhcmNoUmVzdWx0LnNlYXJjaFJvd0xpc3Quc2VhcmNoUm93XG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgIF90aGlzLl9zZXRDYWNoZVZhbHVlKGZpZWxkLCBwcmVmZXJlbmNlcy5wYWdlU2l6ZSwgcXVlcnkuc2tpcCwgZGF0YSk7XG4gICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKGRhdGEpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gTm8gY3JpdGVyaWEgcmlnaHQgbm93XG4gICAgICAgICAgc2VhcmNoID0gbmV3IE5ldFN1aXRlLlNlYXJjaC5DdXN0b21lclNlYXJjaEFkdmFuY2VkKCk7XG4gICAgICAgICAgc2VhcmNoLmNvbHVtbnMgPSBuZXcgTmV0U3VpdGUuU2VhcmNoLkN1c3RvbWVyU2VhcmNoUm93KCk7XG4gICAgICAgICAgc2VhcmNoLmNvbHVtbnMuYmFzaWMgPSBuZXcgTmV0U3VpdGUuU2VhcmNoLkN1c3RvbWVyU2VhcmNoUm93QmFzaWMoKTtcblxuICAgICAgICAgIC8vIEZvciBub3csIGFsd2F5cyBpbmNsdWRlIGFsbCBTZWFyY2hDb2x1bW4gZmllbGRzIHNpbmNlIHN0b3JpbmcgYW4gZXh0cmEgZmllbGRcbiAgICAgICAgICAvLyBpcyBmYXIgbGVzcyBjb3N0bHkgdGhhbiBoYXZpbmcgdG8gZG8gYW5vdGhlciByb3VuZHRyaXAgdG8gcmV0cmlldmUgYW5vdGhlciBmaWVsZFxuICAgICAgICAgIHZhciBlbnRpdHlJZEZpZWxkID0gbmV3IE5ldFN1aXRlLlNlYXJjaC5GaWVsZHMuU2VhcmNoQ29sdW1uU3RyaW5nRmllbGQoKTtcbiAgICAgICAgICBlbnRpdHlJZEZpZWxkLmZpZWxkID0gJ2VudGl0eUlkJztcbiAgICAgICAgICBzZWFyY2guY29sdW1ucy5iYXNpYy5zZWFyY2hDb2x1bW5GaWVsZHMucHVzaChlbnRpdHlJZEZpZWxkKTtcblxuICAgICAgICAgIHZhciBpbnRlcm5hbElkRmllbGQgPSBuZXcgTmV0U3VpdGUuU2VhcmNoLkZpZWxkcy5TZWFyY2hDb2x1bW5TZWxlY3RGaWVsZCgpO1xuICAgICAgICAgIGludGVybmFsSWRGaWVsZC5maWVsZCA9ICdpbnRlcm5hbElkJztcbiAgICAgICAgICBzZWFyY2guY29sdW1ucy5iYXNpYy5zZWFyY2hDb2x1bW5GaWVsZHMucHVzaChpbnRlcm5hbElkRmllbGQpO1xuXG4gICAgICAgICAgdmFyIGJhbGFuY2VGaWVsZCA9IG5ldyBOZXRTdWl0ZS5TZWFyY2guRmllbGRzLlNlYXJjaENvbHVtbkRvdWJsZUZpZWxkKCk7XG4gICAgICAgICAgYmFsYW5jZUZpZWxkLmZpZWxkID0gJ2JhbGFuY2UnO1xuICAgICAgICAgIHNlYXJjaC5jb2x1bW5zLmJhc2ljLnNlYXJjaENvbHVtbkZpZWxkcy5wdXNoKGJhbGFuY2VGaWVsZCk7XG5cbiAgICAgICAgICB2YXIgb3ZlcmR1ZUJhbGFuY2VGaWVsZCA9IG5ldyBOZXRTdWl0ZS5TZWFyY2guRmllbGRzLlNlYXJjaENvbHVtbkRvdWJsZUZpZWxkKCk7XG4gICAgICAgICAgb3ZlcmR1ZUJhbGFuY2VGaWVsZC5maWVsZCA9ICdvdmVyZHVlQmFsYW5jZSc7XG4gICAgICAgICAgc2VhcmNoLmNvbHVtbnMuYmFzaWMuc2VhcmNoQ29sdW1uRmllbGRzLnB1c2gob3ZlcmR1ZUJhbGFuY2VGaWVsZCk7XG5cbiAgICAgICAgICB2YXIgZGF5c092ZXJkdWVGaWVsZCA9IG5ldyBOZXRTdWl0ZS5TZWFyY2guRmllbGRzLlNlYXJjaENvbHVtbkxvbmdGaWVsZCgpO1xuICAgICAgICAgIGRheXNPdmVyZHVlRmllbGQuZmllbGQgPSAnZGF5c092ZXJkdWUnO1xuICAgICAgICAgIHNlYXJjaC5jb2x1bW5zLmJhc2ljLnNlYXJjaENvbHVtbkZpZWxkcy5wdXNoKGRheXNPdmVyZHVlRmllbGQpO1xuXG4gICAgICAgICAgcmV0dXJuIF90aGlzLl9zZXJ2aWNlLnNlYXJjaChzZWFyY2gpXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdC5zZWFyY2hSZXN1bHQudG90YWxQYWdlcyA+IDEpIHtcbiAgICAgICAgICAgICAgICBfdGhpcy5fc2VhcmNoSWRzW2ZpZWxkLmV4dElkXSA9IHJlc3VsdC5zZWFyY2hSZXN1bHQuc2VhcmNoSWQ7XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICB2YXIgZGF0YSA9IHtcbiAgICAgICAgICAgICAgICBjb3VudDogcmVzdWx0LnNlYXJjaFJlc3VsdC50b3RhbFJlY29yZHMsXG4gICAgICAgICAgICAgICAgcmVzdWx0czogcmVzdWx0LnNlYXJjaFJlc3VsdC5zZWFyY2hSb3dMaXN0LnNlYXJjaFJvd1xuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICBfdGhpcy5fc2V0Q2FjaGVWYWx1ZShmaWVsZCwgcHJlZmVyZW5jZXMucGFnZVNpemUsIHF1ZXJ5LnNraXAsIGRhdGEpO1xuICAgICAgICAgICAgICByZXR1cm4gcmVzb2x2ZShkYXRhKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBFcnJvcignVW5rbm93biBFWFRfRU5USVRZIGVudGl0eVR5cGU6JywgZmllbGQuZW50aXR5VHlwZSkpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59O1xuIl19
//# sourceMappingURL=index.js.map
