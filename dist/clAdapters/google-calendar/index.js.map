{"version":3,"sources":["clAdapters/google-calendar/index.js"],"names":[],"mappings":"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","file":"clAdapters/google-calendar/index.js","sourcesContent":["import googleapis from 'googleapis';\nimport moment     from 'moment';\nimport { Adapter, Configuration, Service } from '../base/';\n\n// google calendar api\nconst calendar = googleapis.calendar('v3');\n\nconst credentialMappings = {\n  'certificate' : 'private_key',\n  'serviceEmail': 'client_email',\n  'email'       : 'adminEmail'\n}\n\n\nexport default class GoogleCalendarAdapter extends Adapter {\n\n  static Configuration = Configuration;\n  static Service = Service;\n\n\n  // constructor needs to call super\n  constructor() {\n    super();\n  }\n\n\n  reset() {\n    delete this._config;\n    delete this._service;\n    return this;\n  }\n\n\n  async init() {\n\n    const { credentials } = this;\n\n    if (!credentials) {\n      throw new Error('credentials required for adapter.');\n    }\n\n    // map Google json keys to keys used in this library\n    for (const want in credentialMappings) {\n      const alternate = credentialMappings[want];\n      if (!credentials[want]) {\n        credentials[want] = credentials[alternate];\n      }\n    }\n\n    // validate required credential properties\n    Object.keys(credentialMappings)\n      .forEach(prop => {\n        if (!credentials[prop]) {\n          throw new Error(`Property ${prop} required in adapter credentials!`);\n        }\n      });\n\n    this._config  = new GoogleCalendarAdapter.Configuration(credentials);\n    this._service = new GoogleCalendarAdapter.Service(this._config);\n\n    await this._service.init();\n\n    const { serviceEmail: email } = credentials;\n\n    console.log(\n      `Successfully initialized google calendar adapter for email: ${email}`\n    );\n\n    return this;\n  }\n\n\n  // currently doing nothing with fields here, but keeping as placeholder\n  async getBatchData(emails=[], filterStartDate, filterEndDate /*, fields */) {\n\n    // api options...\n    // https://developers.google.com/google-apps/calendar/v3/\n    const opts = {\n      alwaysIncludeEmail:   true,\n      calendarId:           'primary',\n      singleEvents:         true,\n      timeMax:              filterEndDate.toISOString(),\n      timeMin:              filterStartDate.toISOString(),\n      orderBy:              'startTime'\n    };\n\n\n    const groupRunStats = {\n      success: true,\n      runDate: moment().utc().toDate(),\n      filterStartDate: filterStartDate,\n      filterEndDate: filterEndDate,\n      emails: emails\n    };\n\n\n    try {\n\n      // collect events for this group of emails\n      const results = await* emails.map(async(email) => {\n\n        const individualRunStats = {\n          filterStartDate,\n          filterEndDate,\n          email,\n          success: true,\n          runDate: moment().utc().toDate()\n        };\n\n        try {\n          // add auth tokens to request\n          opts.auth = await this.authorize(email);\n\n          // function to recurse through pageTokens\n          const getEvents = async(data) => {\n\n            // request first results...\n            const results = await new Promise((res, rej) => {\n              // add page token if given\n              if (data && data.nextPageToken) {\n                opts.pageToken = data.nextPageToken;\n              }\n\n              calendar.events.list(\n                opts, (err, data) => err ? rej(err) : res(data)\n              );\n            });\n\n            // if we already have data being accumulated, add to items\n            if (data) {\n              data.items.push(...results.items);\n            } else {\n              data = results;\n            }\n\n            // if there is a token for the next page, continue...\n            if (results.nextPageToken) {\n              data.nextPageToken = results.nextPageToken;\n              return await getEvents(data);\n            }\n\n            return data;\n          };\n\n          const { items: data } = await getEvents();\n\n          // request all events for this user in the given time frame\n          return Object.assign(individualRunStats, { data });\n\n        } catch (error) {\n          // if the batch collection failed...\n          console.log('GoogleCalendarAdapter.getBatchData Error:', error.stack);\n\n          let errorMessage = error;\n\n          if (/invalid_grant/.test(errorMessage.toString())) {\n            errorMessage = `Email address: ${email} not found in this Google Calendar account.`;\n          }\n\n          return Object.assign(individualRunStats, {\n            errorMessage,\n            success: false,\n            data: []\n          });\n        }\n\n      });\n\n      return Object.assign(groupRunStats, { results });\n    } catch (error) {\n      return Object.assign(groupRunStats, {\n        errorMessage: error,\n        success: false\n      });\n    }\n\n  }\n\n\n  async runConnectionTest() {\n    const { credentials: { email } } = this;\n\n    try {\n      const data = await this.getBatchData(\n        [ email ],\n        moment().toDate(),\n        moment().add(-1, 'day').toDate()\n      )\n\n      return data;\n    } catch (error) {\n      console.log(error.stack || error);\n      return {\n        error,\n        success: false\n      }\n    }\n  }\n\n\n  async runMessageTest() {\n    // TODO: does this need to be different?\n    console.warn('Note: runMessageTest() currently calls runConnectionTest()');\n    return this.runConnectionTest();\n  }\n\n\n  // create authenticated token for api requests for given user\n  async authorize(email) {\n\n    const { credentials: { serviceEmail, certificate } } = this;\n\n    const auth = new googleapis.auth.JWT(\n      // email of google app admin...\n      serviceEmail,\n      // no need for keyFile...\n      null,\n      // the private key itself...\n      certificate,\n      // scopes...\n      ['https://www.googleapis.com/auth/calendar.readonly'],\n      // the email of the individual we want to authenticate\n      // ('sub' property of the json web token)\n      email\n    );\n\n    // await authorization\n    return new Promise((res, rej) => auth.authorize(err => {\n      err ? rej(err) : res(auth);\n    }));\n  }\n\n}\n"],"sourceRoot":"/source/"}