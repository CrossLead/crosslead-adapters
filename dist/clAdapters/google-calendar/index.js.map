{"version":3,"sources":["clAdapters/google-calendar/index.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;0BAAuB,YAAY;;;;sBACZ,QAAQ;;;;sBACR,QAAQ;;;;oBACiB,UAAU;;;AAG1D,IAAM,QAAQ,GAAG,wBAAW,QAAQ,CAAC,IAAI,CAAC,CAAC;;AAE3C,IAAM,kBAAkB,GAAG;AACzB,eAAa,EAAG,aAAa;AAC7B,gBAAc,EAAE,cAAc;AAC9B,SAAO,EAAS,YAAY;CAC7B,CAAA;;IAGoB,qBAAqB;YAArB,qBAAqB;;eAArB,qBAAqB;;;;;;;;;;;;WAMlB;;AAEpB,eAAS,EAA8B,IAAI;AAC3C,iBAAW,EAA4B,WAAW;AAClD,uBAAiB,EAAsB,SAAS;AAChD,4BAAsB,EAAiB,SAAS;AAChD,uBAAiB,EAAsB,sBAAsB;AAC7D,oBAAc,EAAyB,mBAAmB;AAC1D,eAAS,EAA8B,SAAS;AAChD,gBAAU,EAA6B,UAAU;AACjD,cAAQ,EAA+B,QAAQ;AAC/C,iBAAW,EAA4B,cAAc;AACrD,mBAAa,EAA0B,gBAAgB;AACvD,sBAAgB,EAAuB,iBAAiB;AACxD,kBAAY,EAA2B,YAAY;AACnD,sBAAgB,EAAuB,gBAAgB;AACvD,qBAAe,EAAwB,gBAAgB;AACvD,mBAAa,EAA0B,cAAc;AACrD,eAAS,EAA8B,SAAS;AAChD,WAAK,EAAkC,UAAU;AACjD,mBAAa,EAA0B,aAAa;KACrD;;;;;;AAGU,WA9BQ,qBAAqB,GA8B1B;0BA9BK,qBAAqB;;AA+BtC,+BA/BiB,qBAAqB,6CA+B9B;GACT;;eAhCkB,qBAAqB;;WAmCnC,iBAAG;AACN,aAAO,IAAI,CAAC,OAAO,CAAC;AACpB,aAAO,IAAI,CAAC,QAAQ,CAAC;AACrB,aAAO,IAAI,CAAC;KACb;;;WAGS;UAEA,WAAW,EAOR,IAAI,EACP,SAAS,EAmBK,KAAK;;;;AA3BnB,uBAAW,GAAK,IAAI,CAApB,WAAW;;gBAEd,WAAW;;;;;kBACR,IAAI,KAAK,CAAC,mCAAmC,CAAC;;;;;AAItD,iBAAW,IAAI,IAAI,kBAAkB,EAAE;AAC/B,uBAAS,GAAG,kBAAkB,CAAC,IAAI,CAAC;;AAC1C,kBAAI,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE;AACtB,2BAAW,CAAC,IAAI,CAAC,GAAG,WAAW,CAAC,SAAS,CAAC,CAAC;eAC5C;aACF;;;AAGD,yBAAY,kBAAkB,CAAC,CAC5B,OAAO,CAAC,UAAA,IAAI,EAAI;AACf,kBAAI,CAAC,WAAW,CAAC,IAAI,CAAC,EAAE;AACtB,sBAAM,IAAI,KAAK,eAAa,IAAI,uCAAoC,CAAC;eACtE;aACF,CAAC,CAAC;;AAEL,gBAAI,CAAC,OAAO,GAAI,IAAI,qBAAqB,CAAC,aAAa,CAAC,WAAW,CAAC,CAAC;AACrE,gBAAI,CAAC,QAAQ,GAAG,IAAI,qBAAqB,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;;;6CAE1D,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE;;;AAEJ,iBAAK,GAAK,WAAW,CAAnC,YAAY;;AAEpB,mBAAO,CAAC,GAAG,kEACsD,KAAK,CACrE,CAAC;;gDAEK,IAAI;;;;;;;KACZ;;;;;WAIiB,sBAAC,YAAY,EAAK,eAAe,EAAE,aAAa;UAA/C,YAAY,gBAAZ,YAAY,GAAC,EAAE;UAExB,YAAY,EAId,IAAI,EAUJ,aAAa,EAYX,OAAO;;;;;;AA1BP,wBAAY,GAAK,IAAI,CAAC,WAAW,CAAjC,YAAY;AAId,gBAAI,GAAG;AACX,gCAAkB,EAAI,IAAI;AAC1B,wBAAU,EAAY,SAAS;AAC/B,0BAAY,EAAU,IAAI;AAC1B,qBAAO,EAAe,aAAa,CAAC,WAAW,EAAE;AACjD,qBAAO,EAAe,eAAe,CAAC,WAAW,EAAE;AACnD,qBAAO,EAAe,WAAW;aAClC;AAGK,yBAAa,GAAG;AACpB,qBAAO,EAAE,IAAI;AACb,qBAAO,EAAE,0BAAQ,CAAC,GAAG,EAAE,CAAC,MAAM,EAAE;AAChC,6BAAe,EAAE,eAAe;AAChC,2BAAa,EAAE,aAAa;AAC5B,oBAAM,EAAE,YAAY;aACrB;;;0DAMwB,YAAY,CAAC,GAAG,CAAC,oBAAM,WAAW;kBAEjD,kBAAkB,QAmFlB,YAAY;;;;;;;AAnFZ,sCAAkB;AACtB,qCAAe,EAAf,eAAe;AACf,mCAAa,EAAb,aAAa;uBACV,WAAW;AACd,6BAAO,EAAE,IAAI;AACb,6BAAO,EAAE,0BAAQ,CAAC,GAAG,EAAE,CAAC,MAAM,EAAE;;;;;0BAQ1B,SAAS,QA8BP,KAAK,EAEP,IAAI;;;;;;;;6DAnCQ,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,iBAAiB,CAAC;;;AAA/D,gCAAI,CAAC,IAAI;;AAGH,qCAAS,GAAG,SAAZ,SAAS,CAAS,IAAI;kCAGpB,OAAO;;;;;;qEAAS,aAAY,UAAC,GAAG,EAAE,GAAG,EAAK;;AAE9C,0CAAI,IAAI,IAAI,IAAI,CAAC,aAAa,EAAE;AAC9B,4CAAI,CAAC,SAAS,GAAG,IAAI,CAAC,aAAa,CAAC;uCACrC;;AAED,8CAAQ,CAAC,MAAM,CAAC,IAAI,CAClB,IAAI,EAAE,UAAC,GAAG,EAAE,IAAI;+CAAK,GAAG,GAAG,GAAG,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC,IAAI,CAAC;uCAAA,CAChD,CAAC;qCACH,CAAC;;;AATI,2CAAO;;;AAYb,wCAAI,IAAI,EAAE;AACR,qDAAA,IAAI,CAAC,KAAK,EAAC,IAAI,MAAA,iCAAI,OAAO,CAAC,KAAK,EAAC,CAAC;qCACnC,MAAM;AACL,0CAAI,GAAG,OAAO,CAAC;qCAChB;;;;yCAGG,OAAO,CAAC,aAAa;;;;;AACvB,wCAAI,CAAC,aAAa,GAAG,OAAO,CAAC,aAAa,CAAC;;qEAC9B,SAAS,CAAC,IAAI,CAAC;;;;;;wEAGvB,IAAI;;;;;;;6BACZ;;;6DAEuB,SAAS,EAAE;;;;AAA3B,iCAAK,QAAL,KAAK;AAEP,gCAAI,GAAG,oBAAE,GAAG,CAAC,KAAK,EAAE,UAAA,IAAI,EAAI;;AAEhC,kCAAM,GAAG,GAAG,EAAE,CAAC;;AAEf,kDAAE,IAAI,CAAC,YAAY,EAAE,UAAC,IAAI,EAAE,IAAI,EAAK;AACnC,oCAAI,QAAQ,GAAG,oBAAE,GAAG,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;AACjC,oCAAI,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE;AAC1B,0CAAQ,GAAG,IAAI,IAAI,CAAC,QAAQ,CAAC,CAAC;iCAC/B;AACD,oCAAI,QAAQ,KAAK,SAAS,EAAE;AAC1B,qCAAG,CAAC,IAAI,CAAC,GAAG,QAAQ,CAAC;iCACtB;+BACF,CAAC,CAAC;;AAGH,kCAAM,YAAY,GAAG,oBAAE,IAAI,CAAC,GAAG,CAAC,SAAS,EAAE,UAAC,QAAQ,EAAK;AACvD,uCAAO,QAAQ,CAAC,IAAI,CAAC;+BACtB,CAAC,CAAC;;AAEH,kCAAI,YAAY,EAAE;AAChB,mCAAG,CAAC,cAAc,GAAG,YAAY,CAAC,cAAc,CAAC;+BAClD;;AAED,iCAAG,CAAC,SAAS,GAAG,oBAAE,GAAG,CAAC,GAAG,CAAC,SAAS,EAAE,UAAA,QAAQ,EAAI;oCACvC,KAAK,GAAqB,QAAQ,CAAlC,KAAK;oCAAE,cAAc,GAAK,QAAQ,CAA3B,cAAc;;AAC7B,uCAAO,EAAE,OAAO,EAAE,KAAK,EAAE,QAAQ,EAAE,cAAc,EAAE,CAAC;+BACrD,CAAC,CAAC;;AAEH,qCAAO,GAAG,CAAC;6BACZ,CAAC;;iCAGK,eAAc,kBAAkB,EAAE,EAAE,IAAI,EAAJ,IAAI,EAAE,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIlD,2BAAO,CAAC,GAAG,CAAC,2CAA2C,EAAE,eAAM,KAAK,CAAC,CAAC;;AAElE,gCAAY;;AAEhB,wBAAI,eAAe,CAAC,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE,CAAC,EAAE;AACjD,kCAAY,uBAAqB,KAAK,gDAA6C,CAAC;qBACrF;;wDAEM,eAAc,kBAAkB,EAAE;AACvC,kCAAY,EAAZ,YAAY;AACZ,6BAAO,EAAE,KAAK;AACd,0BAAI,EAAE,EAAE;qBACT,CAAC;;;;;;;aAGL,CAAC;;;AAlGI,mBAAO;gDAoGN,eAAc,aAAa,EAAE,EAAE,OAAO,EAAP,OAAO,EAAE,CAAC;;;;;gDAEzC,eAAc,aAAa,EAAE;AAClC,0BAAY,gBAAO;AACnB,qBAAO,EAAE,KAAK;aACf,CAAC;;;;;;;KAGL;;;WAGsB;UACE,KAAK,EAGpB,IAAI;;;;AAHW,iBAAK,GAAO,IAAI,CAA/B,WAAW,CAAI,KAAK;;;6CAGP,IAAI,CAAC,YAAY,CAClC,CAAE,EAAE,KAAK,EAAL,KAAK,EAAE,iBAAiB,EAAE,KAAK,EAAE,CAAE,EACvC,0BAAQ,CAAC,MAAM,EAAE,EACjB,0BAAQ,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC,MAAM,EAAE,CACjC;;;AAJK,gBAAI;gDAMH,IAAI;;;;;;AAEX,mBAAO,CAAC,GAAG,CAAC,eAAM,KAAK,kBAAS,CAAC,CAAC;gDAC3B;AACL,mBAAK,gBAAA;AACL,qBAAO,EAAE,KAAK;aACf;;;;;;;KAEJ;;;WAGmB;;;;;AAElB,mBAAO,CAAC,IAAI,CAAC,4DAA4D,CAAC,CAAC;gDACpE,IAAI,CAAC,iBAAiB,EAAE;;;;;;;KAChC;;;;;WAIc,mBAAC,KAAK;wBAEI,YAAY,EAAE,WAAW,EAE1C,IAAI;;;;;2BAF6C,IAAI,CAAnD,WAAW;AAAI,wBAAY,gBAAZ,YAAY;AAAE,uBAAW,gBAAX,WAAW;AAE1C,gBAAI,GAAG,IAAI,wBAAW,IAAI,CAAC,GAAG;;AAElC,wBAAY;;AAEZ,gBAAI;;AAEJ,uBAAW;;AAEX,aAAC,mDAAmD,CAAC;;;AAGrD,iBAAK,CACN;gDAGM,aAAY,UAAC,GAAG,EAAE,GAAG;qBAAK,IAAI,CAAC,SAAS,CAAC,UAAA,GAAG,EAAI;AACrD,mBAAG,GAAG,GAAG,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC;eAC5B,CAAC;aAAA,CAAC;;;;;;;KACJ;;;SAhRkB,qBAAqB;;;qBAArB,qBAAqB","file":"clAdapters/google-calendar/index.js","sourcesContent":["import googleapis from 'googleapis';\nimport moment     from 'moment';\nimport _          from 'lodash';\nimport { Adapter, Configuration, Service } from '../base/';\n\n// google calendar api\nconst calendar = googleapis.calendar('v3');\n\nconst credentialMappings = {\n  'certificate' : 'private_key',\n  'serviceEmail': 'client_email',\n  'email'       : 'adminEmail'\n}\n\n\nexport default class GoogleCalendarAdapter extends Adapter {\n\n  static Configuration = Configuration;\n  static Service = Service;\n\n  // convert the names of the api response data\n  static fieldNameMap = {\n    // Desired...                          // Given...\n    'eventId':                             'id',\n    'attendees':                           'attendees',\n    'dateTimeCreated':                     'created',\n    'dateTimeLastModified':                'updated',\n    'attendeeAddress':                     'EmailAddress.Address',\n    'attendeeName':                        'EmailAddress.Name',\n    'iCalUId':                             'iCalUID',\n    'location':                            'location',\n    'status':                              'status',\n    'isCreator':                           'creator.self',\n    'isOrganizer':                         'organizer.self',\n    'organizerEmail':                      'organizer.email',\n    'recurrance':                          'recurrance',\n    'responseStatus':                      'responseStatus',\n    'dateTimeStart':                       'start.dateTime',\n    'dateTimeEnd':                         'end.dateTime',\n    'subject':                             'summary',\n    'url':                                 'htmlLink',\n    'hangoutLink':                         'hangoutLink'\n  }\n\n  // constructor needs to call super\n  constructor() {\n    super();\n  }\n\n\n  reset() {\n    delete this._config;\n    delete this._service;\n    return this;\n  }\n\n\n  async init() {\n\n    const { credentials } = this;\n\n    if (!credentials) {\n      throw new Error('credentials required for adapter.');\n    }\n\n    // map Google json keys to keys used in this library\n    for (const want in credentialMappings) {\n      const alternate = credentialMappings[want];\n      if (!credentials[want]) {\n        credentials[want] = credentials[alternate];\n      }\n    }\n\n    // validate required credential properties\n    Object.keys(credentialMappings)\n      .forEach(prop => {\n        if (!credentials[prop]) {\n          throw new Error(`Property ${prop} required in adapter credentials!`);\n        }\n      });\n\n    this._config  = new GoogleCalendarAdapter.Configuration(credentials);\n    this._service = new GoogleCalendarAdapter.Service(this._config);\n\n    await this._service.init();\n\n    const { serviceEmail: email } = credentials;\n\n    console.log(\n      `Successfully initialized google calendar adapter for email: ${email}`\n    );\n\n    return this;\n  }\n\n\n  // currently doing nothing with fields here, but keeping as placeholder\n  async getBatchData(userProfiles=[], filterStartDate, filterEndDate /*, fields */) {\n\n    const { fieldNameMap } = this.constructor;\n\n    // api options...\n    // https://developers.google.com/google-apps/calendar/v3/\n    const opts = {\n      alwaysIncludeEmail:   true,\n      calendarId:           'primary',\n      singleEvents:         true,\n      timeMax:              filterEndDate.toISOString(),\n      timeMin:              filterStartDate.toISOString(),\n      orderBy:              'startTime'\n    };\n\n\n    const groupRunStats = {\n      success: true,\n      runDate: moment().utc().toDate(),\n      filterStartDate: filterStartDate,\n      filterEndDate: filterEndDate,\n      emails: userProfiles\n    };\n\n\n    try {\n\n      // collect events for this group of emails\n      const results = await* userProfiles.map(async(userProfile) => {\n\n        const individualRunStats = {\n          filterStartDate,\n          filterEndDate,\n          ...userProfile,\n          success: true,\n          runDate: moment().utc().toDate()\n        };\n\n        try {\n          // add auth tokens to request\n          opts.auth = await this.authorize(userProfile.emailAfterMapping);\n\n          // function to recurse through pageTokens\n          const getEvents = async(data) => {\n\n            // request first results...\n            const results = await new Promise((res, rej) => {\n              // add page token if given\n              if (data && data.nextPageToken) {\n                opts.pageToken = data.nextPageToken;\n              }\n\n              calendar.events.list(\n                opts, (err, data) => err ? rej(err) : res(data)\n              );\n            });\n\n            // if we already have data being accumulated, add to items\n            if (data) {\n              data.items.push(...results.items);\n            } else {\n              data = results;\n            }\n\n            // if there is a token for the next page, continue...\n            if (results.nextPageToken) {\n              data.nextPageToken = results.nextPageToken;\n              return await getEvents(data);\n            }\n\n            return data;\n          };\n\n          const { items } = await getEvents();\n\n          const data = _.map(items, item => {\n\n            const out = {};\n\n            _.each(fieldNameMap, (have, want) => {\n              let modified = _.get(item, have);\n              if (/^dateTime/.test(want)) {\n                modified = new Date(modified);\n              }\n              if (modified !== undefined) {\n                out[want] = modified;\n              }\n            });\n\n\n            const attendeeSelf = _.find(out.attendees, (attendee) => {\n              return attendee.self;\n            });\n\n            if (attendeeSelf) {\n              out.responseStatus = attendeeSelf.responseStatus;\n            }\n\n            out.attendees = _.map(out.attendees, attendee => {\n              const { email, responseStatus } = attendee;\n              return { address: email, response: responseStatus };\n            });\n\n            return out;\n          });\n\n          // request all events for this user in the given time frame\n          return Object.assign(individualRunStats, { data });\n\n        } catch (error) {\n          // if the batch collection failed...\n          console.log('GoogleCalendarAdapter.getBatchData Error:', error.stack);\n\n          let errorMessage = error;\n\n          if (/invalid_grant/.test(errorMessage.toString())) {\n            errorMessage = `Email address: ${email} not found in this Google Calendar account.`;\n          }\n\n          return Object.assign(individualRunStats, {\n            errorMessage,\n            success: false,\n            data: []\n          });\n        }\n\n      });\n\n      return Object.assign(groupRunStats, { results });\n    } catch (error) {\n      return Object.assign(groupRunStats, {\n        errorMessage: error,\n        success: false\n      });\n    }\n\n  }\n\n\n  async runConnectionTest() {\n    const { credentials: { email } } = this;\n\n    try {\n      const data = await this.getBatchData(\n        [ { email, emailAfterMapping: email } ],\n        moment().toDate(),\n        moment().add(-1, 'day').toDate()\n      )\n\n      return data;\n    } catch (error) {\n      console.log(error.stack || error);\n      return {\n        error,\n        success: false\n      }\n    }\n  }\n\n\n  async runMessageTest() {\n    // TODO: does this need to be different?\n    console.warn('Note: runMessageTest() currently calls runConnectionTest()');\n    return this.runConnectionTest();\n  }\n\n\n  // create authenticated token for api requests for given user\n  async authorize(email) {\n\n    const { credentials: { serviceEmail, certificate } } = this;\n\n    const auth = new googleapis.auth.JWT(\n      // email of google app admin...\n      serviceEmail,\n      // no need for keyFile...\n      null,\n      // the private key itself...\n      certificate,\n      // scopes...\n      ['https://www.googleapis.com/auth/calendar.readonly'],\n      // the email of the individual we want to authenticate\n      // ('sub' property of the json web token)\n      email\n    );\n\n    // await authorization\n    return new Promise((res, rej) => auth.authorize(err => {\n      err ? rej(err) : res(auth);\n    }));\n  }\n\n}\n"],"sourceRoot":"/source/"}