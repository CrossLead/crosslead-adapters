'use strict';

var _Promise = require('babel-runtime/core-js/promise')['default'];

var crypto = require('crypto');
var rp = require('request-promise');
var util = require('util');
var BaseAdapter = require('../base/Adapter');
var GoogleMail = require('./google-js.js');
var moment = require('moment');
var querystring = require('querystring');
var _ = require('lodash');

var GoogleAdapter = module.exports = function GoogleAdapter() {
  BaseAdapter.call(this);
};

util.inherits(GoogleAdapter, BaseAdapter);

GoogleAdapter.prototype.init = function () {
  var _this = this;
  this._config = new GoogleMail.Configuration(this.credentials);
  this._service = new GoogleMail.Service(this._config);
  return this._service.init().then(function () /*client*/{
    var msg = 'Successfully initialized gmail adapter for email: %s';
    console.log(msg, _this.credentials.email);
    return _this;
  });
};

GoogleAdapter.prototype.reset = function () {
  delete this._config;
  delete this._service;
};

var getSingleMessageDetails = function getSingleMessageDetails(messageId, userEmail, token, apiVersion, additionalFields, result) {
  var additionalFieldsToQuery = additionalFields.replace('BodyPreview', 'snippet');
  additionalFieldsToQuery = additionalFieldsToQuery.replace('Body', 'payload(parts)');
  additionalFieldsToQuery = additionalFieldsToQuery.replace('Subject', 'payload(parts)');

  if (additionalFieldsToQuery !== '') {
    additionalFieldsToQuery = ',' + additionalFieldsToQuery;
  }

  var messageRequestOptions = {
    method: 'GET',
    uri: 'https://www.googleapis.com/gmail/v' + apiVersion + '/users/' + userEmail + '/messages/' + messageId + '?fields=id,threadId,labelIds,payload(headers)' + additionalFieldsToQuery,
    headers: {
      Authorization: 'Bearer ' + token,
      Accept: 'application/json;odata.metadata=none'
    }
  };
  return rp(messageRequestOptions).then(function (messageDetails) {
    result.messageData = JSON.parse(messageDetails);
    if (additionalFields.indexOf('Subject') === -1) {
      //remove subject header
      if (result.messageData.payload && result.messageData.payload.headers && result.messageData.payload.headers.length > 0) {
        for (var headerIter = 0; headerIter < result.messageData.payload.headers.length; headerIter++) {
          if (result.messageData.payload.headers[headerIter].name === 'Subject') {
            result.messageData.payload.headers[headerIter].value = '';
          }
        }
      }
    }

    return true;
  });
};

var getAccessToken = function getAccessToken(clientId, adminEmail, userEmail, privateKey) {
  var tokenRequestUrl = 'https://www.googleapis.com/oauth2/v3/token';
  var unixEpochTime = Math.floor(new Date().getTime() / 1000);

  var jwtHeader = {
    alg: 'RS256',
    typ: 'JWT'
  };

  var jwtPayload = {
    'iss': adminEmail,
    'scope': 'https://www.googleapis.com/auth/gmail.readonly',
    'aud': tokenRequestUrl,
    'exp': unixEpochTime + 3600,
    'iat': unixEpochTime,
    'sub': userEmail
  };

  var encodedJwtHeader = new Buffer(JSON.stringify(jwtHeader)).toString('base64');
  var encodedJwtPayload = new Buffer(JSON.stringify(jwtPayload)).toString('base64');
  var stringToSign = encodedJwtHeader + '.' + encodedJwtPayload;

  //sign it!
  var signer = crypto.createSign('RSA-SHA256');
  signer.update(stringToSign);

  var encodedSignedJwtInfo = signer.sign(privateKey, 'base64');

  //define assertion
  var clientAssertion = encodedJwtHeader + '.' + encodedJwtPayload + '.' + encodedSignedJwtInfo;

  var tokenRequestFormData = {
    grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
    assertion: clientAssertion
  };

  var requestData = querystring.stringify(tokenRequestFormData);
  var requestDataLength = requestData.length;

  var tokenRequestOptions = {
    method: 'POST',
    port: 443,
    uri: tokenRequestUrl,
    body: requestData,
    multipart: false,
    headers: {
      'Content-Length': requestDataLength,
      'Content-Type': 'application/x-www-form-urlencoded'
    }
  };

  return rp(tokenRequestOptions).then(function (body) {
    var tokenData = JSON.parse(body);
    if (tokenData && tokenData.access_token) {
      return tokenData.access_token;
    } else {
      return _Promise.reject('Could not get access token.');
    }
  })['catch'](function (err) {
    var tokenData = JSON.parse(JSON.stringify(err));
    if (tokenData.name === 'StatusCodeError') {
      var entireMessage = tokenData.message;
      var messageJson = entireMessage.replace(tokenData.statusCode + ' - ', '');
      var messageData = JSON.parse(messageJson.replace(new RegExp('\\"', 'g'), '"'));
      //console.log('-----');
      //console.log(messageData);
      return _Promise.reject(messageData);
    } else {
      return _Promise.reject(err);
    }
  });
};

var getUserEmails = function getUserEmails(clientId, serviceEmail, userEmail, privateKey, apiVersion, filterStartDate, filterEndDate, additionalFields, result) {
  var token = '';
  return getAccessToken(clientId, serviceEmail, userEmail, privateKey).then(function (tokenResponse) {
    token = tokenResponse;
    var emailRequestOptions = {
      method: 'GET',
      uri: 'https://www.googleapis.com/gmail/v' + apiVersion + '/users/' + userEmail + '/messages?q=after:' + filterStartDate.toISOString().substring(0, 10) + ' AND before: ' + filterEndDate.toISOString().substring(0, 10),
      headers: {
        Authorization: 'Bearer ' + token,
        Accept: 'application/json;odata.metadata=none'
      }
    };
    return rp(emailRequestOptions);
  }).then(function (body) {
    var messageDetailPromises = [];
    result.success = true;
    result.data = {};
    result.data.messageList = JSON.parse(body);
    result.data.messages = [];

    if (result.data.messageList.messages) {
      for (var messageIter = 0; messageIter < result.data.messageList.messages.length; messageIter++) {
        var messageId = result.data.messageList.messages[messageIter].id;
        result.data.messages.push({ messageId: messageId });
        messageDetailPromises.push(getSingleMessageDetails(messageId, userEmail, token, apiVersion, additionalFields, result.data.messages[messageIter]));
      }
    }

    return _Promise.all(messageDetailPromises);
  })['catch'](function (err) {
    result.success = false;
    if (err.name === 'StatusCodeError') {
      var entireMessage = err.message;
      var messageJson = entireMessage.replace(err.statusCode + ' - ', '');
      var messageData = JSON.parse(messageJson.replace(new RegExp('\\"', 'g'), '"'));
      result.errorMessage = messageData.error.message;
    } else {
      result.errorMessage = JSON.stringify(err);
    }
    return true;
  });
};

var getHeaderValue = function getHeaderValue(message, headerName) {
  var headerValues = _(message.payload.headers).filter(function (header) {
    return header.name === headerName;
  }).pluck('value').value();
  if (headerValues.length > 0) {
    return headerValues[0];
  } else {
    return null;
  }
};

var getEmailAddressObjectFromString = function getEmailAddressObjectFromString(value) {
  var returnObject = {
    name: value,
    address: value
  };

  if (value && value.indexOf('>') > 0) {
    var valueArray = value.split(' ');
    returnObject.address = valueArray[valueArray.length - 1].replace('<', '').replace('>', '');
    returnObject.name = value.replace(' ' + valueArray[valueArray.length - 1], '');
  }

  return returnObject;
};

var convertEmailListToArrayOfEmailAddressObjects = function convertEmailListToArrayOfEmailAddressObjects(emailList) {
  var emailAddressObjectArray = [];
  if (emailList) {
    var emailArray = emailList.split(',');
    for (var emailIter = 0; emailIter < emailArray.length; emailIter++) {
      emailAddressObjectArray.push(getEmailAddressObjectFromString(emailArray[emailIter]));
    }
  }

  return emailAddressObjectArray;
};

var hasLabel = function hasLabel(message, labelValue) {
  return message.labelIds.indexOf(labelValue) >= 0;
};

var mapEmailData = function mapEmailData(emailData) {
  var mappedData = [];

  for (var userIter = 0; userIter < emailData.length; userIter++) {
    var mappedUser = {
      email: emailData[userIter].email,
      filterStartDate: emailData[userIter].filterStartDate,
      filterEndDate: emailData[userIter].filterEndDate,
      data: [],
      success: emailData[userIter].success,
      errorMessage: emailData[userIter].errorMessage
    };

    if (emailData[userIter].success) {
      for (var i = 0; i < emailData[userIter].data['messages'].length; i++) {
        var originalEmailMessage = emailData[userIter].data['messages'][i];
        var mappedEmailMessage = {};

        mappedEmailMessage = originalEmailMessage;
        var messageData = originalEmailMessage.messageData;

        mappedEmailMessage.messageId = originalEmailMessage.messageId;
        mappedEmailMessage.conversationId = messageData.threadId;
        mappedEmailMessage.dateTimeSent = moment(new Date(getHeaderValue(messageData, 'Date'))).utc().toDate();

        var dateReceived = getHeaderValue(messageData, 'Received');
        if (dateReceived) {
          var datePartOfValue = dateReceived.split(';')[1];
          mappedEmailMessage.dateTimeReceived = moment(new Date(datePartOfValue)).utc().toDate();
        }

        mappedEmailMessage.importance = 'Normal';
        if (hasLabel(messageData, 'IMPORTANT')) {
          mappedEmailMessage.importance = 'Important';
        }

        mappedEmailMessage.categories = messageData.labelIds;

        if (hasLabel(messageData, 'SENT')) {
          mappedEmailMessage.folderId = 'Sent Items';
          mappedEmailMessage.folderName = 'Sent Items';
        } else {
          mappedEmailMessage.folderId = 'Inbox';
          mappedEmailMessage.folderName = 'Inbox';
        }

        mappedEmailMessage.subject = getHeaderValue(messageData, 'Subject');
        mappedEmailMessage.bodyPreview = messageData.snippet;

        if (messageData.payload.parts && messageData.payload.parts.length > 0) {
          mappedEmailMessage.contentType = messageData.payload.parts[0].mimeType;
          mappedEmailMessage.body = new Buffer(messageData.payload.parts[0].body.data, 'base64').toString();
        }

        mappedEmailMessage.isDeliveryReceiptRequested = null;
        mappedEmailMessage.isReadReceiptRequested = null;
        mappedEmailMessage.hasAttachments = null;
        mappedEmailMessage.isDraft = null;
        mappedEmailMessage.isRead = hasLabel(messageData, 'READ');

        mappedEmailMessage.fromAddress = getEmailAddressObjectFromString(getHeaderValue(messageData, 'From')).address;
        mappedEmailMessage.fromName = getEmailAddressObjectFromString(getHeaderValue(messageData, 'From')).name;

        mappedEmailMessage.toRecipients = convertEmailListToArrayOfEmailAddressObjects(getHeaderValue(messageData, 'To'));
        mappedEmailMessage.ccRecipients = convertEmailListToArrayOfEmailAddressObjects(getHeaderValue(messageData, 'Cc'));
        mappedEmailMessage.bccRecipients = convertEmailListToArrayOfEmailAddressObjects(getHeaderValue(messageData, 'Bcc'));

        mappedUser.data.push(mappedEmailMessage);
      }
    }
    mappedData.push(mappedUser);
  }

  return mappedData;
};

var getEmailData = function getEmailData(emails, filterStartDate, filterEndDate, additionalFields, clientId, serviceEmail, privateKey, apiVersion) {
  var emailResults = [];
  var emailResultPromises = [];
  var emailIter = 0;
  for (emailIter = 0; emailIter < emails.length; emailIter++) {
    emailResults[emailIter] = { email: emails[emailIter], filterStartDate: filterStartDate, filterEndDate: filterEndDate };
    emailResultPromises.push(getUserEmails(clientId, serviceEmail, emails[emailIter], privateKey, apiVersion, filterStartDate, filterEndDate, additionalFields, emailResults[emailIter]));
  }

  return _Promise.all(emailResultPromises).then(function () {
    return emailResults;
  });
};

GoogleAdapter.prototype.getBatchData = function (emails, filterStartDate, filterEndDate, additionalFields) {
  var clientId = this._config.credentials.clientId;
  var clientEmail = this._config.credentials.email;
  var serviceEmail = this._config.credentials.serviceEmail;
  var privateKey = this._config.credentials.certificate;
  var apiVersion = this._config.options.apiVersion;

  var dataAdapterRunStats = {
    success: true,
    runDate: moment().utc().toDate(),
    filterStartDate: filterStartDate,
    filterEndDate: filterEndDate,
    emails: emails
  };

  //first try to get token for the admin - if that fails, then all will fail
  return getAccessToken(clientId, serviceEmail, clientEmail, privateKey).then(function () {
    return getEmailData(emails, filterStartDate, filterEndDate, additionalFields, clientId, serviceEmail, privateKey, apiVersion);
  }).then(function (emailData) {
    return mapEmailData(emailData);
  }).then(function (mappedEmailData) {
    dataAdapterRunStats.results = mappedEmailData;
    return dataAdapterRunStats;
  })['catch'](function (err) {
    dataAdapterRunStats.success = false;
    dataAdapterRunStats.errorMessage = err;
    console.log('GoogleMail GetBatchData Error: ' + JSON.stringify(err));
    return dataAdapterRunStats;
  });
};

GoogleAdapter.prototype.runConnectionTest = function (connectionData) {
  var _this = this;
  _this._config = new GoogleMail.Configuration(connectionData.credentials);
  var filterStartDate = moment().utc().startOf('day').add(-1, 'days').toDate();
  var filterEndDate = moment().utc().startOf('day').toDate();
  return _this.getBatchData([_this._config.credentials.email], filterStartDate, filterEndDate, '').then(function (data) {
    if (data.success && data.results[0]) {
      //to see if it really worked, we need to pass in the first result
      return data.results[0];
    } else {
      return data;
    }
  });
};

GoogleAdapter.prototype.runMessageTest = function (connectionData) {
  var _this = this;
  _this._config = new GoogleMail.Configuration(connectionData.credentials);
  var filterStartDate = moment().utc().startOf('day').add(-1, 'days').toDate();
  var filterEndDate = moment().utc().startOf('day').add(1, 'days').toDate();
  return _this.getBatchData([_this._config.credentials.email], filterStartDate, filterEndDate, 'Subject,BodyPreview,Body').then(function (data) {
    console.log('runMessageTest worked');
    console.log(data.results[0]);
  })['catch'](function (err) {
    console.log('runMessageTest Error: ' + JSON.stringify(err));
  });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsQWRhcHRlcnNcXGdvb2dsZS1tYWlsXFxpbmRleC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7Ozs7QUFFYixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDL0IsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDcEMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQzdDLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQzNDLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFDekMsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDOztBQUUxQixJQUFJLGFBQWEsR0FBRyxNQUFNLENBQUMsT0FBTyxHQUFHLFNBQVMsYUFBYSxHQUFHO0FBQzVELGFBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Q0FDeEIsQ0FBQzs7QUFFRixJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQzs7QUFFMUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsWUFBVztBQUN4QyxNQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7QUFDakIsTUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLFVBQVUsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQzlELE1BQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNyRCxTQUFPLElBQUksQ0FBQyxRQUFRLENBQ2pCLElBQUksRUFB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QUFHLElBQUksQ0FBQztBQUNqQixPQUFLLENBQUMsT0FBTyxHQUFHLElBQUksVUFBVSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDekUsTUFBSSxlQUFlLEdBQUcsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUM3RSxNQUFJLGFBQWEsR0FBRyxNQUFNLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUMxRSxTQUFPLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLDBCQUEwQixDQUFDLENBQ3ZILElBQUksQ0FBQyxVQUFTLElBQUksRUFBRTtBQUNuQixXQUFPLENBQUMsR0FBRyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDckMsV0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7R0FDOUIsQ0FBQyxTQUNJLENBQUMsVUFBUyxHQUFHLEVBQUU7QUFDbkIsV0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7R0FDN0QsQ0FBQyxDQUFDO0NBQ0osQ0FBQyIsImZpbGUiOiJjbEFkYXB0ZXJzXFxnb29nbGUtbWFpbFxcaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbnZhciBjcnlwdG8gPSByZXF1aXJlKCdjcnlwdG8nKTtcbnZhciBycCA9IHJlcXVpcmUoJ3JlcXVlc3QtcHJvbWlzZScpO1xudmFyIHV0aWwgPSByZXF1aXJlKCd1dGlsJyk7XG52YXIgQmFzZUFkYXB0ZXIgPSByZXF1aXJlKCcuLi9iYXNlL0FkYXB0ZXInKTtcbnZhciBHb29nbGVNYWlsID0gcmVxdWlyZSgnLi9nb29nbGUtanMuanMnKTtcbnZhciBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKTtcbnZhciBxdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJyk7XG52YXIgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xuXG52YXIgR29vZ2xlQWRhcHRlciA9IG1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24gR29vZ2xlQWRhcHRlcigpIHtcbiAgQmFzZUFkYXB0ZXIuY2FsbCh0aGlzKTtcbn07XG5cbnV0aWwuaW5oZXJpdHMoR29vZ2xlQWRhcHRlciwgQmFzZUFkYXB0ZXIpO1xuXG5Hb29nbGVBZGFwdGVyLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oKSB7XG4gIHZhciBfdGhpcyA9IHRoaXM7XG4gIHRoaXMuX2NvbmZpZyA9IG5ldyBHb29nbGVNYWlsLkNvbmZpZ3VyYXRpb24odGhpcy5jcmVkZW50aWFscyk7XG4gIHRoaXMuX3NlcnZpY2UgPSBuZXcgR29vZ2xlTWFpbC5TZXJ2aWNlKHRoaXMuX2NvbmZpZyk7XG4gIHJldHVybiB0aGlzLl9zZXJ2aWNlXG4gICAgLmluaXQoKVxuICAgIC50aGVuKGZ1bmN0aW9uKCAvKmNsaWVudCovICkge1xuICAgICAgdmFyIG1zZyA9ICdTdWNjZXNzZnVsbHkgaW5pdGlhbGl6ZWQgZ21haWwgYWRhcHRlciBmb3IgZW1haWw6ICVzJztcbiAgICAgIGNvbnNvbGUubG9nKG1zZywgX3RoaXMuY3JlZGVudGlhbHMuZW1haWwpO1xuICAgICAgcmV0dXJuIF90aGlzO1xuICAgIH0pO1xufTtcblxuR29vZ2xlQWRhcHRlci5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbigpIHtcbiAgZGVsZXRlIHRoaXMuX2NvbmZpZztcbiAgZGVsZXRlIHRoaXMuX3NlcnZpY2U7XG59O1xuXG52YXIgZ2V0U2luZ2xlTWVzc2FnZURldGFpbHMgPSBmdW5jdGlvbihtZXNzYWdlSWQsIHVzZXJFbWFpbCwgdG9rZW4sIGFwaVZlcnNpb24sIGFkZGl0aW9uYWxGaWVsZHMsIHJlc3VsdCkge1xuICB2YXIgYWRkaXRpb25hbEZpZWxkc1RvUXVlcnkgPSBhZGRpdGlvbmFsRmllbGRzLnJlcGxhY2UoJ0JvZHlQcmV2aWV3JywgJ3NuaXBwZXQnKTtcbiAgYWRkaXRpb25hbEZpZWxkc1RvUXVlcnkgPSBhZGRpdGlvbmFsRmllbGRzVG9RdWVyeS5yZXBsYWNlKCdCb2R5JywgJ3BheWxvYWQocGFydHMpJyk7XG4gIGFkZGl0aW9uYWxGaWVsZHNUb1F1ZXJ5ID0gYWRkaXRpb25hbEZpZWxkc1RvUXVlcnkucmVwbGFjZSgnU3ViamVjdCcsICdwYXlsb2FkKHBhcnRzKScpO1xuXG4gIGlmIChhZGRpdGlvbmFsRmllbGRzVG9RdWVyeSAhPT0gJycpIHtcbiAgICBhZGRpdGlvbmFsRmllbGRzVG9RdWVyeSA9ICcsJyArIGFkZGl0aW9uYWxGaWVsZHNUb1F1ZXJ5O1xuICB9XG5cbiAgdmFyIG1lc3NhZ2VSZXF1ZXN0T3B0aW9ucyA9IHtcbiAgICBtZXRob2Q6ICdHRVQnLFxuICAgIHVyaTogJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2dtYWlsL3YnICsgYXBpVmVyc2lvbiArICcvdXNlcnMvJyArIHVzZXJFbWFpbCArICcvbWVzc2FnZXMvJyArIG1lc3NhZ2VJZCArICc/ZmllbGRzPWlkLHRocmVhZElkLGxhYmVsSWRzLHBheWxvYWQoaGVhZGVycyknICsgYWRkaXRpb25hbEZpZWxkc1RvUXVlcnksXG4gICAgaGVhZGVycyA6IHtcbiAgICAgIEF1dGhvcml6YXRpb246ICdCZWFyZXIgJyArIHRva2VuLFxuICAgICAgQWNjZXB0OiAnYXBwbGljYXRpb24vanNvbjtvZGF0YS5tZXRhZGF0YT1ub25lJ1xuICAgIH1cbiAgfTtcbiAgcmV0dXJuIHJwKG1lc3NhZ2VSZXF1ZXN0T3B0aW9ucylcbiAgLnRoZW4oZnVuY3Rpb24obWVzc2FnZURldGFpbHMpIHtcbiAgICByZXN1bHQubWVzc2FnZURhdGEgPSBKU09OLnBhcnNlKG1lc3NhZ2VEZXRhaWxzKTtcbiAgICBpZiAoYWRkaXRpb25hbEZpZWxkcy5pbmRleE9mKCdTdWJqZWN0JykgPT09IC0xKSB7XG4gICAgICAvL3JlbW92ZSBzdWJqZWN0IGhlYWRlclxuICAgICAgaWYgKHJlc3VsdC5tZXNzYWdlRGF0YS5wYXlsb2FkICYmIHJlc3VsdC5tZXNzYWdlRGF0YS5wYXlsb2FkLmhlYWRlcnMgJiYgcmVzdWx0Lm1lc3NhZ2VEYXRhLnBheWxvYWQuaGVhZGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGZvciAodmFyIGhlYWRlckl0ZXIgPSAwOyBoZWFkZXJJdGVyIDwgcmVzdWx0Lm1lc3NhZ2VEYXRhLnBheWxvYWQuaGVhZGVycy5sZW5ndGg7IGhlYWRlckl0ZXIrKykge1xuICAgICAgICAgIGlmIChyZXN1bHQubWVzc2FnZURhdGEucGF5bG9hZC5oZWFkZXJzW2hlYWRlckl0ZXJdLm5hbWUgPT09ICdTdWJqZWN0Jykge1xuICAgICAgICAgICAgcmVzdWx0Lm1lc3NhZ2VEYXRhLnBheWxvYWQuaGVhZGVyc1toZWFkZXJJdGVyXS52YWx1ZSA9ICcnO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9KTtcbn07XG5cbnZhciBnZXRBY2Nlc3NUb2tlbiA9IGZ1bmN0aW9uKGNsaWVudElkLCBhZG1pbkVtYWlsLCB1c2VyRW1haWwsIHByaXZhdGVLZXkpIHtcbiAgdmFyIHRva2VuUmVxdWVzdFVybCA9ICdodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjMvdG9rZW4nO1xuICB2YXIgdW5peEVwb2NoVGltZSA9IE1hdGguZmxvb3IoKG5ldyBEYXRlKCkpLmdldFRpbWUoKSAvIDEwMDApO1xuXG4gIHZhciBqd3RIZWFkZXIgPSB7XG4gICAgYWxnOiAnUlMyNTYnLFxuICAgIHR5cDogJ0pXVCdcbiAgfTtcblxuICB2YXIgand0UGF5bG9hZCA9IHtcbiAgICAnaXNzJzogYWRtaW5FbWFpbCxcbiAgICAnc2NvcGUnOiAnaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vYXV0aC9nbWFpbC5yZWFkb25seScsXG4gICAgJ2F1ZCc6IHRva2VuUmVxdWVzdFVybCxcbiAgICAnZXhwJzogdW5peEVwb2NoVGltZSArIDM2MDAsXG4gICAgJ2lhdCc6IHVuaXhFcG9jaFRpbWUsXG4gICAgJ3N1Yic6IHVzZXJFbWFpbFxuICB9O1xuXG4gIHZhciBlbmNvZGVkSnd0SGVhZGVyID0gbmV3IEJ1ZmZlcihKU09OLnN0cmluZ2lmeShqd3RIZWFkZXIpKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gIHZhciBlbmNvZGVkSnd0UGF5bG9hZCA9IG5ldyBCdWZmZXIoSlNPTi5zdHJpbmdpZnkoand0UGF5bG9hZCkpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgdmFyIHN0cmluZ1RvU2lnbiA9IGVuY29kZWRKd3RIZWFkZXIgKyAnLicgKyBlbmNvZGVkSnd0UGF5bG9hZDtcblxuICAvL3NpZ24gaXQhXG4gIHZhciBzaWduZXIgPSBjcnlwdG8uY3JlYXRlU2lnbignUlNBLVNIQTI1NicpO1xuICBzaWduZXIudXBkYXRlKHN0cmluZ1RvU2lnbik7XG5cbiAgdmFyIGVuY29kZWRTaWduZWRKd3RJbmZvID0gc2lnbmVyLnNpZ24ocHJpdmF0ZUtleSwgJ2Jhc2U2NCcpO1xuXG4gIC8vZGVmaW5lIGFzc2VydGlvblxuICB2YXIgY2xpZW50QXNzZXJ0aW9uID0gZW5jb2RlZEp3dEhlYWRlciArICcuJyArIGVuY29kZWRKd3RQYXlsb2FkICsgJy4nICsgZW5jb2RlZFNpZ25lZEp3dEluZm87XG5cbiAgdmFyIHRva2VuUmVxdWVzdEZvcm1EYXRhID0ge1xuICAgIGdyYW50X3R5cGU6ICd1cm46aWV0ZjpwYXJhbXM6b2F1dGg6Z3JhbnQtdHlwZTpqd3QtYmVhcmVyJyxcbiAgICBhc3NlcnRpb246IGNsaWVudEFzc2VydGlvblxuICB9O1xuXG4gIHZhciByZXF1ZXN0RGF0YSA9IHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeSh0b2tlblJlcXVlc3RGb3JtRGF0YSk7XG4gIHZhciByZXF1ZXN0RGF0YUxlbmd0aCA9IHJlcXVlc3REYXRhLmxlbmd0aDtcblxuICB2YXIgdG9rZW5SZXF1ZXN0T3B0aW9ucyA9IHtcbiAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICBwb3J0OiA0NDMsXG4gICAgdXJpOiB0b2tlblJlcXVlc3RVcmwsXG4gICAgYm9keTogcmVxdWVzdERhdGEsXG4gICAgbXVsdGlwYXJ0OiBmYWxzZSxcbiAgICBoZWFkZXJzOiB7XG4gICAgICAnQ29udGVudC1MZW5ndGgnOiByZXF1ZXN0RGF0YUxlbmd0aCxcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJ1xuICAgIH1cbiAgfTtcblxuICByZXR1cm4gcnAodG9rZW5SZXF1ZXN0T3B0aW9ucylcbiAgLnRoZW4oZnVuY3Rpb24oYm9keSkge1xuICAgIHZhciB0b2tlbkRhdGEgPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgIGlmICh0b2tlbkRhdGEgJiYgdG9rZW5EYXRhLmFjY2Vzc190b2tlbikge1xuICAgICAgcmV0dXJuIHRva2VuRGF0YS5hY2Nlc3NfdG9rZW47XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdCgnQ291bGQgbm90IGdldCBhY2Nlc3MgdG9rZW4uJyk7XG4gICAgfVxuICB9KVxuICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgdmFyIHRva2VuRGF0YSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXJyKSk7XG4gICAgaWYgKHRva2VuRGF0YS5uYW1lID09PSAnU3RhdHVzQ29kZUVycm9yJykge1xuICAgICAgdmFyIGVudGlyZU1lc3NhZ2UgPSB0b2tlbkRhdGEubWVzc2FnZTtcbiAgICAgIHZhciBtZXNzYWdlSnNvbiA9IGVudGlyZU1lc3NhZ2UucmVwbGFjZSh0b2tlbkRhdGEuc3RhdHVzQ29kZSArICcgLSAnLCAnJyk7XG4gICAgICB2YXIgbWVzc2FnZURhdGEgPSBKU09OLnBhcnNlKG1lc3NhZ2VKc29uLnJlcGxhY2UobmV3IFJlZ0V4cCgnXFxcXFwiJywgJ2cnKSwnXCInKSk7XG4gICAgICAvL2NvbnNvbGUubG9nKCctLS0tLScpO1xuICAgICAgLy9jb25zb2xlLmxvZyhtZXNzYWdlRGF0YSk7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobWVzc2FnZURhdGEpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyKTtcbiAgICB9XG4gIH0pO1xufTtcblxudmFyIGdldFVzZXJFbWFpbHMgPSBmdW5jdGlvbihjbGllbnRJZCwgc2VydmljZUVtYWlsLCB1c2VyRW1haWwsIHByaXZhdGVLZXksIGFwaVZlcnNpb24sIGZpbHRlclN0YXJ0RGF0ZSwgZmlsdGVyRW5kRGF0ZSwgYWRkaXRpb25hbEZpZWxkcywgcmVzdWx0KSB7XG4gIHZhciB0b2tlbiA9ICcnO1xuICByZXR1cm4gZ2V0QWNjZXNzVG9rZW4oY2xpZW50SWQsIHNlcnZpY2VFbWFpbCwgdXNlckVtYWlsLCBwcml2YXRlS2V5KVxuICAudGhlbihmdW5jdGlvbih0b2tlblJlc3BvbnNlKSB7XG4gICAgdG9rZW4gPSB0b2tlblJlc3BvbnNlO1xuICAgIHZhciBlbWFpbFJlcXVlc3RPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgIHVyaTogJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2dtYWlsL3YnICsgYXBpVmVyc2lvbiArICcvdXNlcnMvJyArIHVzZXJFbWFpbCArICcvbWVzc2FnZXM/cT1hZnRlcjonICsgZmlsdGVyU3RhcnREYXRlLnRvSVNPU3RyaW5nKCkuc3Vic3RyaW5nKDAsIDEwKSArICcgQU5EIGJlZm9yZTogJyArIGZpbHRlckVuZERhdGUudG9JU09TdHJpbmcoKS5zdWJzdHJpbmcoMCwgMTApLFxuICAgICAgaGVhZGVycyA6IHtcbiAgICAgICAgQXV0aG9yaXphdGlvbjogJ0JlYXJlciAnICsgdG9rZW4sXG4gICAgICAgIEFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb247b2RhdGEubWV0YWRhdGE9bm9uZSdcbiAgICAgIH1cbiAgICB9O1xuICAgIHJldHVybiBycChlbWFpbFJlcXVlc3RPcHRpb25zKTtcbiAgfSlcbiAgLnRoZW4oZnVuY3Rpb24oYm9keSkge1xuICAgIHZhciBtZXNzYWdlRGV0YWlsUHJvbWlzZXMgPSBbXTtcbiAgICByZXN1bHQuc3VjY2VzcyA9IHRydWU7XG4gICAgcmVzdWx0LmRhdGEgPSB7fTtcbiAgICByZXN1bHQuZGF0YS5tZXNzYWdlTGlzdCA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgcmVzdWx0LmRhdGEubWVzc2FnZXMgPSBbXTtcblxuICAgIGlmIChyZXN1bHQuZGF0YS5tZXNzYWdlTGlzdC5tZXNzYWdlcykge1xuICAgICAgZm9yICh2YXIgbWVzc2FnZUl0ZXIgPSAwOyBtZXNzYWdlSXRlciA8IHJlc3VsdC5kYXRhLm1lc3NhZ2VMaXN0Lm1lc3NhZ2VzLmxlbmd0aDsgbWVzc2FnZUl0ZXIrKykge1xuICAgICAgICB2YXIgbWVzc2FnZUlkID0gcmVzdWx0LmRhdGEubWVzc2FnZUxpc3QubWVzc2FnZXNbbWVzc2FnZUl0ZXJdLmlkO1xuICAgICAgICByZXN1bHQuZGF0YS5tZXNzYWdlcy5wdXNoKHttZXNzYWdlSWQ6IG1lc3NhZ2VJZH0pO1xuICAgICAgICBtZXNzYWdlRGV0YWlsUHJvbWlzZXMucHVzaChnZXRTaW5nbGVNZXNzYWdlRGV0YWlscyhtZXNzYWdlSWQsIHVzZXJFbWFpbCwgdG9rZW4sIGFwaVZlcnNpb24sIGFkZGl0aW9uYWxGaWVsZHMsIHJlc3VsdC5kYXRhLm1lc3NhZ2VzW21lc3NhZ2VJdGVyXSkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBQcm9taXNlLmFsbChtZXNzYWdlRGV0YWlsUHJvbWlzZXMpO1xuICB9KVxuICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgcmVzdWx0LnN1Y2Nlc3MgPSBmYWxzZTtcbiAgICBpZiAoZXJyLm5hbWUgPT09ICdTdGF0dXNDb2RlRXJyb3InKSB7XG4gICAgICB2YXIgZW50aXJlTWVzc2FnZSA9IGVyci5tZXNzYWdlO1xuICAgICAgdmFyIG1lc3NhZ2VKc29uID0gZW50aXJlTWVzc2FnZS5yZXBsYWNlKGVyci5zdGF0dXNDb2RlICsgJyAtICcsICcnKTtcbiAgICAgIHZhciBtZXNzYWdlRGF0YSA9IEpTT04ucGFyc2UobWVzc2FnZUpzb24ucmVwbGFjZShuZXcgUmVnRXhwKCdcXFxcXCInLCAnZycpLCdcIicpKTtcbiAgICAgIHJlc3VsdC5lcnJvck1lc3NhZ2UgPSBtZXNzYWdlRGF0YS5lcnJvci5tZXNzYWdlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQuZXJyb3JNZXNzYWdlID0gSlNPTi5zdHJpbmdpZnkoZXJyKTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH0pO1xufTtcblxudmFyIGdldEhlYWRlclZhbHVlID0gZnVuY3Rpb24obWVzc2FnZSwgaGVhZGVyTmFtZSkge1xuICB2YXIgaGVhZGVyVmFsdWVzID0gXyhtZXNzYWdlLnBheWxvYWQuaGVhZGVycylcbiAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uKGhlYWRlcikgeyByZXR1cm4gaGVhZGVyLm5hbWUgPT09IGhlYWRlck5hbWU7IH0pXG4gICAgICAgICAgLnBsdWNrKCd2YWx1ZScpXG4gICAgICAgICAgLnZhbHVlKCk7XG4gIGlmIChoZWFkZXJWYWx1ZXMubGVuZ3RoID4gMCkge1xuICAgIHJldHVybiBoZWFkZXJWYWx1ZXNbMF07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn07XG5cbnZhciBnZXRFbWFpbEFkZHJlc3NPYmplY3RGcm9tU3RyaW5nID0gZnVuY3Rpb24odmFsdWUpIHtcbiAgdmFyIHJldHVybk9iamVjdCA9IHtcbiAgICBuYW1lOiB2YWx1ZSxcbiAgICBhZGRyZXNzOiB2YWx1ZVxuICB9O1xuXG4gIGlmICh2YWx1ZSAmJiB2YWx1ZS5pbmRleE9mKCc+JykgPiAwKSB7XG4gICAgdmFyIHZhbHVlQXJyYXkgPSB2YWx1ZS5zcGxpdCgnICcpO1xuICAgIHJldHVybk9iamVjdC5hZGRyZXNzID0gdmFsdWVBcnJheVt2YWx1ZUFycmF5Lmxlbmd0aCAtIDFdLnJlcGxhY2UoJzwnLCAnJykucmVwbGFjZSgnPicsICcnKTtcbiAgICByZXR1cm5PYmplY3QubmFtZSA9IHZhbHVlLnJlcGxhY2UoJyAnICsgdmFsdWVBcnJheVt2YWx1ZUFycmF5Lmxlbmd0aCAtIDFdLCAnJyk7XG4gIH1cblxuICByZXR1cm4gcmV0dXJuT2JqZWN0O1xufTtcblxudmFyIGNvbnZlcnRFbWFpbExpc3RUb0FycmF5T2ZFbWFpbEFkZHJlc3NPYmplY3RzID0gZnVuY3Rpb24oZW1haWxMaXN0KSB7XG4gIHZhciBlbWFpbEFkZHJlc3NPYmplY3RBcnJheSA9IFtdO1xuICBpZiAoZW1haWxMaXN0KSB7XG4gICAgdmFyIGVtYWlsQXJyYXkgPSBlbWFpbExpc3Quc3BsaXQoJywnKTtcbiAgICBmb3IgKHZhciBlbWFpbEl0ZXIgPSAwOyBlbWFpbEl0ZXIgPCBlbWFpbEFycmF5Lmxlbmd0aDsgZW1haWxJdGVyKyspIHtcbiAgICAgIGVtYWlsQWRkcmVzc09iamVjdEFycmF5LnB1c2goZ2V0RW1haWxBZGRyZXNzT2JqZWN0RnJvbVN0cmluZyhlbWFpbEFycmF5W2VtYWlsSXRlcl0pKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZW1haWxBZGRyZXNzT2JqZWN0QXJyYXk7XG59O1xuXG52YXIgaGFzTGFiZWwgPSBmdW5jdGlvbihtZXNzYWdlLCBsYWJlbFZhbHVlKSB7XG4gIHJldHVybiBtZXNzYWdlLmxhYmVsSWRzLmluZGV4T2YobGFiZWxWYWx1ZSkgPj0gMDtcbn07XG5cbnZhciBtYXBFbWFpbERhdGEgPSBmdW5jdGlvbihlbWFpbERhdGEpIHtcbiAgdmFyIG1hcHBlZERhdGEgPSBbXTtcblxuICBmb3IgKHZhciB1c2VySXRlciA9IDA7IHVzZXJJdGVyIDwgZW1haWxEYXRhLmxlbmd0aDsgdXNlckl0ZXIrKykge1xuICAgIHZhciBtYXBwZWRVc2VyID0ge1xuICAgICAgZW1haWw6IGVtYWlsRGF0YVt1c2VySXRlcl0uZW1haWwsXG4gICAgICBmaWx0ZXJTdGFydERhdGU6IGVtYWlsRGF0YVt1c2VySXRlcl0uZmlsdGVyU3RhcnREYXRlLFxuICAgICAgZmlsdGVyRW5kRGF0ZTogZW1haWxEYXRhW3VzZXJJdGVyXS5maWx0ZXJFbmREYXRlLFxuICAgICAgZGF0YTogW10sXG4gICAgICBzdWNjZXNzOiBlbWFpbERhdGFbdXNlckl0ZXJdLnN1Y2Nlc3MsXG4gICAgICBlcnJvck1lc3NhZ2U6IGVtYWlsRGF0YVt1c2VySXRlcl0uZXJyb3JNZXNzYWdlXG4gICAgfTtcblxuICAgIGlmIChlbWFpbERhdGFbdXNlckl0ZXJdLnN1Y2Nlc3MpIHtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZW1haWxEYXRhW3VzZXJJdGVyXS5kYXRhWydtZXNzYWdlcyddLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHZhciBvcmlnaW5hbEVtYWlsTWVzc2FnZSA9IGVtYWlsRGF0YVt1c2VySXRlcl0uZGF0YVsnbWVzc2FnZXMnXVtpXTtcbiAgICAgICAgdmFyIG1hcHBlZEVtYWlsTWVzc2FnZSA9IHt9O1xuXG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZSA9IG9yaWdpbmFsRW1haWxNZXNzYWdlO1xuICAgICAgICB2YXIgbWVzc2FnZURhdGEgPSBvcmlnaW5hbEVtYWlsTWVzc2FnZS5tZXNzYWdlRGF0YTtcblxuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UubWVzc2FnZUlkID0gb3JpZ2luYWxFbWFpbE1lc3NhZ2UubWVzc2FnZUlkO1xuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuY29udmVyc2F0aW9uSWQgPSBtZXNzYWdlRGF0YS50aHJlYWRJZDtcbiAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLmRhdGVUaW1lU2VudCA9IG1vbWVudChuZXcgRGF0ZShnZXRIZWFkZXJWYWx1ZShtZXNzYWdlRGF0YSwgJ0RhdGUnKSkpLnV0YygpLnRvRGF0ZSgpO1xuXG4gICAgICAgIHZhciBkYXRlUmVjZWl2ZWQgPSBnZXRIZWFkZXJWYWx1ZShtZXNzYWdlRGF0YSwgJ1JlY2VpdmVkJyk7XG4gICAgICAgIGlmIChkYXRlUmVjZWl2ZWQpIHtcbiAgICAgICAgICB2YXIgZGF0ZVBhcnRPZlZhbHVlID0gZGF0ZVJlY2VpdmVkLnNwbGl0KCc7JylbMV07XG4gICAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLmRhdGVUaW1lUmVjZWl2ZWQgPSBtb21lbnQobmV3IERhdGUoZGF0ZVBhcnRPZlZhbHVlKSkudXRjKCkudG9EYXRlKCk7XG4gICAgICAgIH1cblxuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuaW1wb3J0YW5jZSA9ICdOb3JtYWwnO1xuICAgICAgICBpZiAoaGFzTGFiZWwobWVzc2FnZURhdGEsICdJTVBPUlRBTlQnKSkge1xuICAgICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5pbXBvcnRhbmNlID0gJ0ltcG9ydGFudCc7XG4gICAgICAgIH1cblxuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuY2F0ZWdvcmllcyA9IG1lc3NhZ2VEYXRhLmxhYmVsSWRzO1xuXG4gICAgICAgIGlmIChoYXNMYWJlbChtZXNzYWdlRGF0YSwgJ1NFTlQnKSkge1xuICAgICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5mb2xkZXJJZCA9ICdTZW50IEl0ZW1zJztcbiAgICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuZm9sZGVyTmFtZSA9ICdTZW50IEl0ZW1zJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuZm9sZGVySWQgPSAnSW5ib3gnO1xuICAgICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5mb2xkZXJOYW1lID0gJ0luYm94JztcbiAgICAgICAgfVxuXG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5zdWJqZWN0ID0gZ2V0SGVhZGVyVmFsdWUobWVzc2FnZURhdGEsICdTdWJqZWN0Jyk7XG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5ib2R5UHJldmlldyA9IG1lc3NhZ2VEYXRhLnNuaXBwZXQ7XG5cbiAgICAgICAgaWYgKG1lc3NhZ2VEYXRhLnBheWxvYWQucGFydHMgJiYgbWVzc2FnZURhdGEucGF5bG9hZC5wYXJ0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLmNvbnRlbnRUeXBlID0gbWVzc2FnZURhdGEucGF5bG9hZC5wYXJ0c1swXS5taW1lVHlwZTtcbiAgICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuYm9keSA9IG5ldyBCdWZmZXIobWVzc2FnZURhdGEucGF5bG9hZC5wYXJ0c1swXS5ib2R5LmRhdGEsICdiYXNlNjQnKS50b1N0cmluZygpO1xuICAgICAgICB9XG5cbiAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLmlzRGVsaXZlcnlSZWNlaXB0UmVxdWVzdGVkID0gbnVsbDtcbiAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLmlzUmVhZFJlY2VpcHRSZXF1ZXN0ZWQgPSBudWxsO1xuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuaGFzQXR0YWNobWVudHMgPSBudWxsO1xuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuaXNEcmFmdCA9IG51bGw7XG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5pc1JlYWQgPSBoYXNMYWJlbChtZXNzYWdlRGF0YSwgJ1JFQUQnKTtcblxuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuZnJvbUFkZHJlc3MgPSBnZXRFbWFpbEFkZHJlc3NPYmplY3RGcm9tU3RyaW5nKGdldEhlYWRlclZhbHVlKG1lc3NhZ2VEYXRhLCAnRnJvbScpKS5hZGRyZXNzO1xuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuZnJvbU5hbWUgPSBnZXRFbWFpbEFkZHJlc3NPYmplY3RGcm9tU3RyaW5nKGdldEhlYWRlclZhbHVlKG1lc3NhZ2VEYXRhLCAnRnJvbScpKS5uYW1lO1xuXG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS50b1JlY2lwaWVudHMgPSBjb252ZXJ0RW1haWxMaXN0VG9BcnJheU9mRW1haWxBZGRyZXNzT2JqZWN0cyhnZXRIZWFkZXJWYWx1ZShtZXNzYWdlRGF0YSwgJ1RvJykpO1xuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuY2NSZWNpcGllbnRzID0gY29udmVydEVtYWlsTGlzdFRvQXJyYXlPZkVtYWlsQWRkcmVzc09iamVjdHMoZ2V0SGVhZGVyVmFsdWUobWVzc2FnZURhdGEsICdDYycpKTtcbiAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLmJjY1JlY2lwaWVudHMgPSBjb252ZXJ0RW1haWxMaXN0VG9BcnJheU9mRW1haWxBZGRyZXNzT2JqZWN0cyhnZXRIZWFkZXJWYWx1ZShtZXNzYWdlRGF0YSwgJ0JjYycpKTtcblxuICAgICAgICBtYXBwZWRVc2VyLmRhdGEucHVzaChtYXBwZWRFbWFpbE1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH1cbiAgICBtYXBwZWREYXRhLnB1c2gobWFwcGVkVXNlcik7XG4gIH1cblxuICByZXR1cm4gbWFwcGVkRGF0YTtcbn07XG5cbnZhciBnZXRFbWFpbERhdGEgPSBmdW5jdGlvbihlbWFpbHMsIGZpbHRlclN0YXJ0RGF0ZSwgZmlsdGVyRW5kRGF0ZSwgYWRkaXRpb25hbEZpZWxkcywgY2xpZW50SWQsIHNlcnZpY2VFbWFpbCwgcHJpdmF0ZUtleSwgYXBpVmVyc2lvbikge1xuICB2YXIgZW1haWxSZXN1bHRzID0gW107XG4gIHZhciBlbWFpbFJlc3VsdFByb21pc2VzID0gW107XG4gIHZhciBlbWFpbEl0ZXIgPSAwO1xuICBmb3IgKGVtYWlsSXRlciA9IDA7IGVtYWlsSXRlciA8IGVtYWlscy5sZW5ndGg7IGVtYWlsSXRlcisrKSB7XG4gICAgZW1haWxSZXN1bHRzW2VtYWlsSXRlcl0gPSB7ZW1haWw6IGVtYWlsc1tlbWFpbEl0ZXJdLCBmaWx0ZXJTdGFydERhdGU6IGZpbHRlclN0YXJ0RGF0ZSwgZmlsdGVyRW5kRGF0ZTogZmlsdGVyRW5kRGF0ZX07XG4gICAgZW1haWxSZXN1bHRQcm9taXNlcy5wdXNoKGdldFVzZXJFbWFpbHMoY2xpZW50SWQsIHNlcnZpY2VFbWFpbCwgZW1haWxzW2VtYWlsSXRlcl0sIHByaXZhdGVLZXksIGFwaVZlcnNpb24sIGZpbHRlclN0YXJ0RGF0ZSwgZmlsdGVyRW5kRGF0ZSwgYWRkaXRpb25hbEZpZWxkcywgZW1haWxSZXN1bHRzW2VtYWlsSXRlcl0pKTtcbiAgfVxuXG4gIHJldHVybiBQcm9taXNlLmFsbChlbWFpbFJlc3VsdFByb21pc2VzKVxuICAudGhlbihmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gZW1haWxSZXN1bHRzO1xuICB9KTtcbn07XG5cbkdvb2dsZUFkYXB0ZXIucHJvdG90eXBlLmdldEJhdGNoRGF0YSA9IGZ1bmN0aW9uKGVtYWlscywgZmlsdGVyU3RhcnREYXRlLCBmaWx0ZXJFbmREYXRlLCBhZGRpdGlvbmFsRmllbGRzKSB7XG4gIHZhciBjbGllbnRJZCA9IHRoaXMuX2NvbmZpZy5jcmVkZW50aWFscy5jbGllbnRJZDtcbiAgdmFyIGNsaWVudEVtYWlsID0gdGhpcy5fY29uZmlnLmNyZWRlbnRpYWxzLmVtYWlsO1xuICB2YXIgc2VydmljZUVtYWlsID0gdGhpcy5fY29uZmlnLmNyZWRlbnRpYWxzLnNlcnZpY2VFbWFpbDtcbiAgdmFyIHByaXZhdGVLZXkgPSB0aGlzLl9jb25maWcuY3JlZGVudGlhbHMuY2VydGlmaWNhdGU7XG4gIHZhciBhcGlWZXJzaW9uID0gdGhpcy5fY29uZmlnLm9wdGlvbnMuYXBpVmVyc2lvbjtcblxuICB2YXIgZGF0YUFkYXB0ZXJSdW5TdGF0cyA9IHtcbiAgICBzdWNjZXNzOiB0cnVlLFxuICAgIHJ1bkRhdGU6IG1vbWVudCgpLnV0YygpLnRvRGF0ZSgpLFxuICAgIGZpbHRlclN0YXJ0RGF0ZTogZmlsdGVyU3RhcnREYXRlLFxuICAgIGZpbHRlckVuZERhdGU6IGZpbHRlckVuZERhdGUsXG4gICAgZW1haWxzOiBlbWFpbHNcbiAgfTtcblxuICAvL2ZpcnN0IHRyeSB0byBnZXQgdG9rZW4gZm9yIHRoZSBhZG1pbiAtIGlmIHRoYXQgZmFpbHMsIHRoZW4gYWxsIHdpbGwgZmFpbFxuICByZXR1cm4gZ2V0QWNjZXNzVG9rZW4oY2xpZW50SWQsIHNlcnZpY2VFbWFpbCwgY2xpZW50RW1haWwsIHByaXZhdGVLZXkpXG4gIC50aGVuKGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBnZXRFbWFpbERhdGEoZW1haWxzLCBmaWx0ZXJTdGFydERhdGUsIGZpbHRlckVuZERhdGUsIGFkZGl0aW9uYWxGaWVsZHMsIGNsaWVudElkLCBzZXJ2aWNlRW1haWwsIHByaXZhdGVLZXksIGFwaVZlcnNpb24pO1xuICB9KVxuICAudGhlbihmdW5jdGlvbihlbWFpbERhdGEpIHtcbiAgICByZXR1cm4gbWFwRW1haWxEYXRhKGVtYWlsRGF0YSk7XG4gIH0pXG4gIC50aGVuKGZ1bmN0aW9uKG1hcHBlZEVtYWlsRGF0YSkge1xuICAgIGRhdGFBZGFwdGVyUnVuU3RhdHMucmVzdWx0cyA9IG1hcHBlZEVtYWlsRGF0YTtcbiAgICByZXR1cm4gZGF0YUFkYXB0ZXJSdW5TdGF0cztcbiAgfSlcbiAgLmNhdGNoKGZ1bmN0aW9uKGVycikge1xuICAgIGRhdGFBZGFwdGVyUnVuU3RhdHMuc3VjY2VzcyA9IGZhbHNlO1xuICAgIGRhdGFBZGFwdGVyUnVuU3RhdHMuZXJyb3JNZXNzYWdlID0gZXJyO1xuICAgIGNvbnNvbGUubG9nKCdHb29nbGVNYWlsIEdldEJhdGNoRGF0YSBFcnJvcjogJyArIEpTT04uc3RyaW5naWZ5KGVycikpO1xuICAgIHJldHVybiBkYXRhQWRhcHRlclJ1blN0YXRzO1xuICB9KTtcbn07XG5cbkdvb2dsZUFkYXB0ZXIucHJvdG90eXBlLnJ1bkNvbm5lY3Rpb25UZXN0ID0gZnVuY3Rpb24oY29ubmVjdGlvbkRhdGEpIHtcbiAgdmFyIF90aGlzID0gdGhpcztcbiAgX3RoaXMuX2NvbmZpZyA9IG5ldyBHb29nbGVNYWlsLkNvbmZpZ3VyYXRpb24oY29ubmVjdGlvbkRhdGEuY3JlZGVudGlhbHMpO1xuICB2YXIgZmlsdGVyU3RhcnREYXRlID0gbW9tZW50KCkudXRjKCkuc3RhcnRPZignZGF5JykuYWRkKC0xLCAnZGF5cycpLnRvRGF0ZSgpO1xuICB2YXIgZmlsdGVyRW5kRGF0ZSA9IG1vbWVudCgpLnV0YygpLnN0YXJ0T2YoJ2RheScpLnRvRGF0ZSgpO1xuICByZXR1cm4gX3RoaXMuZ2V0QmF0Y2hEYXRhKFtfdGhpcy5fY29uZmlnLmNyZWRlbnRpYWxzLmVtYWlsXSwgZmlsdGVyU3RhcnREYXRlLCBmaWx0ZXJFbmREYXRlLCAnJylcbiAgLnRoZW4oZnVuY3Rpb24oZGF0YSkge1xuICAgIGlmIChkYXRhLnN1Y2Nlc3MgJiYgZGF0YS5yZXN1bHRzWzBdKSB7XG4gICAgICAvL3RvIHNlZSBpZiBpdCByZWFsbHkgd29ya2VkLCB3ZSBuZWVkIHRvIHBhc3MgaW4gdGhlIGZpcnN0IHJlc3VsdFxuICAgICAgcmV0dXJuIGRhdGEucmVzdWx0c1swXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICB9KTtcbn07XG5cbkdvb2dsZUFkYXB0ZXIucHJvdG90eXBlLnJ1bk1lc3NhZ2VUZXN0ID0gZnVuY3Rpb24oY29ubmVjdGlvbkRhdGEpIHtcbiAgdmFyIF90aGlzID0gdGhpcztcbiAgX3RoaXMuX2NvbmZpZyA9IG5ldyBHb29nbGVNYWlsLkNvbmZpZ3VyYXRpb24oY29ubmVjdGlvbkRhdGEuY3JlZGVudGlhbHMpO1xuICB2YXIgZmlsdGVyU3RhcnREYXRlID0gbW9tZW50KCkudXRjKCkuc3RhcnRPZignZGF5JykuYWRkKC0xLCAnZGF5cycpLnRvRGF0ZSgpO1xuICB2YXIgZmlsdGVyRW5kRGF0ZSA9IG1vbWVudCgpLnV0YygpLnN0YXJ0T2YoJ2RheScpLmFkZCgxLCAnZGF5cycpLnRvRGF0ZSgpO1xuICByZXR1cm4gX3RoaXMuZ2V0QmF0Y2hEYXRhKFtfdGhpcy5fY29uZmlnLmNyZWRlbnRpYWxzLmVtYWlsXSwgZmlsdGVyU3RhcnREYXRlLCBmaWx0ZXJFbmREYXRlLCAnU3ViamVjdCxCb2R5UHJldmlldyxCb2R5JylcbiAgLnRoZW4oZnVuY3Rpb24oZGF0YSkge1xuICAgIGNvbnNvbGUubG9nKCdydW5NZXNzYWdlVGVzdCB3b3JrZWQnKTtcbiAgICBjb25zb2xlLmxvZyhkYXRhLnJlc3VsdHNbMF0pO1xuICB9KVxuICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgY29uc29sZS5sb2coJ3J1bk1lc3NhZ2VUZXN0IEVycm9yOiAnICsgSlNPTi5zdHJpbmdpZnkoZXJyKSk7XG4gIH0pO1xufTtcbiJdfQ==
//# sourceMappingURL=index.js.map
