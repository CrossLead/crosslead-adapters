'use strict';

var _Promise = require('babel-runtime/core-js/promise')['default'];

var crypto = require('crypto');
var rp = require('request-promise');
var util = require('util');
var BaseAdapter = require('../base/Adapter');
var GoogleMail = require('./google-js.js');
var moment = require('moment');
var querystring = require('querystring');
var _ = require('lodash');

var GoogleAdapter = module.exports = function GoogleAdapter() {
  BaseAdapter.call(this);
};

util.inherits(GoogleAdapter, BaseAdapter);

GoogleAdapter.prototype.init = function () {
  var _this = this;
  this._config = new GoogleMail.Configuration(this.credentials);
  this._service = new GoogleMail.Service(this._config);
  return this._service.init().then(function () /*client*/{
    var msg = 'Successfully initialized gmail adapter for email: %s';
    console.log(msg, _this.credentials.email);
    return _this;
  });
};

GoogleAdapter.prototype.reset = function () {
  delete this._config;
  delete this._service;
};

var getSingleMessageDetails = function getSingleMessageDetails(messageId, userEmail, token, apiVersion, additionalFields, result) {
  var additionalFieldsToQuery = additionalFields.replace('BodyPreview', 'snippet');
  additionalFieldsToQuery = additionalFieldsToQuery.replace('Body', 'payload(parts)');
  additionalFieldsToQuery = additionalFieldsToQuery.replace('Subject', 'payload(parts)');

  if (additionalFieldsToQuery !== '') {
    additionalFieldsToQuery = ',' + additionalFieldsToQuery;
  }

  var messageRequestOptions = {
    method: 'GET',
    uri: 'https://www.googleapis.com/gmail/v' + apiVersion + '/users/' + userEmail + '/messages/' + messageId + '?fields=id,threadId,labelIds,payload(headers)' + additionalFieldsToQuery,
    headers: {
      Authorization: 'Bearer ' + token,
      Accept: 'application/json;odata.metadata=none'
    }
  };
  return rp(messageRequestOptions).then(function (messageDetails) {
    result.messageData = JSON.parse(messageDetails);
    if (additionalFields.indexOf('Subject') === -1) {
      //remove subject header
      if (result.messageData.payload && result.messageData.payload.headers && result.messageData.payload.headers.length > 0) {
        for (var headerIter = 0; headerIter < result.messageData.payload.headers.length; headerIter++) {
          if (result.messageData.payload.headers[headerIter].name === 'Subject') {
            result.messageData.payload.headers[headerIter].value = '';
          }
        }
      }
    }

    return true;
  });
};

var getAccessToken = function getAccessToken(clientId, adminEmail, userEmail, privateKey) {
  var tokenRequestUrl = 'https://www.googleapis.com/oauth2/v3/token';
  var unixEpochTime = Math.floor(new Date().getTime() / 1000);

  var jwtHeader = {
    alg: 'RS256',
    typ: 'JWT'
  };

  var jwtPayload = {
    'iss': adminEmail,
    'scope': 'https://www.googleapis.com/auth/gmail.readonly',
    'aud': tokenRequestUrl,
    'exp': unixEpochTime + 3600,
    'iat': unixEpochTime,
    'sub': userEmail
  };

  var encodedJwtHeader = new Buffer(JSON.stringify(jwtHeader)).toString('base64');
  var encodedJwtPayload = new Buffer(JSON.stringify(jwtPayload)).toString('base64');
  var stringToSign = encodedJwtHeader + '.' + encodedJwtPayload;

  //sign it!
  var signer = crypto.createSign('RSA-SHA256');
  signer.update(stringToSign);

  var encodedSignedJwtInfo = signer.sign(privateKey, 'base64');

  //define assertion
  var clientAssertion = encodedJwtHeader + '.' + encodedJwtPayload + '.' + encodedSignedJwtInfo;

  var tokenRequestFormData = {
    grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
    assertion: clientAssertion
  };

  var requestData = querystring.stringify(tokenRequestFormData);
  var requestDataLength = requestData.length;

  var tokenRequestOptions = {
    method: 'POST',
    port: 443,
    uri: tokenRequestUrl,
    body: requestData,
    multipart: false,
    headers: {
      'Content-Length': requestDataLength,
      'Content-Type': 'application/x-www-form-urlencoded'
    }
  };

  return rp(tokenRequestOptions).then(function (body) {
    var tokenData = JSON.parse(body);
    if (tokenData && tokenData.access_token) {
      return tokenData.access_token;
    } else {
      return _Promise.reject('Could not get access token.');
    }
  })['catch'](function (err) {
    var tokenData = JSON.parse(JSON.stringify(err));
    if (tokenData.name === 'StatusCodeError') {
      var entireMessage = tokenData.message;
      var messageJson = entireMessage.replace(tokenData.statusCode + ' - ', '');
      var messageData = JSON.parse(messageJson.replace(new RegExp('\\"', 'g'), '"'));
      //console.log('-----');
      //console.log(messageData);
      return _Promise.reject(messageData);
    } else {
      return _Promise.reject(err);
    }
  });
};

var getUserEmails = function getUserEmails(clientId, serviceEmail, userEmail, privateKey, apiVersion, filterStartDate, filterEndDate, additionalFields, result) {
  var token = '';
  return getAccessToken(clientId, serviceEmail, userEmail, privateKey).then(function (tokenResponse) {
    token = tokenResponse;
    var emailRequestOptions = {
      method: 'GET',
      uri: 'https://www.googleapis.com/gmail/v' + apiVersion + '/users/' + userEmail + '/messages?q=after:' + filterStartDate.toISOString().substring(0, 10) + ' AND before: ' + filterEndDate.toISOString().substring(0, 10),
      headers: {
        Authorization: 'Bearer ' + token,
        Accept: 'application/json;odata.metadata=none'
      }
    };
    return rp(emailRequestOptions);
  }).then(function (body) {
    var messageDetailPromises = [];
    result.success = true;
    result.data = {};
    result.data.messageList = JSON.parse(body);
    result.data.messages = [];

    if (result.data.messageList.messages) {
      for (var messageIter = 0; messageIter < result.data.messageList.messages.length; messageIter++) {
        var messageId = result.data.messageList.messages[messageIter].id;
        result.data.messages.push({ messageId: messageId });
        messageDetailPromises.push(getSingleMessageDetails(messageId, userEmail, token, apiVersion, additionalFields, result.data.messages[messageIter]));
      }
    }

    return _Promise.all(messageDetailPromises);
  })['catch'](function (err) {
    result.success = false;
    if (err.name === 'StatusCodeError') {
      var entireMessage = err.message;
      var messageJson = entireMessage.replace(err.statusCode + ' - ', '');
      var messageData = JSON.parse(messageJson.replace(new RegExp('\\"', 'g'), '"'));
      result.errorMessage = messageData.error.message;
    } else {
      result.errorMessage = JSON.stringify(err);
    }
    return true;
  });
};

var getHeaderValue = function getHeaderValue(message, headerName) {
  var headerValues = _(message.payload.headers).filter(function (header) {
    return header.name === headerName;
  }).pluck('value').value();
  if (headerValues.length > 0) {
    return headerValues[0];
  } else {
    return null;
  }
};

var getEmailAddressObjectFromString = function getEmailAddressObjectFromString(value) {
  var returnObject = {
    name: value,
    address: value
  };

  if (value && value.indexOf('>') > 0) {
    var valueArray = value.split(' ');
    returnObject.address = valueArray[valueArray.length - 1].replace('<', '').replace('>', '');
    returnObject.name = value.replace(' ' + valueArray[valueArray.length - 1], '');
  }

  return returnObject;
};

var convertEmailListToArrayOfEmailAddressObjects = function convertEmailListToArrayOfEmailAddressObjects(emailList) {
  var emailAddressObjectArray = [];
  if (emailList) {
    var emailArray = emailList.split(',');
    for (var emailIter = 0; emailIter < emailArray.length; emailIter++) {
      emailAddressObjectArray.push(getEmailAddressObjectFromString(emailArray[emailIter]));
    }
  }

  return emailAddressObjectArray;
};

var hasLabel = function hasLabel(message, labelValue) {
  return message.labelIds.indexOf(labelValue) >= 0;
};

var mapEmailData = function mapEmailData(emailData) {
  var mappedData = [];

  for (var userIter = 0; userIter < emailData.length; userIter++) {
    var mappedUser = {
      email: emailData[userIter].email,
      filterStartDate: emailData[userIter].filterStartDate,
      filterEndDate: emailData[userIter].filterEndDate,
      data: [],
      success: emailData[userIter].success,
      errorMessage: emailData[userIter].errorMessage
    };

    if (emailData[userIter].success) {
      for (var i = 0; i < emailData[userIter].data['messages'].length; i++) {
        var originalEmailMessage = emailData[userIter].data['messages'][i];
        var mappedEmailMessage = {};

        mappedEmailMessage = originalEmailMessage;
        var messageData = originalEmailMessage.messageData;

        mappedEmailMessage.messageId = originalEmailMessage.messageId;
        mappedEmailMessage.conversationId = messageData.threadId;
        mappedEmailMessage.dateTimeSent = moment(new Date(getHeaderValue(messageData, 'Date'))).utc().toDate();

        var dateReceived = getHeaderValue(messageData, 'Received');
        if (dateReceived) {
          var datePartOfValue = dateReceived.split(';')[1];
          mappedEmailMessage.dateTimeReceived = moment(new Date(datePartOfValue)).utc().toDate();
        }

        mappedEmailMessage.importance = 'Normal';
        if (hasLabel(messageData, 'IMPORTANT')) {
          mappedEmailMessage.importance = 'Important';
        }

        mappedEmailMessage.categories = messageData.labelIds;

        if (hasLabel(messageData, 'SENT')) {
          mappedEmailMessage.folderId = 'Sent Items';
          mappedEmailMessage.folderName = 'Sent Items';
        } else {
          mappedEmailMessage.folderId = 'Inbox';
          mappedEmailMessage.folderName = 'Inbox';
        }

        mappedEmailMessage.subject = getHeaderValue(messageData, 'Subject');
        mappedEmailMessage.bodyPreview = messageData.snippet;

        if (messageData.payload.parts && messageData.payload.parts.length > 0) {
          mappedEmailMessage.contentType = messageData.payload.parts[0].mimeType;
          mappedEmailMessage.body = new Buffer(messageData.payload.parts[0].body.data, 'base64').toString();
        }

        mappedEmailMessage.isDeliveryReceiptRequested = null;
        mappedEmailMessage.isReadReceiptRequested = null;
        mappedEmailMessage.hasAttachments = null;
        mappedEmailMessage.isDraft = null;
        mappedEmailMessage.isRead = hasLabel(messageData, 'READ');

        mappedEmailMessage.fromAddress = getEmailAddressObjectFromString(getHeaderValue(messageData, 'From')).address;
        mappedEmailMessage.fromName = getEmailAddressObjectFromString(getHeaderValue(messageData, 'From')).name;

        mappedEmailMessage.toRecipients = convertEmailListToArrayOfEmailAddressObjects(getHeaderValue(messageData, 'To'));
        mappedEmailMessage.ccRecipients = convertEmailListToArrayOfEmailAddressObjects(getHeaderValue(messageData, 'Cc'));
        mappedEmailMessage.bccRecipients = convertEmailListToArrayOfEmailAddressObjects(getHeaderValue(messageData, 'Bcc'));

        mappedUser.data.push(mappedEmailMessage);
      }
    }
    mappedData.push(mappedUser);
  }

  return mappedData;
};

var getEmailData = function getEmailData(emails, filterStartDate, filterEndDate, additionalFields, clientId, serviceEmail, privateKey, apiVersion) {
  var emailResults = [];
  var emailResultPromises = [];
  var emailIter = 0;
  for (emailIter = 0; emailIter < emails.length; emailIter++) {
    emailResults[emailIter] = { email: emails[emailIter], filterStartDate: filterStartDate, filterEndDate: filterEndDate };
    emailResultPromises.push(getUserEmails(clientId, serviceEmail, emails[emailIter], privateKey, apiVersion, filterStartDate, filterEndDate, additionalFields, emailResults[emailIter]));
  }

  return _Promise.all(emailResultPromises).then(function () {
    return emailResults;
  });
};

GoogleAdapter.prototype.getBatchData = function (emails, filterStartDate, filterEndDate, additionalFields) {
  var clientId = this._config.credentials.clientId;
  var clientEmail = this._config.credentials.email;
  var serviceEmail = this._config.credentials.serviceEmail;
  var privateKey = this._config.credentials.certificate;
  var apiVersion = this._config.options.apiVersion;

  var dataAdapterRunStats = {
    success: true,
    runDate: moment().utc().toDate(),
    filterStartDate: filterStartDate,
    filterEndDate: filterEndDate,
    emails: emails
  };

  //first try to get token for the admin - if that fails, then all will fail
  return getAccessToken(clientId, serviceEmail, clientEmail, privateKey).then(function () {
    return getEmailData(emails, filterStartDate, filterEndDate, additionalFields, clientId, serviceEmail, privateKey, apiVersion);
  }).then(function (emailData) {
    return mapEmailData(emailData);
  }).then(function (mappedEmailData) {
    dataAdapterRunStats.results = mappedEmailData;
    return dataAdapterRunStats;
  })['catch'](function (err) {
    dataAdapterRunStats.success = false;
    dataAdapterRunStats.errorMessage = err;
    console.log('GoogleMail GetBatchData Error: ' + JSON.stringify(err));
    return dataAdapterRunStats;
  });
};

GoogleAdapter.prototype.runConnectionTest = function (connectionData) {
  var _this = this;
  _this._config = new GoogleMail.Configuration(connectionData.credentials);
  var filterStartDate = moment().utc().startOf('day').add(-1, 'days').toDate();
  var filterEndDate = moment().utc().startOf('day').toDate();
  return _this.getBatchData([_this._config.credentials.email], filterStartDate, filterEndDate, '').then(function (data) {
    if (data.success && data.results[0]) {
      //to see if it really worked, we need to pass in the first result
      return data.results[0];
    } else {
      return data;
    }
  });
};

GoogleAdapter.prototype.runMessageTest = function (connectionData) {
  var _this = this;
  _this._config = new GoogleMail.Configuration(connectionData.credentials);
  var filterStartDate = moment().utc().startOf('day').add(-1, 'days').toDate();
  var filterEndDate = moment().utc().startOf('day').add(1, 'days').toDate();
  return _this.getBatchData([_this._config.credentials.email], filterStartDate, filterEndDate, 'Subject,BodyPreview,Body').then(function (data) {
    console.log('runMessageTest worked');
    console.log(data.results[0]);
  })['catch'](function (err) {
    console.log('runMessageTest Error: ' + JSON.stringify(err));
  });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNsQWRhcHRlcnMvZ29vZ2xlLW1haWwvaW5kZXguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDOzs7O0FBRWIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3BDLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQixJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUM3QyxJQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztBQUMzQyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDL0IsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ3pDLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQzs7QUFFMUIsSUFBSSxhQUFhLEdBQUcsTUFBTSxDQUFDLE9BQU8sR0FBRyxTQUFTLGFBQWEsR0FBRztBQUM1RCxhQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0NBQ3hCLENBQUM7O0FBRUYsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsV0FBVyxDQUFDLENBQUM7O0FBRTFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsSUFBSSxHQUFHLFlBQVc7QUFDeEMsTUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLE1BQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxVQUFVLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUM5RCxNQUFJLENBQUMsUUFBUSxHQUFHLElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDckQsU0FBTyxJQUFJLENBQUMsUUFBUSxDQUNqQixJQUFJLEVBQUUsQ0FDTixJQUFJLENBQUMsc0JBQXVCO0FBQzNCLFFBQUksR0FBRyxHQUFHLHNEQUFzRCxDQUFDO0FBQ2pFLFdBQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDMUMsV0FBTyxLQUFLLENBQUM7R0FDZCxDQUFDLENBQUM7Q0FDTixDQUFDOztBQUVGLGFBQWEsQ0FBQyxTQUFTLENBQUMsS0FBSyxHQUFHLFlBQVc7QUFDekMsU0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0FBQ3BCLFNBQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztDQUN0QixDQUFDOztBQUVGLElBQUksdUJBQXVCLEdBQUcsU0FBMUIsdUJBQXVCLENBQVksU0FBUyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLGdCQUFnQixFQUFFLE1BQU0sRUFBRTtBQUN4RyxNQUFJLHVCQUF1QixHQUFHLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsU0FBUyxDQUFDLENBQUM7QUFDakYseUJBQXVCLEdBQUcsdUJBQXVCLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0FBQ3BGLHlCQUF1QixHQUFHLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQzs7QUFFdkYsTUFBSSx1QkFBdUIsS0FBSyxFQUFFLEVBQUU7QUFDbEMsMkJBQXVCLEdBQUcsR0FBRyxHQUFHLHVCQUF1QixDQUFDO0dBQ3pEOztBQUVELE1BQUkscUJBQXFCLEdBQUc7QUFDMUIsVUFBTSxFQUFFLEtBQUs7QUFDYixPQUFHLEVBQUUsb0NBQW9DLEdBQUcsVUFBVSxHQUFHLFNBQVMsR0FBRyxTQUFTLEdBQUcsWUFBWSxHQUFHLFNBQVMsR0FBRywrQ0FBK0MsR0FBRyx1QkFBdUI7QUFDckwsV0FBTyxFQUFHO0FBQ1IsbUJBQWEsRUFBRSxTQUFTLEdBQUcsS0FBSztBQUNoQyxZQUFNLEVBQUUsc0NBQXNDO0tBQy9DO0dBQ0YsQ0FBQztBQUNGLFNBQU8sRUFBRSxDQUFDLHFCQUFxQixDQUFDLENBQy9CLElBQUksQ0FBQyxVQUFTLGNBQWMsRUFBRTtBQUM3QixVQUFNLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDaEQsUUFBSSxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7O0FBRTlDLFVBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLElBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO0FBQ3JILGFBQUssSUFBSSxVQUFVLEdBQUcsQ0FBQyxFQUFFLFVBQVUsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxFQUFFO0FBQzdGLGNBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUU7QUFDckUsa0JBQU0sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1dBQzNEO1NBQ0Y7T0FDRjtLQUNGOztBQUVELFdBQU8sSUFBSSxDQUFDO0dBQ2IsQ0FBQyxDQUFDO0NBQ0osQ0FBQzs7QUFFRixJQUFJLGNBQWMsR0FBRyxTQUFqQixjQUFjLENBQVksUUFBUSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFO0FBQ3pFLE1BQUksZUFBZSxHQUFHLDRDQUE0QyxDQUFDO0FBQ25FLE1BQUksYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQUFBQyxJQUFJLElBQUksRUFBRSxDQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDOztBQUU5RCxNQUFJLFNBQVMsR0FBRztBQUNkLE9BQUcsRUFBRSxPQUFPO0FBQ1osT0FBRyxFQUFFLEtBQUs7R0FDWCxDQUFDOztBQUVGLE1BQUksVUFBVSxHQUFHO0FBQ2YsU0FBSyxFQUFFLFVBQVU7QUFDakIsV0FBTyxFQUFFLGdEQUFnRDtBQUN6RCxTQUFLLEVBQUUsZUFBZTtBQUN0QixTQUFLLEVBQUUsYUFBYSxHQUFHLElBQUk7QUFDM0IsU0FBSyxFQUFFLGFBQWE7QUFDcEIsU0FBSyxFQUFFLFNBQVM7R0FDakIsQ0FBQzs7QUFFRixNQUFJLGdCQUFnQixHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDaEYsTUFBSSxpQkFBaUIsR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2xGLE1BQUksWUFBWSxHQUFHLGdCQUFnQixHQUFHLEdBQUcsR0FBRyxpQkFBaUIsQ0FBQzs7O0FBRzlELE1BQUksTUFBTSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDN0MsUUFBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQzs7QUFFNUIsTUFBSSxvQkFBb0IsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQzs7O0FBRzdELE1BQUksZUFBZSxHQUFHLGdCQUFnQixHQUFHLEdBQUcsR0FBRyxpQkFBaUIsR0FBRyxHQUFHLEdBQUcsb0JBQW9CLENBQUM7O0FBRTlGLE1BQUksb0JBQW9CLEdBQUc7QUFDekIsY0FBVSxFQUFFLDZDQUE2QztBQUN6RCxhQUFTLEVBQUUsZUFBZTtHQUMzQixDQUFDOztBQUVGLE1BQUksV0FBVyxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUMsb0JBQW9CLENBQUMsQ0FBQztBQUM5RCxNQUFJLGlCQUFpQixHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUM7O0FBRTNDLE1BQUksbUJBQW1CLEdBQUc7QUFDeEIsVUFBTSxFQUFFLE1BQU07QUFDZCxRQUFJLEVBQUUsR0FBRztBQUNULE9BQUcsRUFBRSxlQUFlO0FBQ3BCLFFBQUksRUFBRSxXQUFXO0FBQ2pCLGFBQVMsRUFBRSxLQUFLO0FBQ2hCLFdBQU8sRUFBRTtBQUNQLHNCQUFnQixFQUFFLGlCQUFpQjtBQUNuQyxvQkFBYyxFQUFFLG1DQUFtQztLQUNwRDtHQUNGLENBQUM7O0FBRUYsU0FBTyxFQUFFLENBQUMsbUJBQW1CLENBQUMsQ0FDN0IsSUFBSSxDQUFDLFVBQVMsSUFBSSxFQUFFO0FBQ25CLFFBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDakMsUUFBSSxTQUFTLElBQUksU0FBUyxDQUFDLFlBQVksRUFBRTtBQUN2QyxhQUFPLFNBQVMsQ0FBQyxZQUFZLENBQUM7S0FDL0IsTUFBTTtBQUNMLGFBQU8sU0FBUSxNQUFNLENBQUMsNkJBQTZCLENBQUMsQ0FBQztLQUN0RDtHQUNGLENBQUMsU0FDSSxDQUFDLFVBQVMsR0FBRyxFQUFFO0FBQ25CLFFBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ2hELFFBQUksU0FBUyxDQUFDLElBQUksS0FBSyxpQkFBaUIsRUFBRTtBQUN4QyxVQUFJLGFBQWEsR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDO0FBQ3RDLFVBQUksV0FBVyxHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDMUUsVUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsRUFBQyxHQUFHLENBQUMsQ0FBQyxDQUFDOzs7QUFHOUUsYUFBTyxTQUFRLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztLQUNwQyxNQUFNO0FBQ0wsYUFBTyxTQUFRLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUM1QjtHQUNGLENBQUMsQ0FBQztDQUNKLENBQUM7O0FBRUYsSUFBSSxhQUFhLEdBQUcsU0FBaEIsYUFBYSxDQUFZLFFBQVEsRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUU7QUFDaEosTUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDO0FBQ2YsU0FBTyxjQUFjLENBQUMsUUFBUSxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQ25FLElBQUksQ0FBQyxVQUFTLGFBQWEsRUFBRTtBQUM1QixTQUFLLEdBQUcsYUFBYSxDQUFDO0FBQ3RCLFFBQUksbUJBQW1CLEdBQUc7QUFDeEIsWUFBTSxFQUFFLEtBQUs7QUFDYixTQUFHLEVBQUUsb0NBQW9DLEdBQUcsVUFBVSxHQUFHLFNBQVMsR0FBRyxTQUFTLEdBQUcsb0JBQW9CLEdBQUcsZUFBZSxDQUFDLFdBQVcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsZUFBZSxHQUFHLGFBQWEsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUN2TixhQUFPLEVBQUc7QUFDUixxQkFBYSxFQUFFLFNBQVMsR0FBRyxLQUFLO0FBQ2hDLGNBQU0sRUFBRSxzQ0FBc0M7T0FDL0M7S0FDRixDQUFDO0FBQ0YsV0FBTyxFQUFFLENBQUMsbUJBQW1CLENBQUMsQ0FBQztHQUNoQyxDQUFDLENBQ0QsSUFBSSxDQUFDLFVBQVMsSUFBSSxFQUFFO0FBQ25CLFFBQUkscUJBQXFCLEdBQUcsRUFBRSxDQUFDO0FBQy9CLFVBQU0sQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO0FBQ3RCLFVBQU0sQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQ2pCLFVBQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDM0MsVUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDOztBQUUxQixRQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRTtBQUNwQyxXQUFLLElBQUksV0FBVyxHQUFHLENBQUMsRUFBRSxXQUFXLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxXQUFXLEVBQUUsRUFBRTtBQUM5RixZQUFJLFNBQVMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsRUFBRSxDQUFDO0FBQ2pFLGNBQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUMsQ0FBQyxDQUFDO0FBQ2xELDZCQUFxQixDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO09BQ25KO0tBQ0Y7O0FBRUQsV0FBTyxTQUFRLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0dBQzNDLENBQUMsU0FDSSxDQUFDLFVBQVMsR0FBRyxFQUFFO0FBQ25CLFVBQU0sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO0FBQ3ZCLFFBQUksR0FBRyxDQUFDLElBQUksS0FBSyxpQkFBaUIsRUFBRTtBQUNsQyxVQUFJLGFBQWEsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDO0FBQ2hDLFVBQUksV0FBVyxHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsR0FBRyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDcEUsVUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLElBQUksTUFBTSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsRUFBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQzlFLFlBQU0sQ0FBQyxZQUFZLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUM7S0FDakQsTUFBTTtBQUNMLFlBQU0sQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUMzQztBQUNELFdBQU8sSUFBSSxDQUFDO0dBQ2IsQ0FBQyxDQUFDO0NBQ0osQ0FBQzs7QUFFRixJQUFJLGNBQWMsR0FBRyxTQUFqQixjQUFjLENBQVksT0FBTyxFQUFFLFVBQVUsRUFBRTtBQUNqRCxNQUFJLFlBQVksR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FDcEMsTUFBTSxDQUFDLFVBQVMsTUFBTSxFQUFFO0FBQUUsV0FBTyxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQztHQUFFLENBQUMsQ0FDL0QsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUNkLEtBQUssRUFBRSxDQUFDO0FBQ2pCLE1BQUksWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7QUFDM0IsV0FBTyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7R0FDeEIsTUFBTTtBQUNMLFdBQU8sSUFBSSxDQUFDO0dBQ2I7Q0FDRixDQUFDOztBQUVGLElBQUksK0JBQStCLEdBQUcsU0FBbEMsK0JBQStCLENBQVksS0FBSyxFQUFFO0FBQ3BELE1BQUksWUFBWSxHQUFHO0FBQ2pCLFFBQUksRUFBRSxLQUFLO0FBQ1gsV0FBTyxFQUFFLEtBQUs7R0FDZixDQUFDOztBQUVGLE1BQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFO0FBQ25DLFFBQUksVUFBVSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDbEMsZ0JBQVksQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQzNGLGdCQUFZLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0dBQ2hGOztBQUVELFNBQU8sWUFBWSxDQUFDO0NBQ3JCLENBQUM7O0FBRUYsSUFBSSw0Q0FBNEMsR0FBRyxTQUEvQyw0Q0FBNEMsQ0FBWSxTQUFTLEVBQUU7QUFDckUsTUFBSSx1QkFBdUIsR0FBRyxFQUFFLENBQUM7QUFDakMsTUFBSSxTQUFTLEVBQUU7QUFDYixRQUFJLFVBQVUsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3RDLFNBQUssSUFBSSxTQUFTLEdBQUcsQ0FBQyxFQUFFLFNBQVMsR0FBRyxVQUFVLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxFQUFFO0FBQ2xFLDZCQUF1QixDQUFDLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3RGO0dBQ0Y7O0FBRUQsU0FBTyx1QkFBdUIsQ0FBQztDQUNoQyxDQUFDOztBQUVGLElBQUksUUFBUSxHQUFHLFNBQVgsUUFBUSxDQUFZLE9BQU8sRUFBRSxVQUFVLEVBQUU7QUFDM0MsU0FBTyxPQUFPLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7Q0FDbEQsQ0FBQzs7QUFFRixJQUFJLFlBQVksR0FBRyxTQUFmLFlBQVksQ0FBWSxTQUFTLEVBQUU7QUFDckMsTUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDOztBQUVwQixPQUFLLElBQUksUUFBUSxHQUFHLENBQUMsRUFBRSxRQUFRLEdBQUcsU0FBUyxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsRUFBRTtBQUM5RCxRQUFJLFVBQVUsR0FBRztBQUNmLFdBQUssRUFBRSxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSztBQUNoQyxxQkFBZSxFQUFFLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxlQUFlO0FBQ3BELG1CQUFhLEVBQUUsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLGFBQWE7QUFDaEQsVUFBSSxFQUFFLEVBQUU7QUFDUixhQUFPLEVBQUUsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU87QUFDcEMsa0JBQVksRUFBRSxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsWUFBWTtLQUMvQyxDQUFDOztBQUVGLFFBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sRUFBRTtBQUMvQixXQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDcEUsWUFBSSxvQkFBb0IsR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ25FLFlBQUksa0JBQWtCLEdBQUcsRUFBRSxDQUFDOztBQUU1QiwwQkFBa0IsR0FBRyxvQkFBb0IsQ0FBQztBQUMxQyxZQUFJLFdBQVcsR0FBRyxvQkFBb0IsQ0FBQyxXQUFXLENBQUM7O0FBRW5ELDBCQUFrQixDQUFDLFNBQVMsR0FBRyxvQkFBb0IsQ0FBQyxTQUFTLENBQUM7QUFDOUQsMEJBQWtCLENBQUMsY0FBYyxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUM7QUFDekQsMEJBQWtCLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQzs7QUFFdkcsWUFBSSxZQUFZLEdBQUcsY0FBYyxDQUFDLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FBQztBQUMzRCxZQUFJLFlBQVksRUFBRTtBQUNoQixjQUFJLGVBQWUsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2pELDRCQUFrQixDQUFDLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ3hGOztBQUVELDBCQUFrQixDQUFDLFVBQVUsR0FBRyxRQUFRLENBQUM7QUFDekMsWUFBSSxRQUFRLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxFQUFFO0FBQ3RDLDRCQUFrQixDQUFDLFVBQVUsR0FBRyxXQUFXLENBQUM7U0FDN0M7O0FBRUQsMEJBQWtCLENBQUMsVUFBVSxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUM7O0FBRXJELFlBQUksUUFBUSxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsRUFBRTtBQUNqQyw0QkFBa0IsQ0FBQyxRQUFRLEdBQUcsWUFBWSxDQUFDO0FBQzNDLDRCQUFrQixDQUFDLFVBQVUsR0FBRyxZQUFZLENBQUM7U0FDOUMsTUFBTTtBQUNMLDRCQUFrQixDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7QUFDdEMsNEJBQWtCLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQztTQUN6Qzs7QUFFRCwwQkFBa0IsQ0FBQyxPQUFPLEdBQUcsY0FBYyxDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQztBQUNwRSwwQkFBa0IsQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQzs7QUFFckQsWUFBSSxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO0FBQ3JFLDRCQUFrQixDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7QUFDdkUsNEJBQWtCLENBQUMsSUFBSSxHQUFHLElBQUksTUFBTSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDbkc7O0FBRUQsMEJBQWtCLENBQUMsMEJBQTBCLEdBQUcsSUFBSSxDQUFDO0FBQ3JELDBCQUFrQixDQUFDLHNCQUFzQixHQUFHLElBQUksQ0FBQztBQUNqRCwwQkFBa0IsQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO0FBQ3pDLDBCQUFrQixDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7QUFDbEMsMEJBQWtCLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUM7O0FBRTFELDBCQUFrQixDQUFDLFdBQVcsR0FBRywrQkFBK0IsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO0FBQzlHLDBCQUFrQixDQUFDLFFBQVEsR0FBRywrQkFBK0IsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDOztBQUV4RywwQkFBa0IsQ0FBQyxZQUFZLEdBQUcsNENBQTRDLENBQUMsY0FBYyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ2xILDBCQUFrQixDQUFDLFlBQVksR0FBRyw0Q0FBNEMsQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDbEgsMEJBQWtCLENBQUMsYUFBYSxHQUFHLDRDQUE0QyxDQUFDLGNBQWMsQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQzs7QUFFcEgsa0JBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7T0FDMUM7S0FDRjtBQUNELGNBQVUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7R0FDN0I7O0FBRUQsU0FBTyxVQUFVLENBQUM7Q0FDbkIsQ0FBQzs7QUFFRixJQUFJLFlBQVksR0FBRyxTQUFmLFlBQVksQ0FBWSxNQUFNLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUU7QUFDcEksTUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFDO0FBQ3RCLE1BQUksbUJBQW1CLEdBQUcsRUFBRSxDQUFDO0FBQzdCLE1BQUksU0FBUyxHQUFHLENBQUMsQ0FBQztBQUNsQixPQUFLLFNBQVMsR0FBRyxDQUFDLEVBQUUsU0FBUyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLEVBQUU7QUFDMUQsZ0JBQVksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUUsZUFBZSxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsYUFBYSxFQUFDLENBQUM7QUFDckgsdUJBQW1CLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsWUFBWSxFQUFFLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsZ0JBQWdCLEVBQUUsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztHQUN2TDs7QUFFRCxTQUFPLFNBQVEsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQ3RDLElBQUksQ0FBQyxZQUFXO0FBQ2YsV0FBTyxZQUFZLENBQUM7R0FDckIsQ0FBQyxDQUFDO0NBQ0osQ0FBQzs7QUFFRixhQUFhLENBQUMsU0FBUyxDQUFDLFlBQVksR0FBRyxVQUFTLE1BQU0sRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLGdCQUFnQixFQUFFO0FBQ3hHLE1BQUksUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQztBQUNqRCxNQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUM7QUFDakQsTUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDO0FBQ3pELE1BQUksVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQztBQUN0RCxNQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUM7O0FBRWpELE1BQUksbUJBQW1CLEdBQUc7QUFDeEIsV0FBTyxFQUFFLElBQUk7QUFDYixXQUFPLEVBQUUsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsTUFBTSxFQUFFO0FBQ2hDLG1CQUFlLEVBQUUsZUFBZTtBQUNoQyxpQkFBYSxFQUFFLGFBQWE7QUFDNUIsVUFBTSxFQUFFLE1BQU07R0FDZixDQUFDOzs7QUFHRixTQUFPLGNBQWMsQ0FBQyxRQUFRLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxVQUFVLENBQUMsQ0FDckUsSUFBSSxDQUFDLFlBQVc7QUFDZixXQUFPLFlBQVksQ0FBQyxNQUFNLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxRQUFRLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxVQUFVLENBQUMsQ0FBQztHQUMvSCxDQUFDLENBQ0QsSUFBSSxDQUFDLFVBQVMsU0FBUyxFQUFFO0FBQ3hCLFdBQU8sWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0dBQ2hDLENBQUMsQ0FDRCxJQUFJLENBQUMsVUFBUyxlQUFlLEVBQUU7QUFDOUIsdUJBQW1CLENBQUMsT0FBTyxHQUFHLGVBQWUsQ0FBQztBQUM5QyxXQUFPLG1CQUFtQixDQUFDO0dBQzVCLENBQUMsU0FDSSxDQUFDLFVBQVMsR0FBRyxFQUFFO0FBQ25CLHVCQUFtQixDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7QUFDcEMsdUJBQW1CLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQztBQUN2QyxXQUFPLENBQUMsR0FBRyxDQUFDLGlDQUFpQyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztBQUNyRSxXQUFPLG1CQUFtQixDQUFDO0dBQzVCLENBQUMsQ0FBQztDQUNKLENBQUM7O0FBRUYsYUFBYSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsR0FBRyxVQUFTLGNBQWMsRUFBRTtBQUNuRSxNQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7QUFDakIsT0FBSyxDQUFDLE9BQU8sR0FBRyxJQUFJLFVBQVUsQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ3pFLE1BQUksZUFBZSxHQUFHLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDN0UsTUFBSSxhQUFhLEdBQUcsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQzNELFNBQU8sS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQy9GLElBQUksQ0FBQyxVQUFTLElBQUksRUFBRTtBQUNuQixRQUFJLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTs7QUFFbkMsYUFBTyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3hCLE1BQU07QUFDTCxhQUFPLElBQUksQ0FBQztLQUNiO0dBQ0YsQ0FBQyxDQUFDO0NBQ0osQ0FBQzs7QUFFRixhQUFhLENBQUMsU0FBUyxDQUFDLGNBQWMsR0FBRyxVQUFTLGNBQWMsRUFBRTtBQUNoRSxNQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7QUFDakIsT0FBSyxDQUFDLE9BQU8sR0FBRyxJQUFJLFVBQVUsQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQ3pFLE1BQUksZUFBZSxHQUFHLE1BQU0sRUFBRSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDN0UsTUFBSSxhQUFhLEdBQUcsTUFBTSxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDMUUsU0FBTyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBRSwwQkFBMEIsQ0FBQyxDQUN2SCxJQUFJLENBQUMsVUFBUyxJQUFJLEVBQUU7QUFDbkIsV0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0FBQ3JDLFdBQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0dBQzlCLENBQUMsU0FDSSxDQUFDLFVBQVMsR0FBRyxFQUFFO0FBQ25CLFdBQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0dBQzdELENBQUMsQ0FBQztDQUNKLENBQUMiLCJmaWxlIjoiY2xBZGFwdGVycy9nb29nbGUtbWFpbC9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xudmFyIHJwID0gcmVxdWlyZSgncmVxdWVzdC1wcm9taXNlJyk7XG52YXIgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcbnZhciBCYXNlQWRhcHRlciA9IHJlcXVpcmUoJy4uL2Jhc2UvQWRhcHRlcicpO1xudmFyIEdvb2dsZU1haWwgPSByZXF1aXJlKCcuL2dvb2dsZS1qcy5qcycpO1xudmFyIG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudCcpO1xudmFyIHF1ZXJ5c3RyaW5nID0gcmVxdWlyZSgncXVlcnlzdHJpbmcnKTtcbnZhciBfID0gcmVxdWlyZSgnbG9kYXNoJyk7XG5cbnZhciBHb29nbGVBZGFwdGVyID0gbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbiBHb29nbGVBZGFwdGVyKCkge1xuICBCYXNlQWRhcHRlci5jYWxsKHRoaXMpO1xufTtcblxudXRpbC5pbmhlcml0cyhHb29nbGVBZGFwdGVyLCBCYXNlQWRhcHRlcik7XG5cbkdvb2dsZUFkYXB0ZXIucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbigpIHtcbiAgdmFyIF90aGlzID0gdGhpcztcbiAgdGhpcy5fY29uZmlnID0gbmV3IEdvb2dsZU1haWwuQ29uZmlndXJhdGlvbih0aGlzLmNyZWRlbnRpYWxzKTtcbiAgdGhpcy5fc2VydmljZSA9IG5ldyBHb29nbGVNYWlsLlNlcnZpY2UodGhpcy5fY29uZmlnKTtcbiAgcmV0dXJuIHRoaXMuX3NlcnZpY2VcbiAgICAuaW5pdCgpXG4gICAgLnRoZW4oZnVuY3Rpb24oIC8qY2xpZW50Ki8gKSB7XG4gICAgICB2YXIgbXNnID0gJ1N1Y2Nlc3NmdWxseSBpbml0aWFsaXplZCBnbWFpbCBhZGFwdGVyIGZvciBlbWFpbDogJXMnO1xuICAgICAgY29uc29sZS5sb2cobXNnLCBfdGhpcy5jcmVkZW50aWFscy5lbWFpbCk7XG4gICAgICByZXR1cm4gX3RoaXM7XG4gICAgfSk7XG59O1xuXG5Hb29nbGVBZGFwdGVyLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uKCkge1xuICBkZWxldGUgdGhpcy5fY29uZmlnO1xuICBkZWxldGUgdGhpcy5fc2VydmljZTtcbn07XG5cbnZhciBnZXRTaW5nbGVNZXNzYWdlRGV0YWlscyA9IGZ1bmN0aW9uKG1lc3NhZ2VJZCwgdXNlckVtYWlsLCB0b2tlbiwgYXBpVmVyc2lvbiwgYWRkaXRpb25hbEZpZWxkcywgcmVzdWx0KSB7XG4gIHZhciBhZGRpdGlvbmFsRmllbGRzVG9RdWVyeSA9IGFkZGl0aW9uYWxGaWVsZHMucmVwbGFjZSgnQm9keVByZXZpZXcnLCAnc25pcHBldCcpO1xuICBhZGRpdGlvbmFsRmllbGRzVG9RdWVyeSA9IGFkZGl0aW9uYWxGaWVsZHNUb1F1ZXJ5LnJlcGxhY2UoJ0JvZHknLCAncGF5bG9hZChwYXJ0cyknKTtcbiAgYWRkaXRpb25hbEZpZWxkc1RvUXVlcnkgPSBhZGRpdGlvbmFsRmllbGRzVG9RdWVyeS5yZXBsYWNlKCdTdWJqZWN0JywgJ3BheWxvYWQocGFydHMpJyk7XG5cbiAgaWYgKGFkZGl0aW9uYWxGaWVsZHNUb1F1ZXJ5ICE9PSAnJykge1xuICAgIGFkZGl0aW9uYWxGaWVsZHNUb1F1ZXJ5ID0gJywnICsgYWRkaXRpb25hbEZpZWxkc1RvUXVlcnk7XG4gIH1cblxuICB2YXIgbWVzc2FnZVJlcXVlc3RPcHRpb25zID0ge1xuICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgdXJpOiAnaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vZ21haWwvdicgKyBhcGlWZXJzaW9uICsgJy91c2Vycy8nICsgdXNlckVtYWlsICsgJy9tZXNzYWdlcy8nICsgbWVzc2FnZUlkICsgJz9maWVsZHM9aWQsdGhyZWFkSWQsbGFiZWxJZHMscGF5bG9hZChoZWFkZXJzKScgKyBhZGRpdGlvbmFsRmllbGRzVG9RdWVyeSxcbiAgICBoZWFkZXJzIDoge1xuICAgICAgQXV0aG9yaXphdGlvbjogJ0JlYXJlciAnICsgdG9rZW4sXG4gICAgICBBY2NlcHQ6ICdhcHBsaWNhdGlvbi9qc29uO29kYXRhLm1ldGFkYXRhPW5vbmUnXG4gICAgfVxuICB9O1xuICByZXR1cm4gcnAobWVzc2FnZVJlcXVlc3RPcHRpb25zKVxuICAudGhlbihmdW5jdGlvbihtZXNzYWdlRGV0YWlscykge1xuICAgIHJlc3VsdC5tZXNzYWdlRGF0YSA9IEpTT04ucGFyc2UobWVzc2FnZURldGFpbHMpO1xuICAgIGlmIChhZGRpdGlvbmFsRmllbGRzLmluZGV4T2YoJ1N1YmplY3QnKSA9PT0gLTEpIHtcbiAgICAgIC8vcmVtb3ZlIHN1YmplY3QgaGVhZGVyXG4gICAgICBpZiAocmVzdWx0Lm1lc3NhZ2VEYXRhLnBheWxvYWQgJiYgcmVzdWx0Lm1lc3NhZ2VEYXRhLnBheWxvYWQuaGVhZGVycyAmJiByZXN1bHQubWVzc2FnZURhdGEucGF5bG9hZC5oZWFkZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZm9yICh2YXIgaGVhZGVySXRlciA9IDA7IGhlYWRlckl0ZXIgPCByZXN1bHQubWVzc2FnZURhdGEucGF5bG9hZC5oZWFkZXJzLmxlbmd0aDsgaGVhZGVySXRlcisrKSB7XG4gICAgICAgICAgaWYgKHJlc3VsdC5tZXNzYWdlRGF0YS5wYXlsb2FkLmhlYWRlcnNbaGVhZGVySXRlcl0ubmFtZSA9PT0gJ1N1YmplY3QnKSB7XG4gICAgICAgICAgICByZXN1bHQubWVzc2FnZURhdGEucGF5bG9hZC5oZWFkZXJzW2hlYWRlckl0ZXJdLnZhbHVlID0gJyc7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH0pO1xufTtcblxudmFyIGdldEFjY2Vzc1Rva2VuID0gZnVuY3Rpb24oY2xpZW50SWQsIGFkbWluRW1haWwsIHVzZXJFbWFpbCwgcHJpdmF0ZUtleSkge1xuICB2YXIgdG9rZW5SZXF1ZXN0VXJsID0gJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92My90b2tlbic7XG4gIHZhciB1bml4RXBvY2hUaW1lID0gTWF0aC5mbG9vcigobmV3IERhdGUoKSkuZ2V0VGltZSgpIC8gMTAwMCk7XG5cbiAgdmFyIGp3dEhlYWRlciA9IHtcbiAgICBhbGc6ICdSUzI1NicsXG4gICAgdHlwOiAnSldUJ1xuICB9O1xuXG4gIHZhciBqd3RQYXlsb2FkID0ge1xuICAgICdpc3MnOiBhZG1pbkVtYWlsLFxuICAgICdzY29wZSc6ICdodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9hdXRoL2dtYWlsLnJlYWRvbmx5JyxcbiAgICAnYXVkJzogdG9rZW5SZXF1ZXN0VXJsLFxuICAgICdleHAnOiB1bml4RXBvY2hUaW1lICsgMzYwMCxcbiAgICAnaWF0JzogdW5peEVwb2NoVGltZSxcbiAgICAnc3ViJzogdXNlckVtYWlsXG4gIH07XG5cbiAgdmFyIGVuY29kZWRKd3RIZWFkZXIgPSBuZXcgQnVmZmVyKEpTT04uc3RyaW5naWZ5KGp3dEhlYWRlcikpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgdmFyIGVuY29kZWRKd3RQYXlsb2FkID0gbmV3IEJ1ZmZlcihKU09OLnN0cmluZ2lmeShqd3RQYXlsb2FkKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xuICB2YXIgc3RyaW5nVG9TaWduID0gZW5jb2RlZEp3dEhlYWRlciArICcuJyArIGVuY29kZWRKd3RQYXlsb2FkO1xuXG4gIC8vc2lnbiBpdCFcbiAgdmFyIHNpZ25lciA9IGNyeXB0by5jcmVhdGVTaWduKCdSU0EtU0hBMjU2Jyk7XG4gIHNpZ25lci51cGRhdGUoc3RyaW5nVG9TaWduKTtcblxuICB2YXIgZW5jb2RlZFNpZ25lZEp3dEluZm8gPSBzaWduZXIuc2lnbihwcml2YXRlS2V5LCAnYmFzZTY0Jyk7XG5cbiAgLy9kZWZpbmUgYXNzZXJ0aW9uXG4gIHZhciBjbGllbnRBc3NlcnRpb24gPSBlbmNvZGVkSnd0SGVhZGVyICsgJy4nICsgZW5jb2RlZEp3dFBheWxvYWQgKyAnLicgKyBlbmNvZGVkU2lnbmVkSnd0SW5mbztcblxuICB2YXIgdG9rZW5SZXF1ZXN0Rm9ybURhdGEgPSB7XG4gICAgZ3JhbnRfdHlwZTogJ3VybjppZXRmOnBhcmFtczpvYXV0aDpncmFudC10eXBlOmp3dC1iZWFyZXInLFxuICAgIGFzc2VydGlvbjogY2xpZW50QXNzZXJ0aW9uXG4gIH07XG5cbiAgdmFyIHJlcXVlc3REYXRhID0gcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHRva2VuUmVxdWVzdEZvcm1EYXRhKTtcbiAgdmFyIHJlcXVlc3REYXRhTGVuZ3RoID0gcmVxdWVzdERhdGEubGVuZ3RoO1xuXG4gIHZhciB0b2tlblJlcXVlc3RPcHRpb25zID0ge1xuICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgIHBvcnQ6IDQ0MyxcbiAgICB1cmk6IHRva2VuUmVxdWVzdFVybCxcbiAgICBib2R5OiByZXF1ZXN0RGF0YSxcbiAgICBtdWx0aXBhcnQ6IGZhbHNlLFxuICAgIGhlYWRlcnM6IHtcbiAgICAgICdDb250ZW50LUxlbmd0aCc6IHJlcXVlc3REYXRhTGVuZ3RoLFxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnXG4gICAgfVxuICB9O1xuXG4gIHJldHVybiBycCh0b2tlblJlcXVlc3RPcHRpb25zKVxuICAudGhlbihmdW5jdGlvbihib2R5KSB7XG4gICAgdmFyIHRva2VuRGF0YSA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgaWYgKHRva2VuRGF0YSAmJiB0b2tlbkRhdGEuYWNjZXNzX3Rva2VuKSB7XG4gICAgICByZXR1cm4gdG9rZW5EYXRhLmFjY2Vzc190b2tlbjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KCdDb3VsZCBub3QgZ2V0IGFjY2VzcyB0b2tlbi4nKTtcbiAgICB9XG4gIH0pXG4gIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICB2YXIgdG9rZW5EYXRhID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShlcnIpKTtcbiAgICBpZiAodG9rZW5EYXRhLm5hbWUgPT09ICdTdGF0dXNDb2RlRXJyb3InKSB7XG4gICAgICB2YXIgZW50aXJlTWVzc2FnZSA9IHRva2VuRGF0YS5tZXNzYWdlO1xuICAgICAgdmFyIG1lc3NhZ2VKc29uID0gZW50aXJlTWVzc2FnZS5yZXBsYWNlKHRva2VuRGF0YS5zdGF0dXNDb2RlICsgJyAtICcsICcnKTtcbiAgICAgIHZhciBtZXNzYWdlRGF0YSA9IEpTT04ucGFyc2UobWVzc2FnZUpzb24ucmVwbGFjZShuZXcgUmVnRXhwKCdcXFxcXCInLCAnZycpLCdcIicpKTtcbiAgICAgIC8vY29uc29sZS5sb2coJy0tLS0tJyk7XG4gICAgICAvL2NvbnNvbGUubG9nKG1lc3NhZ2VEYXRhKTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChtZXNzYWdlRGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChlcnIpO1xuICAgIH1cbiAgfSk7XG59O1xuXG52YXIgZ2V0VXNlckVtYWlscyA9IGZ1bmN0aW9uKGNsaWVudElkLCBzZXJ2aWNlRW1haWwsIHVzZXJFbWFpbCwgcHJpdmF0ZUtleSwgYXBpVmVyc2lvbiwgZmlsdGVyU3RhcnREYXRlLCBmaWx0ZXJFbmREYXRlLCBhZGRpdGlvbmFsRmllbGRzLCByZXN1bHQpIHtcbiAgdmFyIHRva2VuID0gJyc7XG4gIHJldHVybiBnZXRBY2Nlc3NUb2tlbihjbGllbnRJZCwgc2VydmljZUVtYWlsLCB1c2VyRW1haWwsIHByaXZhdGVLZXkpXG4gIC50aGVuKGZ1bmN0aW9uKHRva2VuUmVzcG9uc2UpIHtcbiAgICB0b2tlbiA9IHRva2VuUmVzcG9uc2U7XG4gICAgdmFyIGVtYWlsUmVxdWVzdE9wdGlvbnMgPSB7XG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgdXJpOiAnaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vZ21haWwvdicgKyBhcGlWZXJzaW9uICsgJy91c2Vycy8nICsgdXNlckVtYWlsICsgJy9tZXNzYWdlcz9xPWFmdGVyOicgKyBmaWx0ZXJTdGFydERhdGUudG9JU09TdHJpbmcoKS5zdWJzdHJpbmcoMCwgMTApICsgJyBBTkQgYmVmb3JlOiAnICsgZmlsdGVyRW5kRGF0ZS50b0lTT1N0cmluZygpLnN1YnN0cmluZygwLCAxMCksXG4gICAgICBoZWFkZXJzIDoge1xuICAgICAgICBBdXRob3JpemF0aW9uOiAnQmVhcmVyICcgKyB0b2tlbixcbiAgICAgICAgQWNjZXB0OiAnYXBwbGljYXRpb24vanNvbjtvZGF0YS5tZXRhZGF0YT1ub25lJ1xuICAgICAgfVxuICAgIH07XG4gICAgcmV0dXJuIHJwKGVtYWlsUmVxdWVzdE9wdGlvbnMpO1xuICB9KVxuICAudGhlbihmdW5jdGlvbihib2R5KSB7XG4gICAgdmFyIG1lc3NhZ2VEZXRhaWxQcm9taXNlcyA9IFtdO1xuICAgIHJlc3VsdC5zdWNjZXNzID0gdHJ1ZTtcbiAgICByZXN1bHQuZGF0YSA9IHt9O1xuICAgIHJlc3VsdC5kYXRhLm1lc3NhZ2VMaXN0ID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICByZXN1bHQuZGF0YS5tZXNzYWdlcyA9IFtdO1xuXG4gICAgaWYgKHJlc3VsdC5kYXRhLm1lc3NhZ2VMaXN0Lm1lc3NhZ2VzKSB7XG4gICAgICBmb3IgKHZhciBtZXNzYWdlSXRlciA9IDA7IG1lc3NhZ2VJdGVyIDwgcmVzdWx0LmRhdGEubWVzc2FnZUxpc3QubWVzc2FnZXMubGVuZ3RoOyBtZXNzYWdlSXRlcisrKSB7XG4gICAgICAgIHZhciBtZXNzYWdlSWQgPSByZXN1bHQuZGF0YS5tZXNzYWdlTGlzdC5tZXNzYWdlc1ttZXNzYWdlSXRlcl0uaWQ7XG4gICAgICAgIHJlc3VsdC5kYXRhLm1lc3NhZ2VzLnB1c2goe21lc3NhZ2VJZDogbWVzc2FnZUlkfSk7XG4gICAgICAgIG1lc3NhZ2VEZXRhaWxQcm9taXNlcy5wdXNoKGdldFNpbmdsZU1lc3NhZ2VEZXRhaWxzKG1lc3NhZ2VJZCwgdXNlckVtYWlsLCB0b2tlbiwgYXBpVmVyc2lvbiwgYWRkaXRpb25hbEZpZWxkcywgcmVzdWx0LmRhdGEubWVzc2FnZXNbbWVzc2FnZUl0ZXJdKSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKG1lc3NhZ2VEZXRhaWxQcm9taXNlcyk7XG4gIH0pXG4gIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICByZXN1bHQuc3VjY2VzcyA9IGZhbHNlO1xuICAgIGlmIChlcnIubmFtZSA9PT0gJ1N0YXR1c0NvZGVFcnJvcicpIHtcbiAgICAgIHZhciBlbnRpcmVNZXNzYWdlID0gZXJyLm1lc3NhZ2U7XG4gICAgICB2YXIgbWVzc2FnZUpzb24gPSBlbnRpcmVNZXNzYWdlLnJlcGxhY2UoZXJyLnN0YXR1c0NvZGUgKyAnIC0gJywgJycpO1xuICAgICAgdmFyIG1lc3NhZ2VEYXRhID0gSlNPTi5wYXJzZShtZXNzYWdlSnNvbi5yZXBsYWNlKG5ldyBSZWdFeHAoJ1xcXFxcIicsICdnJyksJ1wiJykpO1xuICAgICAgcmVzdWx0LmVycm9yTWVzc2FnZSA9IG1lc3NhZ2VEYXRhLmVycm9yLm1lc3NhZ2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdC5lcnJvck1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeShlcnIpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSk7XG59O1xuXG52YXIgZ2V0SGVhZGVyVmFsdWUgPSBmdW5jdGlvbihtZXNzYWdlLCBoZWFkZXJOYW1lKSB7XG4gIHZhciBoZWFkZXJWYWx1ZXMgPSBfKG1lc3NhZ2UucGF5bG9hZC5oZWFkZXJzKVxuICAgICAgICAgIC5maWx0ZXIoZnVuY3Rpb24oaGVhZGVyKSB7IHJldHVybiBoZWFkZXIubmFtZSA9PT0gaGVhZGVyTmFtZTsgfSlcbiAgICAgICAgICAucGx1Y2soJ3ZhbHVlJylcbiAgICAgICAgICAudmFsdWUoKTtcbiAgaWYgKGhlYWRlclZhbHVlcy5sZW5ndGggPiAwKSB7XG4gICAgcmV0dXJuIGhlYWRlclZhbHVlc1swXTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufTtcblxudmFyIGdldEVtYWlsQWRkcmVzc09iamVjdEZyb21TdHJpbmcgPSBmdW5jdGlvbih2YWx1ZSkge1xuICB2YXIgcmV0dXJuT2JqZWN0ID0ge1xuICAgIG5hbWU6IHZhbHVlLFxuICAgIGFkZHJlc3M6IHZhbHVlXG4gIH07XG5cbiAgaWYgKHZhbHVlICYmIHZhbHVlLmluZGV4T2YoJz4nKSA+IDApIHtcbiAgICB2YXIgdmFsdWVBcnJheSA9IHZhbHVlLnNwbGl0KCcgJyk7XG4gICAgcmV0dXJuT2JqZWN0LmFkZHJlc3MgPSB2YWx1ZUFycmF5W3ZhbHVlQXJyYXkubGVuZ3RoIC0gMV0ucmVwbGFjZSgnPCcsICcnKS5yZXBsYWNlKCc+JywgJycpO1xuICAgIHJldHVybk9iamVjdC5uYW1lID0gdmFsdWUucmVwbGFjZSgnICcgKyB2YWx1ZUFycmF5W3ZhbHVlQXJyYXkubGVuZ3RoIC0gMV0sICcnKTtcbiAgfVxuXG4gIHJldHVybiByZXR1cm5PYmplY3Q7XG59O1xuXG52YXIgY29udmVydEVtYWlsTGlzdFRvQXJyYXlPZkVtYWlsQWRkcmVzc09iamVjdHMgPSBmdW5jdGlvbihlbWFpbExpc3QpIHtcbiAgdmFyIGVtYWlsQWRkcmVzc09iamVjdEFycmF5ID0gW107XG4gIGlmIChlbWFpbExpc3QpIHtcbiAgICB2YXIgZW1haWxBcnJheSA9IGVtYWlsTGlzdC5zcGxpdCgnLCcpO1xuICAgIGZvciAodmFyIGVtYWlsSXRlciA9IDA7IGVtYWlsSXRlciA8IGVtYWlsQXJyYXkubGVuZ3RoOyBlbWFpbEl0ZXIrKykge1xuICAgICAgZW1haWxBZGRyZXNzT2JqZWN0QXJyYXkucHVzaChnZXRFbWFpbEFkZHJlc3NPYmplY3RGcm9tU3RyaW5nKGVtYWlsQXJyYXlbZW1haWxJdGVyXSkpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBlbWFpbEFkZHJlc3NPYmplY3RBcnJheTtcbn07XG5cbnZhciBoYXNMYWJlbCA9IGZ1bmN0aW9uKG1lc3NhZ2UsIGxhYmVsVmFsdWUpIHtcbiAgcmV0dXJuIG1lc3NhZ2UubGFiZWxJZHMuaW5kZXhPZihsYWJlbFZhbHVlKSA+PSAwO1xufTtcblxudmFyIG1hcEVtYWlsRGF0YSA9IGZ1bmN0aW9uKGVtYWlsRGF0YSkge1xuICB2YXIgbWFwcGVkRGF0YSA9IFtdO1xuXG4gIGZvciAodmFyIHVzZXJJdGVyID0gMDsgdXNlckl0ZXIgPCBlbWFpbERhdGEubGVuZ3RoOyB1c2VySXRlcisrKSB7XG4gICAgdmFyIG1hcHBlZFVzZXIgPSB7XG4gICAgICBlbWFpbDogZW1haWxEYXRhW3VzZXJJdGVyXS5lbWFpbCxcbiAgICAgIGZpbHRlclN0YXJ0RGF0ZTogZW1haWxEYXRhW3VzZXJJdGVyXS5maWx0ZXJTdGFydERhdGUsXG4gICAgICBmaWx0ZXJFbmREYXRlOiBlbWFpbERhdGFbdXNlckl0ZXJdLmZpbHRlckVuZERhdGUsXG4gICAgICBkYXRhOiBbXSxcbiAgICAgIHN1Y2Nlc3M6IGVtYWlsRGF0YVt1c2VySXRlcl0uc3VjY2VzcyxcbiAgICAgIGVycm9yTWVzc2FnZTogZW1haWxEYXRhW3VzZXJJdGVyXS5lcnJvck1lc3NhZ2VcbiAgICB9O1xuXG4gICAgaWYgKGVtYWlsRGF0YVt1c2VySXRlcl0uc3VjY2Vzcykge1xuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbWFpbERhdGFbdXNlckl0ZXJdLmRhdGFbJ21lc3NhZ2VzJ10ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdmFyIG9yaWdpbmFsRW1haWxNZXNzYWdlID0gZW1haWxEYXRhW3VzZXJJdGVyXS5kYXRhWydtZXNzYWdlcyddW2ldO1xuICAgICAgICB2YXIgbWFwcGVkRW1haWxNZXNzYWdlID0ge307XG5cbiAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlID0gb3JpZ2luYWxFbWFpbE1lc3NhZ2U7XG4gICAgICAgIHZhciBtZXNzYWdlRGF0YSA9IG9yaWdpbmFsRW1haWxNZXNzYWdlLm1lc3NhZ2VEYXRhO1xuXG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5tZXNzYWdlSWQgPSBvcmlnaW5hbEVtYWlsTWVzc2FnZS5tZXNzYWdlSWQ7XG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5jb252ZXJzYXRpb25JZCA9IG1lc3NhZ2VEYXRhLnRocmVhZElkO1xuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuZGF0ZVRpbWVTZW50ID0gbW9tZW50KG5ldyBEYXRlKGdldEhlYWRlclZhbHVlKG1lc3NhZ2VEYXRhLCAnRGF0ZScpKSkudXRjKCkudG9EYXRlKCk7XG5cbiAgICAgICAgdmFyIGRhdGVSZWNlaXZlZCA9IGdldEhlYWRlclZhbHVlKG1lc3NhZ2VEYXRhLCAnUmVjZWl2ZWQnKTtcbiAgICAgICAgaWYgKGRhdGVSZWNlaXZlZCkge1xuICAgICAgICAgIHZhciBkYXRlUGFydE9mVmFsdWUgPSBkYXRlUmVjZWl2ZWQuc3BsaXQoJzsnKVsxXTtcbiAgICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuZGF0ZVRpbWVSZWNlaXZlZCA9IG1vbWVudChuZXcgRGF0ZShkYXRlUGFydE9mVmFsdWUpKS51dGMoKS50b0RhdGUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5pbXBvcnRhbmNlID0gJ05vcm1hbCc7XG4gICAgICAgIGlmIChoYXNMYWJlbChtZXNzYWdlRGF0YSwgJ0lNUE9SVEFOVCcpKSB7XG4gICAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLmltcG9ydGFuY2UgPSAnSW1wb3J0YW50JztcbiAgICAgICAgfVxuXG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5jYXRlZ29yaWVzID0gbWVzc2FnZURhdGEubGFiZWxJZHM7XG5cbiAgICAgICAgaWYgKGhhc0xhYmVsKG1lc3NhZ2VEYXRhLCAnU0VOVCcpKSB7XG4gICAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLmZvbGRlcklkID0gJ1NlbnQgSXRlbXMnO1xuICAgICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5mb2xkZXJOYW1lID0gJ1NlbnQgSXRlbXMnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5mb2xkZXJJZCA9ICdJbmJveCc7XG4gICAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLmZvbGRlck5hbWUgPSAnSW5ib3gnO1xuICAgICAgICB9XG5cbiAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLnN1YmplY3QgPSBnZXRIZWFkZXJWYWx1ZShtZXNzYWdlRGF0YSwgJ1N1YmplY3QnKTtcbiAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLmJvZHlQcmV2aWV3ID0gbWVzc2FnZURhdGEuc25pcHBldDtcblxuICAgICAgICBpZiAobWVzc2FnZURhdGEucGF5bG9hZC5wYXJ0cyAmJiBtZXNzYWdlRGF0YS5wYXlsb2FkLnBhcnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuY29udGVudFR5cGUgPSBtZXNzYWdlRGF0YS5wYXlsb2FkLnBhcnRzWzBdLm1pbWVUeXBlO1xuICAgICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5ib2R5ID0gbmV3IEJ1ZmZlcihtZXNzYWdlRGF0YS5wYXlsb2FkLnBhcnRzWzBdLmJvZHkuZGF0YSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCk7XG4gICAgICAgIH1cblxuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuaXNEZWxpdmVyeVJlY2VpcHRSZXF1ZXN0ZWQgPSBudWxsO1xuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuaXNSZWFkUmVjZWlwdFJlcXVlc3RlZCA9IG51bGw7XG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5oYXNBdHRhY2htZW50cyA9IG51bGw7XG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5pc0RyYWZ0ID0gbnVsbDtcbiAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLmlzUmVhZCA9IGhhc0xhYmVsKG1lc3NhZ2VEYXRhLCAnUkVBRCcpO1xuXG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5mcm9tQWRkcmVzcyA9IGdldEVtYWlsQWRkcmVzc09iamVjdEZyb21TdHJpbmcoZ2V0SGVhZGVyVmFsdWUobWVzc2FnZURhdGEsICdGcm9tJykpLmFkZHJlc3M7XG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5mcm9tTmFtZSA9IGdldEVtYWlsQWRkcmVzc09iamVjdEZyb21TdHJpbmcoZ2V0SGVhZGVyVmFsdWUobWVzc2FnZURhdGEsICdGcm9tJykpLm5hbWU7XG5cbiAgICAgICAgbWFwcGVkRW1haWxNZXNzYWdlLnRvUmVjaXBpZW50cyA9IGNvbnZlcnRFbWFpbExpc3RUb0FycmF5T2ZFbWFpbEFkZHJlc3NPYmplY3RzKGdldEhlYWRlclZhbHVlKG1lc3NhZ2VEYXRhLCAnVG8nKSk7XG4gICAgICAgIG1hcHBlZEVtYWlsTWVzc2FnZS5jY1JlY2lwaWVudHMgPSBjb252ZXJ0RW1haWxMaXN0VG9BcnJheU9mRW1haWxBZGRyZXNzT2JqZWN0cyhnZXRIZWFkZXJWYWx1ZShtZXNzYWdlRGF0YSwgJ0NjJykpO1xuICAgICAgICBtYXBwZWRFbWFpbE1lc3NhZ2UuYmNjUmVjaXBpZW50cyA9IGNvbnZlcnRFbWFpbExpc3RUb0FycmF5T2ZFbWFpbEFkZHJlc3NPYmplY3RzKGdldEhlYWRlclZhbHVlKG1lc3NhZ2VEYXRhLCAnQmNjJykpO1xuXG4gICAgICAgIG1hcHBlZFVzZXIuZGF0YS5wdXNoKG1hcHBlZEVtYWlsTWVzc2FnZSk7XG4gICAgICB9XG4gICAgfVxuICAgIG1hcHBlZERhdGEucHVzaChtYXBwZWRVc2VyKTtcbiAgfVxuXG4gIHJldHVybiBtYXBwZWREYXRhO1xufTtcblxudmFyIGdldEVtYWlsRGF0YSA9IGZ1bmN0aW9uKGVtYWlscywgZmlsdGVyU3RhcnREYXRlLCBmaWx0ZXJFbmREYXRlLCBhZGRpdGlvbmFsRmllbGRzLCBjbGllbnRJZCwgc2VydmljZUVtYWlsLCBwcml2YXRlS2V5LCBhcGlWZXJzaW9uKSB7XG4gIHZhciBlbWFpbFJlc3VsdHMgPSBbXTtcbiAgdmFyIGVtYWlsUmVzdWx0UHJvbWlzZXMgPSBbXTtcbiAgdmFyIGVtYWlsSXRlciA9IDA7XG4gIGZvciAoZW1haWxJdGVyID0gMDsgZW1haWxJdGVyIDwgZW1haWxzLmxlbmd0aDsgZW1haWxJdGVyKyspIHtcbiAgICBlbWFpbFJlc3VsdHNbZW1haWxJdGVyXSA9IHtlbWFpbDogZW1haWxzW2VtYWlsSXRlcl0sIGZpbHRlclN0YXJ0RGF0ZTogZmlsdGVyU3RhcnREYXRlLCBmaWx0ZXJFbmREYXRlOiBmaWx0ZXJFbmREYXRlfTtcbiAgICBlbWFpbFJlc3VsdFByb21pc2VzLnB1c2goZ2V0VXNlckVtYWlscyhjbGllbnRJZCwgc2VydmljZUVtYWlsLCBlbWFpbHNbZW1haWxJdGVyXSwgcHJpdmF0ZUtleSwgYXBpVmVyc2lvbiwgZmlsdGVyU3RhcnREYXRlLCBmaWx0ZXJFbmREYXRlLCBhZGRpdGlvbmFsRmllbGRzLCBlbWFpbFJlc3VsdHNbZW1haWxJdGVyXSkpO1xuICB9XG5cbiAgcmV0dXJuIFByb21pc2UuYWxsKGVtYWlsUmVzdWx0UHJvbWlzZXMpXG4gIC50aGVuKGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBlbWFpbFJlc3VsdHM7XG4gIH0pO1xufTtcblxuR29vZ2xlQWRhcHRlci5wcm90b3R5cGUuZ2V0QmF0Y2hEYXRhID0gZnVuY3Rpb24oZW1haWxzLCBmaWx0ZXJTdGFydERhdGUsIGZpbHRlckVuZERhdGUsIGFkZGl0aW9uYWxGaWVsZHMpIHtcbiAgdmFyIGNsaWVudElkID0gdGhpcy5fY29uZmlnLmNyZWRlbnRpYWxzLmNsaWVudElkO1xuICB2YXIgY2xpZW50RW1haWwgPSB0aGlzLl9jb25maWcuY3JlZGVudGlhbHMuZW1haWw7XG4gIHZhciBzZXJ2aWNlRW1haWwgPSB0aGlzLl9jb25maWcuY3JlZGVudGlhbHMuc2VydmljZUVtYWlsO1xuICB2YXIgcHJpdmF0ZUtleSA9IHRoaXMuX2NvbmZpZy5jcmVkZW50aWFscy5jZXJ0aWZpY2F0ZTtcbiAgdmFyIGFwaVZlcnNpb24gPSB0aGlzLl9jb25maWcub3B0aW9ucy5hcGlWZXJzaW9uO1xuXG4gIHZhciBkYXRhQWRhcHRlclJ1blN0YXRzID0ge1xuICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgcnVuRGF0ZTogbW9tZW50KCkudXRjKCkudG9EYXRlKCksXG4gICAgZmlsdGVyU3RhcnREYXRlOiBmaWx0ZXJTdGFydERhdGUsXG4gICAgZmlsdGVyRW5kRGF0ZTogZmlsdGVyRW5kRGF0ZSxcbiAgICBlbWFpbHM6IGVtYWlsc1xuICB9O1xuXG4gIC8vZmlyc3QgdHJ5IHRvIGdldCB0b2tlbiBmb3IgdGhlIGFkbWluIC0gaWYgdGhhdCBmYWlscywgdGhlbiBhbGwgd2lsbCBmYWlsXG4gIHJldHVybiBnZXRBY2Nlc3NUb2tlbihjbGllbnRJZCwgc2VydmljZUVtYWlsLCBjbGllbnRFbWFpbCwgcHJpdmF0ZUtleSlcbiAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuIGdldEVtYWlsRGF0YShlbWFpbHMsIGZpbHRlclN0YXJ0RGF0ZSwgZmlsdGVyRW5kRGF0ZSwgYWRkaXRpb25hbEZpZWxkcywgY2xpZW50SWQsIHNlcnZpY2VFbWFpbCwgcHJpdmF0ZUtleSwgYXBpVmVyc2lvbik7XG4gIH0pXG4gIC50aGVuKGZ1bmN0aW9uKGVtYWlsRGF0YSkge1xuICAgIHJldHVybiBtYXBFbWFpbERhdGEoZW1haWxEYXRhKTtcbiAgfSlcbiAgLnRoZW4oZnVuY3Rpb24obWFwcGVkRW1haWxEYXRhKSB7XG4gICAgZGF0YUFkYXB0ZXJSdW5TdGF0cy5yZXN1bHRzID0gbWFwcGVkRW1haWxEYXRhO1xuICAgIHJldHVybiBkYXRhQWRhcHRlclJ1blN0YXRzO1xuICB9KVxuICAuY2F0Y2goZnVuY3Rpb24oZXJyKSB7XG4gICAgZGF0YUFkYXB0ZXJSdW5TdGF0cy5zdWNjZXNzID0gZmFsc2U7XG4gICAgZGF0YUFkYXB0ZXJSdW5TdGF0cy5lcnJvck1lc3NhZ2UgPSBlcnI7XG4gICAgY29uc29sZS5sb2coJ0dvb2dsZU1haWwgR2V0QmF0Y2hEYXRhIEVycm9yOiAnICsgSlNPTi5zdHJpbmdpZnkoZXJyKSk7XG4gICAgcmV0dXJuIGRhdGFBZGFwdGVyUnVuU3RhdHM7XG4gIH0pO1xufTtcblxuR29vZ2xlQWRhcHRlci5wcm90b3R5cGUucnVuQ29ubmVjdGlvblRlc3QgPSBmdW5jdGlvbihjb25uZWN0aW9uRGF0YSkge1xuICB2YXIgX3RoaXMgPSB0aGlzO1xuICBfdGhpcy5fY29uZmlnID0gbmV3IEdvb2dsZU1haWwuQ29uZmlndXJhdGlvbihjb25uZWN0aW9uRGF0YS5jcmVkZW50aWFscyk7XG4gIHZhciBmaWx0ZXJTdGFydERhdGUgPSBtb21lbnQoKS51dGMoKS5zdGFydE9mKCdkYXknKS5hZGQoLTEsICdkYXlzJykudG9EYXRlKCk7XG4gIHZhciBmaWx0ZXJFbmREYXRlID0gbW9tZW50KCkudXRjKCkuc3RhcnRPZignZGF5JykudG9EYXRlKCk7XG4gIHJldHVybiBfdGhpcy5nZXRCYXRjaERhdGEoW190aGlzLl9jb25maWcuY3JlZGVudGlhbHMuZW1haWxdLCBmaWx0ZXJTdGFydERhdGUsIGZpbHRlckVuZERhdGUsICcnKVxuICAudGhlbihmdW5jdGlvbihkYXRhKSB7XG4gICAgaWYgKGRhdGEuc3VjY2VzcyAmJiBkYXRhLnJlc3VsdHNbMF0pIHtcbiAgICAgIC8vdG8gc2VlIGlmIGl0IHJlYWxseSB3b3JrZWQsIHdlIG5lZWQgdG8gcGFzcyBpbiB0aGUgZmlyc3QgcmVzdWx0XG4gICAgICByZXR1cm4gZGF0YS5yZXN1bHRzWzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZGF0YTtcbiAgICB9XG4gIH0pO1xufTtcblxuR29vZ2xlQWRhcHRlci5wcm90b3R5cGUucnVuTWVzc2FnZVRlc3QgPSBmdW5jdGlvbihjb25uZWN0aW9uRGF0YSkge1xuICB2YXIgX3RoaXMgPSB0aGlzO1xuICBfdGhpcy5fY29uZmlnID0gbmV3IEdvb2dsZU1haWwuQ29uZmlndXJhdGlvbihjb25uZWN0aW9uRGF0YS5jcmVkZW50aWFscyk7XG4gIHZhciBmaWx0ZXJTdGFydERhdGUgPSBtb21lbnQoKS51dGMoKS5zdGFydE9mKCdkYXknKS5hZGQoLTEsICdkYXlzJykudG9EYXRlKCk7XG4gIHZhciBmaWx0ZXJFbmREYXRlID0gbW9tZW50KCkudXRjKCkuc3RhcnRPZignZGF5JykuYWRkKDEsICdkYXlzJykudG9EYXRlKCk7XG4gIHJldHVybiBfdGhpcy5nZXRCYXRjaERhdGEoW190aGlzLl9jb25maWcuY3JlZGVudGlhbHMuZW1haWxdLCBmaWx0ZXJTdGFydERhdGUsIGZpbHRlckVuZERhdGUsICdTdWJqZWN0LEJvZHlQcmV2aWV3LEJvZHknKVxuICAudGhlbihmdW5jdGlvbihkYXRhKSB7XG4gICAgY29uc29sZS5sb2coJ3J1bk1lc3NhZ2VUZXN0IHdvcmtlZCcpO1xuICAgIGNvbnNvbGUubG9nKGRhdGEucmVzdWx0c1swXSk7XG4gIH0pXG4gIC5jYXRjaChmdW5jdGlvbihlcnIpIHtcbiAgICBjb25zb2xlLmxvZygncnVuTWVzc2FnZVRlc3QgRXJyb3I6ICcgKyBKU09OLnN0cmluZ2lmeShlcnIpKTtcbiAgfSk7XG59O1xuIl19
//# sourceMappingURL=index.js.map
