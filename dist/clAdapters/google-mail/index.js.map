{"version":3,"sources":["clAdapters/google-mail/index.js"],"names":[],"mappings":"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","file":"clAdapters/google-mail/index.js","sourcesContent":["'use strict';\r\n\r\nvar crypto = require('crypto');\r\nvar rp = require('request-promise');\r\nvar util = require('util');\r\nvar BaseAdapter = require('../base/Adapter');\r\nvar GoogleMail = require('./google-js.js');\r\nvar moment = require('moment');\r\nvar querystring = require('querystring');\r\nvar _ = require('lodash');\r\n\r\nvar GoogleAdapter = module.exports = function GoogleAdapter() {\r\n  BaseAdapter.call(this);\r\n};\r\n\r\nutil.inherits(GoogleAdapter, BaseAdapter);\r\n\r\nGoogleAdapter.prototype.init = function() {\r\n  var _this = this;\r\n  this._config = new GoogleMail.Configuration(this.credentials);\r\n  this._service = new GoogleMail.Service(this._config);\r\n  return this._service\r\n    .init()\r\n    .then(function( /*client*/ ) {\r\n      var msg = 'Successfully initialized gmail adapter for email: %s';\r\n      console.log(msg, _this.credentials.email);\r\n      return _this;\r\n    });\r\n};\r\n\r\nGoogleAdapter.prototype.reset = function() {\r\n  delete this._config;\r\n  delete this._service;\r\n};\r\n\r\nvar getSingleMessageDetails = function(messageId, userEmail, token, apiVersion, additionalFields, result) {\r\n  var additionalFieldsToQuery = additionalFields.replace('BodyPreview', 'snippet');\r\n  additionalFieldsToQuery = additionalFieldsToQuery.replace('Body', 'payload(parts)');\r\n  additionalFieldsToQuery = additionalFieldsToQuery.replace('Subject', 'payload(parts)');\r\n\r\n  if (additionalFieldsToQuery !== '') {\r\n    additionalFieldsToQuery = ',' + additionalFieldsToQuery;\r\n  }\r\n\r\n  var messageRequestOptions = {\r\n    method: 'GET',\r\n    uri: 'https://www.googleapis.com/gmail/v' + apiVersion + '/users/' + userEmail + '/messages/' + messageId + '?fields=id,threadId,labelIds,payload(headers)' + additionalFieldsToQuery,\r\n    headers : {\r\n      Authorization: 'Bearer ' + token,\r\n      Accept: 'application/json;odata.metadata=none'\r\n    }\r\n  };\r\n  return rp(messageRequestOptions)\r\n  .then(function(messageDetails) {\r\n    result.messageData = JSON.parse(messageDetails);\r\n    if (additionalFields.indexOf('Subject') === -1) {\r\n      //remove subject header\r\n      if (result.messageData.payload && result.messageData.payload.headers && result.messageData.payload.headers.length > 0) {\r\n        for (var headerIter = 0; headerIter < result.messageData.payload.headers.length; headerIter++) {\r\n          if (result.messageData.payload.headers[headerIter].name === 'Subject') {\r\n            result.messageData.payload.headers[headerIter].value = '';\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return true;\r\n  });\r\n};\r\n\r\nvar getAccessToken = function(clientId, adminEmail, userEmail, privateKey) {\r\n  var tokenRequestUrl = 'https://www.googleapis.com/oauth2/v3/token';\r\n  var unixEpochTime = Math.floor((new Date()).getTime() / 1000);\r\n\r\n  var jwtHeader = {\r\n    alg: 'RS256',\r\n    typ: 'JWT'\r\n  };\r\n\r\n  var jwtPayload = {\r\n    'iss': adminEmail,\r\n    'scope': 'https://www.googleapis.com/auth/gmail.readonly',\r\n    'aud': tokenRequestUrl,\r\n    'exp': unixEpochTime + 3600,\r\n    'iat': unixEpochTime,\r\n    'sub': userEmail\r\n  };\r\n\r\n  var encodedJwtHeader = new Buffer(JSON.stringify(jwtHeader)).toString('base64');\r\n  var encodedJwtPayload = new Buffer(JSON.stringify(jwtPayload)).toString('base64');\r\n  var stringToSign = encodedJwtHeader + '.' + encodedJwtPayload;\r\n\r\n  //sign it!\r\n  var signer = crypto.createSign('RSA-SHA256');\r\n  signer.update(stringToSign);\r\n\r\n  var encodedSignedJwtInfo = signer.sign(privateKey, 'base64');\r\n\r\n  //define assertion\r\n  var clientAssertion = encodedJwtHeader + '.' + encodedJwtPayload + '.' + encodedSignedJwtInfo;\r\n\r\n  var tokenRequestFormData = {\r\n    grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',\r\n    assertion: clientAssertion\r\n  };\r\n\r\n  var requestData = querystring.stringify(tokenRequestFormData);\r\n  var requestDataLength = requestData.length;\r\n\r\n  var tokenRequestOptions = {\r\n    method: 'POST',\r\n    port: 443,\r\n    uri: tokenRequestUrl,\r\n    body: requestData,\r\n    multipart: false,\r\n    headers: {\r\n      'Content-Length': requestDataLength,\r\n      'Content-Type': 'application/x-www-form-urlencoded'\r\n    }\r\n  };\r\n\r\n  return rp(tokenRequestOptions)\r\n  .then(function(body) {\r\n    var tokenData = JSON.parse(body);\r\n    if (tokenData && tokenData.access_token) {\r\n      return tokenData.access_token;\r\n    } else {\r\n      return Promise.reject('Could not get access token.');\r\n    }\r\n  })\r\n  .catch(function(err) {\r\n    var tokenData = JSON.parse(JSON.stringify(err));\r\n    if (tokenData.name === 'StatusCodeError') {\r\n      var entireMessage = tokenData.message;\r\n      var messageJson = entireMessage.replace(tokenData.statusCode + ' - ', '');\r\n      var messageData = JSON.parse(messageJson.replace(new RegExp('\\\\\"', 'g'),'\"'));\r\n      //console.log('-----');\r\n      //console.log(messageData);\r\n      return Promise.reject(messageData);\r\n    } else {\r\n      return Promise.reject(err);\r\n    }\r\n  });\r\n};\r\n\r\nvar getMoreEmails = function(messages, userEmail, token, apiVersion, additionalFields, emailRequestOptions, firstUri, nextPageToken) {\r\n  emailRequestOptions.uri = firstUri + '&pageToken=' + nextPageToken;\r\n  var tempPageToken = '';\r\n  return rp(emailRequestOptions)\r\n  .then(function(body) {\r\n    var messageDetailPromises = [];\r\n    var messageList = JSON.parse(body);\r\n    tempPageToken = messageList.nextPageToken;\r\n\r\n    if (messageList.messages) {\r\n      for (var messageIter = 0; messageIter < messageList.messages.length; messageIter++) {\r\n        var messageId = messageList.messages[messageIter].id;\r\n        var nextMessage = {messageId: messageId};\r\n        messages.push(nextMessage);\r\n        messageDetailPromises.push(getSingleMessageDetails(messageId, userEmail, token, apiVersion, additionalFields, nextMessage));\r\n      }\r\n    }\r\n\r\n    return Promise.all(messageDetailPromises);\r\n  })\r\n  .then(function() {\r\n    if(tempPageToken) {\r\n      return getMoreEmails(messages, userEmail, token, apiVersion, additionalFields, emailRequestOptions, firstUri, tempPageToken);\r\n    } else {\r\n      return true;\r\n    }\r\n  });\r\n};\r\n\r\nvar getUserEmails = function(clientId, serviceEmail, userEmail, privateKey, apiVersion, filterStartDate, filterEndDate, additionalFields, result) {\r\n  var token = '';\r\n  var emailRequestOptions = {};\r\n  var firstUri = '';\r\n  return getAccessToken(clientId, serviceEmail, userEmail, privateKey)\r\n  .then(function(tokenResponse) {\r\n    token = tokenResponse;\r\n    firstUri = 'https://www.googleapis.com/gmail/v' + apiVersion + '/users/' + userEmail + '/messages?maxResults=100&q=\"after:' + filterStartDate.toISOString().substring(0, 10).replace(/-/g, \"/\") + ' before:' + filterEndDate.toISOString().substring(0, 10).replace(/-/g, \"/\") + '\"';\r\n    emailRequestOptions = {\r\n      method: 'GET',\r\n      uri: firstUri,\r\n      headers : {\r\n        Authorization: 'Bearer ' + token,\r\n        Accept: 'application/json;odata.metadata=none'\r\n      }\r\n    };\r\n    return rp(emailRequestOptions);\r\n  })\r\n  .then(function(body) {\r\n    var messageDetailPromises = [];\r\n    result.data = {};\r\n    result.data.messageList = JSON.parse(body);\r\n    result.data.messages = [];\r\n\r\n    if (result.data.messageList.messages) {\r\n      for (var messageIter = 0; messageIter < result.data.messageList.messages.length; messageIter++) {\r\n        var messageId = result.data.messageList.messages[messageIter].id;\r\n        result.data.messages.push({messageId: messageId});\r\n        messageDetailPromises.push(getSingleMessageDetails(messageId, userEmail, token, apiVersion, additionalFields, result.data.messages[messageIter]));\r\n      }\r\n    }\r\n\r\n    return Promise.all(messageDetailPromises);\r\n  })\r\n  .then(function() {\r\n    //console.log(result.data.messageList);\r\n    if(result.data.messageList.nextPageToken) {\r\n      return getMoreEmails(result.data.messages, userEmail, token, apiVersion, additionalFields, emailRequestOptions, firstUri, result.data.messageList.nextPageToken);\r\n    } else {\r\n      return true;\r\n    }\r\n  })\r\n  .then(function() {\r\n    result.success = true;\r\n  })\r\n  .catch(function(err) {\r\n    result.success = false;\r\n    if (err.name === 'StatusCodeError') {\r\n      var entireMessage = err.message;\r\n      var messageJson = entireMessage.replace(err.statusCode + ' - ', '');\r\n      var messageData = JSON.parse(messageJson.replace(new RegExp('\\\\\"', 'g'),'\"'));\r\n      result.errorMessage = messageData.error.message;\r\n    } else {\r\n      result.errorMessage = JSON.stringify(err);\r\n    }\r\n    return true;\r\n  });\r\n};\r\n\r\nvar getHeaderValue = function(message, headerName) {\r\n  var headerValues = _(message.payload.headers)\r\n          .filter(function(header) { return header.name === headerName; })\r\n          .pluck('value')\r\n          .value();\r\n  if (headerValues.length > 0) {\r\n    return headerValues[0];\r\n  } else {\r\n    return null;\r\n  }\r\n};\r\n\r\nvar getEmailAddressObjectFromString = function(value) {\r\n  var returnObject = {\r\n    name: value,\r\n    address: value\r\n  };\r\n\r\n  if (value && value.indexOf('>') > 0) {\r\n    var valueArray = value.split(' ');\r\n    returnObject.address = valueArray[valueArray.length - 1].replace('<', '').replace('>', '');\r\n    returnObject.name = value.replace(' ' + valueArray[valueArray.length - 1], '');\r\n  }\r\n\r\n  return returnObject;\r\n};\r\n\r\nvar convertEmailListToArrayOfEmailAddressObjects = function(emailList) {\r\n  var emailAddressObjectArray = [];\r\n  if (emailList) {\r\n    var emailArray = emailList.split(',');\r\n    for (var emailIter = 0; emailIter < emailArray.length; emailIter++) {\r\n      emailAddressObjectArray.push(getEmailAddressObjectFromString(emailArray[emailIter]));\r\n    }\r\n  }\r\n\r\n  return emailAddressObjectArray;\r\n};\r\n\r\nvar hasLabel = function(message, labelValue) {\r\n  return message.labelIds && message.labelIds.length && (message.labelIds.indexOf(labelValue) >= 0);\r\n};\r\n\r\nvar getFirstScalarPart = function(partToCheck) {\r\n  var returnObject = partToCheck;\r\n  _.forEach(partToCheck.headers, function(header) {\r\n    if(header.name === 'Content-Type' && header.value.indexOf('multipart/') > -1 && partToCheck.parts.length > 0) {\r\n      returnObject = getFirstScalarPart(partToCheck.parts[0]);\r\n    }\r\n  });\r\n  return returnObject;\r\n};\r\n\r\nvar mapEmailData = function(emailData) {\r\n  var mappedData = [];\r\n\r\n  for (var userIter = 0; userIter < emailData.length; userIter++) {\r\n    var mappedUser = _.assign({}, emailData[userIter], {\r\n      data: [],\r\n      success: emailData[userIter].success,\r\n      errorMessage: emailData[userIter].errorMessage\r\n    });\r\n\r\n    if (emailData[userIter].success) {\r\n      for (var i = 0; i < emailData[userIter].data['messages'].length; i++) {\r\n        var originalEmailMessage = emailData[userIter].data['messages'][i];\r\n        var mappedEmailMessage = {};\r\n\r\n        mappedEmailMessage = originalEmailMessage;\r\n        var messageData = originalEmailMessage.messageData;\r\n\r\n        mappedEmailMessage.messageId = originalEmailMessage.messageId;\r\n        mappedEmailMessage.conversationId = messageData.threadId;\r\n        mappedEmailMessage.dateTimeSent = moment(new Date(getHeaderValue(messageData, 'Date'))).utc().toDate();\r\n\r\n        var dateReceived = getHeaderValue(messageData, 'Received');\r\n        if (dateReceived) {\r\n          var datePartOfValue = dateReceived.split(';')[1];\r\n          mappedEmailMessage.dateTimeReceived = moment(new Date(datePartOfValue)).utc().toDate();\r\n        }\r\n\r\n        mappedEmailMessage.importance = 'Normal';\r\n        if (hasLabel(messageData, 'IMPORTANT')) {\r\n          mappedEmailMessage.importance = 'Important';\r\n        }\r\n\r\n        mappedEmailMessage.categories = messageData.labelIds;\r\n\r\n        if (hasLabel(messageData, 'SENT')) {\r\n          mappedEmailMessage.folderId = 'Sent Items';\r\n          mappedEmailMessage.folderName = 'Sent Items';\r\n        } else {\r\n          mappedEmailMessage.folderId = 'Inbox';\r\n          mappedEmailMessage.folderName = 'Inbox';\r\n        }\r\n\r\n        mappedEmailMessage.subject = getHeaderValue(messageData, 'Subject');\r\n        mappedEmailMessage.bodyPreview = messageData.snippet;\r\n\r\n        if (messageData.payload.parts && messageData.payload.parts.length > 0) {\r\n          var partToCheck = getFirstScalarPart(messageData.payload.parts[0]);\r\n          mappedEmailMessage.contentType = partToCheck.mimeType;\r\n          mappedEmailMessage.body = new Buffer(partToCheck.body.data, 'base64').toString();\r\n        }\r\n\r\n        mappedEmailMessage.isDeliveryReceiptRequested = null;\r\n        mappedEmailMessage.isReadReceiptRequested = null;\r\n        mappedEmailMessage.hasAttachments = null;\r\n        mappedEmailMessage.isDraft = null;\r\n        mappedEmailMessage.isRead = hasLabel(messageData, 'READ');\r\n\r\n        mappedEmailMessage.fromAddress = getEmailAddressObjectFromString(getHeaderValue(messageData, 'From')).address;\r\n        mappedEmailMessage.fromName = getEmailAddressObjectFromString(getHeaderValue(messageData, 'From')).name;\r\n\r\n        mappedEmailMessage.toRecipients = convertEmailListToArrayOfEmailAddressObjects(getHeaderValue(messageData, 'To'));\r\n        mappedEmailMessage.ccRecipients = convertEmailListToArrayOfEmailAddressObjects(getHeaderValue(messageData, 'Cc'));\r\n        mappedEmailMessage.bccRecipients = convertEmailListToArrayOfEmailAddressObjects(getHeaderValue(messageData, 'Bcc'));\r\n\r\n        delete mappedEmailMessage.messageData;\r\n        mappedUser.data.push(mappedEmailMessage);\r\n      }\r\n    }\r\n    mappedData.push(mappedUser);\r\n  }\r\n\r\n  return mappedData;\r\n};\r\n\r\nvar getEmailData = function(emails, filterStartDate, filterEndDate, additionalFields, clientId, serviceEmail, privateKey, apiVersion) {\r\n  var emailResults = [];\r\n  var emailResultPromises = [];\r\n  var emailIter = 0;\r\n  for (emailIter = 0; emailIter < emails.length; emailIter++) {\r\n    //initialize emailResults with the email object passed in\r\n    //and add filter dates\r\n    emailResults[emailIter] = _.assign({}, emails[emailIter], {\r\n      filterStartDate: filterStartDate,\r\n      filterEndDate: filterEndDate\r\n    });\r\n\r\n    emailResultPromises.push(getUserEmails(clientId, serviceEmail, emails[emailIter].emailAfterMapping, privateKey, apiVersion, filterStartDate, filterEndDate, additionalFields, emailResults[emailIter]));\r\n  }\r\n\r\n  return Promise.all(emailResultPromises)\r\n  .then(function() {\r\n    return emailResults;\r\n  });\r\n};\r\n\r\nGoogleAdapter.prototype.getBatchData = function(emails, filterStartDate, filterEndDate, additionalFields) {\r\n  var clientId = this._config.credentials.clientId;\r\n  var clientEmail = this._config.credentials.email;\r\n  var serviceEmail = this._config.credentials.serviceEmail;\r\n  var privateKey = this._config.credentials.certificate;\r\n  var apiVersion = this._config.options.apiVersion;\r\n\r\n  var dataAdapterRunStats = {\r\n    success: true,\r\n    runDate: moment().utc().toDate(),\r\n    filterStartDate: filterStartDate,\r\n    filterEndDate: filterEndDate,\r\n    emails: emails\r\n  };\r\n\r\n  //first try to get token for the admin - if that fails, then all will fail\r\n  return getAccessToken(clientId, serviceEmail, clientEmail, privateKey)\r\n  .then(function() {\r\n    return getEmailData(emails, filterStartDate, filterEndDate, additionalFields, clientId, serviceEmail, privateKey, apiVersion);\r\n  })\r\n  .then(function(emailData) {\r\n    return mapEmailData(emailData);\r\n  })\r\n  .then(function(mappedEmailData) {\r\n    dataAdapterRunStats.results = mappedEmailData;\r\n    return dataAdapterRunStats;\r\n  })\r\n  .catch(function(err) {\r\n    dataAdapterRunStats.success = false;\r\n    dataAdapterRunStats.errorMessage = err;\r\n    console.log('GoogleMail GetBatchData Error: ' + JSON.stringify(err));\r\n    return dataAdapterRunStats;\r\n  });\r\n};\r\n\r\nGoogleAdapter.prototype.runConnectionTest = function(connectionData) {\r\n  var _this = this;\r\n  _this._config = new GoogleMail.Configuration(connectionData.credentials);\r\n  var filterStartDate = moment().utc().startOf('day').add(-1, 'days').toDate();\r\n  var filterEndDate = moment().utc().startOf('day').toDate();\r\n  return _this.getBatchData([{emailAfterMapping: _this._config.credentials.email}], filterStartDate, filterEndDate, '')\r\n  .then(function(data) {\r\n    if (data.success && data.results[0]) {\r\n      //to see if it really worked, we need to pass in the first result\r\n      return data.results[0];\r\n    } else {\r\n      return data;\r\n    }\r\n  });\r\n};\r\n\r\nGoogleAdapter.prototype.runMessageTest = function(connectionData) {\r\n  var _this = this;\r\n  _this._config = new GoogleMail.Configuration(connectionData.credentials);\r\n  var filterStartDate = moment().utc().startOf('day').add(-1, 'days').toDate();\r\n  var filterEndDate = moment().utc().startOf('day').add(1, 'days').toDate();\r\n  return _this.getBatchData([_this._config.credentials.email], filterStartDate, filterEndDate, 'Subject,BodyPreview,Body')\r\n  .then(function(data) {\r\n    console.log('runMessageTest worked');\r\n    console.log(data.results[0]);\r\n  })\r\n  .catch(function(err) {\r\n    console.log('runMessageTest Error: ' + JSON.stringify(err));\r\n  });\r\n};\r\n"],"sourceRoot":"/source/"}